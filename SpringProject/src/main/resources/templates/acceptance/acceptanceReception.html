<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì˜ˆì•½ ì ‘ìˆ˜</title>
<link rel="stylesheet" href="/css/AcceptanceReceptionstyle.css">

<style>

</style>
</head>
<body>
<!-- ì‚¬ì´ë“œ ë°” -->
<div class = "sidebar">
	<div class = "profile">
		<div class = "profile-icon">ğŸ‘¤</div>
		<span>ë‚´ í”„ë¡œí•„</span>
	</div>
	
	<div class = "menu-item">
		<div class = "menu-icon">ğŸ””</div>
		<span>ì•Œë¦¼</span>
	</div>
	
	<a href="acceptanceHome" class = "menu-item">
		<div class = "menu-icon">ğŸ </div>
		<span>í™ˆ</span>
	</a>
	
	<div class="menu-item has-submenu" onclick="toggleSubMenu(this)">
		<div class = "menu-icon">ğŸ“‹</div>
		<span>ì§„ë£Œ</span>
	</div>
	<ul class="submenu">
	<a href="acceptanceDoctor">
   	 	<li class="submenu-item active">ì˜ì‚¬ ìŠ¤ì¼€ì¤„</li></a>
   	 <a href ="acceptanceCondition">
    	<li class="submenu-item">ì§„ë£Œ ìƒíƒœ</li></a>

	</ul>
	
	<div class="menu-item has-submenu" onclick="toggleSubMenu(this)">
		<div class = "menu-icon">ğŸ‘¥</div>
		<span>ì˜ˆì•½</span>
	</div>
	
	<div class = "menu-item">
		<div class = "menu-icon">âœï¸</div>
		<span>ìˆ˜ë‚©</span>
	</div>
	
	<div class = "menu-item">
		<div class = "menu-icon">ğŸ’œ</div>
		<span>ì¬ê³ </span>
	</div>
	
	<div class = "menu-item">
		<div class = "menu-icon">ğŸ‘¥</div>
		<span>ì…ì›</span>
	</div>
</div>

<div class="main-content">
  <div class="schedule-wrapper">
    <!-- Day/Week/Month íƒ­ -->
    <div class="tab-header">
      <button class="tab active" onclick="showTab('day')">Day</button>
      <button class="tab" onclick="showTab('week')">Week</button>
    </div>
    
	<div class="top-center-date">
	  <button onclick="changeDate(-1)" class="date-nav">&lt;</button>
	  <span class="date-icon">ğŸ“…</span>
	  <span id="currentDate">2025-05-29</span>
	  <button onclick="changeDate(1)" class="date-nav">&gt;</button>
	</div>
    <div class="top-right-btn">
      <button class="register-btn-fixed">ì˜ˆì•½ ë“±ë¡</button>
    </div>
    
	<div class="top-center-week" style="display: none; justify-content: center; align-items: center; gap: 8px; margin: 10px 0; font-size: 30px;">
	  <button onclick="changeDate(-7)" class="date-nav">&lt;</button>
	  <span class="date-icon">ğŸ“…</span>
	  <span id="weekDateRange">2025-06-02 ~ 2025-06-08</span>
	  <button onclick="changeDate(7)" class="date-nav">&gt;</button>
	</div>

    
<div id="calendarModal" class="modal" style="display: none;">
  <div class="modal-content" style="width: 300px; padding: 20px;">
    <h3 style="margin-bottom: 10px;">ë‚ ì§œ ì„ íƒ</h3>
    <input type="date" id="calendarDateInput" style="width: 100%; padding: 10px; font-size: 16px;" />
    <div style="margin-top: 20px; text-align: right;">
      <button onclick="closeCalendarModal()" style="padding: 8px 14px; background-color: #ccc;">ì·¨ì†Œ</button>
      <button onclick="applyCalendarDate()" style="padding: 8px 14px; background-color: #2196f3; color: white;">ì ìš©</button>
    </div>
  </div>
</div>

    <!-- Day View -->
    <div id="dayView" class="schedule-view active">
      <div class="schedule-table">
        <!-- ê¸°ì¡´ day ì‹œê°„í‘œ í…Œì´ë¸” ìœ ì§€ -->
        <div class="header-row">
          <div class="time-col-header"></div>
          <div class="header-col">ì§„ë£Œì‹¤1</div>
          <div class="header-col">ì§„ë£Œì‹¤2</div>
          <div class="header-col">ì§„ë£Œì‹¤3</div>
          <div class="header-col">ì§„ë£Œì‹¤4</div>
        </div>


    <!-- ë‚˜ë¨¸ì§€ ì‹œê°„ëŒ€ (ë¹ˆ ìƒíƒœë¡œ) -->
    <div class="schedule-row"><div class="time-col">09:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">09:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">10:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">10:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">11:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">11:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">11:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">12:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">12:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">13:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">13:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">14:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">14:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">15:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">15:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">16:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">16:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    <div class="schedule-row"><div class="time-col">17:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
  </div>
</div>

<!-- Month Picker Modal (Weekìš©) -->
<div id="monthPickerModal" class="modal" style="display: none;">
  <div class="modal-content" style="width: 300px; padding: 20px;">
    <h3>ì›” ì„ íƒ</h3>
    <label for="yearSelect">ë…„ë„</label>
    <input type="number" id="yearSelect" min="2000" max="2100" style="width: 100%; padding: 8px; margin-bottom: 10px;" />

    <label for="monthSelect">ì›”</label>
    <select id="monthSelect" style="width: 100%; padding: 8px;">
      <!-- optionì€ ì•„ë˜ scriptì—ì„œ ìë™ ìƒì„± -->
    </select>

    <div style="margin-top: 20px; text-align: right;">
      <button onclick="closeMonthPickerModal()" style="padding: 6px 12px;">ì·¨ì†Œ</button>
      <button onclick="applyMonthSelection()" style="padding: 6px 12px; background-color: #2196f3; color: white;">ì ìš©</button>
    </div>
  </div>
</div>


 <!-- Week View -->
    <div id="weekView" class="schedule-view">
      <div class="schedule-table">
        <div class="header-row">
          <div class="time-col-header"></div>
          <div class="header-col">ì›”</div>
          <div class="header-col">í™”</div>
          <div class="header-col">ìˆ˜</div>
          <div class="header-col">ëª©</div>
          <div class="header-col">ê¸ˆ</div>
        </div>
        <!-- ì‹œê°„ëŒ€ë³„ í–‰ ë°˜ë³µ -->
        <div class="schedule-row"><div class="time-col">09:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
        <div class="schedule-row"><div class="time-col">09:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
        <div class="schedule-row"><div class="time-col">10:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
        <div class="schedule-row"><div class="time-col">10:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
        <div class="schedule-row"><div class="time-col">11:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
    	<div class="schedule-row"><div class="time-col">11:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
	    <div class="schedule-row"><div class="time-col">12:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
	    <div class="schedule-row"><div class="time-col">12:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
	    <div class="schedule-row"><div class="time-col">13:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
	    <div class="schedule-row"><div class="time-col">13:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
	    <div class="schedule-row"><div class="time-col">14:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
	    <div class="schedule-row"><div class="time-col">14:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
	    <div class="schedule-row"><div class="time-col">15:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
	    <div class="schedule-row"><div class="time-col">15:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
	    <div class="schedule-row"><div class="time-col">16:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
	    <div class="schedule-row"><div class="time-col">16:30</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
	    <div class="schedule-row"><div class="time-col">17:00</div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>  
      </div>
    </div>


<div id="reservationModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h2>ì˜ˆì•½ ë“±ë¡</h2>
 	<form id="reservationForm" method="post" action="/acceptance/appointment">
     <label>ì´ë¦„</label>
		<input list="patientList" id="patientNameInput" name="name" required />
		<datalist id="patientList"></datalist>
      
      <label>ì„±ë³„</label>
		<select name="gender" required>
		  <option value="">ì„ íƒ</option>
		  <option value="ë‚¨">ë‚¨</option>
		  <option value="ì—¬">ì—¬</option>
		</select>

		<label>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label>
		<input type="text" name="rrn" placeholder="000000-0000000" required>

      <label>ì—°ë½ì²˜</label>
      <input type="tel" name="phone" placeholder="010-0000-0000" required>

      <label>ì˜ˆì•½ ì¼ì‹œ</label>
      <input type="datetime-local" name="date" required>

      <label>ì§„ë£Œì‹¤</label>
      <select name="room" required>
        <option value="">ì„ íƒ</option>
        <option value="ì§„ë£Œì‹¤1">ì§„ë£Œì‹¤1</option>
        <option value="ì§„ë£Œì‹¤2">ì§„ë£Œì‹¤2</option>
        <option value="ì§„ë£Œì‹¤3">ì§„ë£Œì‹¤3</option>
        <option value="ì§„ë£Œì‹¤4">ì§„ë£Œì‹¤4</option>
      </select>
      
      <label>ë³‘ëª…</label>
		<input type="text" name="disease" placeholder="ì˜ˆ: ê°ê¸°, ìœ„ì—¼ ë“±" required>
	
	<label for="doctorSelect">ë‹´ë‹¹ ì˜ì‚¬</label>
	<select id="doctorSelect" name="doctor" required>
	  <option value="">ì˜ì‚¬ ì„ íƒ</option>
	</select>

      <div class="modal-buttons">
        <button type="button" class="cancel-btn" onclick="closeModal()">ì·¨ì†Œ</button>
        <button type="submit" class="save-btn">ì €ì¥</button>
      </div>
    </form>
  </div>
</div>

<!-- ì˜ˆì•½ ìƒì„¸ ì¡°íšŒ/ìˆ˜ì •ìš© ëª¨ë‹¬ -->
<div id="reservationDetailModal" class="modal" style="display: none;">
<div class="modal-content" style="position: relative;">
    <h2>ì˜ˆì•½ ì •ë³´</h2>
    <button type="button" class="cancel-reservation-btn" onclick="cancelReservation()" 
      style="position: absolute; height: 30px; top: 32px; right: 30px; background: #f55; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 5px;">
      ì˜ˆì•½ ì·¨ì†Œ
    </button>
    <form id="editReservationForm">
      <label>ì´ë¦„</label>
      <input type="text" name="editName" required>

      <label>ì£¼ë¯¼ë²ˆí˜¸</label>
      <input type="text" name="editRRN" required>

      <label>ì—°ë½ì²˜</label>
      <input type="text" name="editPhone" required>

      <label>ì˜ˆì•½ ì¼ì‹œ</label>
      <input type="datetime-local" name="editDate" required>

      <label>ì§„ë£Œì‹¤</label>
      <select name="editDepartment" required>
        <option value="">ì„ íƒ</option>
        <option>ì§„ë£Œì‹¤1</option>
        <option>ì§„ë£Œì‹¤2</option>
        <option>ì§„ë£Œì‹¤3</option>
        <option>ì§„ë£Œì‹¤4</option>
      </select>

      <label>ë³‘ëª…</label>
      <input type="text" name="editDisease" required>
	  
	  <label>ì˜ˆì•½ ìƒí™©</label>
	  <select name="status" required>
		<option value="">ì„ íƒ</option>
		<option value="ëŒ€ê¸°">ëŒ€ê¸°</option>
		<option value="í™•ì •">í™•ì •</option>
	  </select>
	  
      <label>ë‹´ë‹¹ ì˜ì‚¬</label>
      <input type="text" name="editDoctor" required>

      <div class="modal-buttons">
        <button type="button" class="cancel-btn" onclick="closeDetailModal()">ë‹«ê¸°</button>
        <button type="submit" class="save-btn">ìˆ˜ì •</button>
      </div>
    </form>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 1) ì‚¬ì´ë“œë°” í† ê¸€
  function toggleSubMenu(menuItem) {
    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
    document.querySelectorAll('.submenu').forEach(s => s.style.display = 'none');
    if (!menuItem.classList.contains('active')) {
      menuItem.classList.add('active');
      const submenu = menuItem.nextElementSibling;
      if (submenu?.classList.contains('submenu')) submenu.style.display = 'block';
    }
  }
  document.querySelectorAll('.has-submenu').forEach(mi =>
    mi.addEventListener('click', () => toggleSubMenu(mi))
  );

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 2) ì˜ˆì•½ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
  document.querySelector('.register-btn-fixed')
          .addEventListener('click', () => {
    document.getElementById('reservationForm').reset();
    document.getElementById('reservationModal').style.display = 'flex';
  });
  function closeModal() {
    document.getElementById('reservationModal').style.display = 'none';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 3) ì‹ ê·œ ì˜ˆì•½ ì €ì¥
  document.getElementById('reservationForm')
          .addEventListener('submit', function(e) {
    e.preventDefault();
    // (1) ì‹œê°„Â·ì§„ë£Œì‹¤ ìœ íš¨ì„± ê²€ì¦
    const date = new Date(this.date.value);
    const hour = String(date.getHours()).padStart(2,'0');
    const minute = String(date.getMinutes()).padStart(2,'0');
    const timeStr = `${hour}:${minute}`;
    const department = this.room.value;
    const roomIndex = { 'ì§„ë£Œì‹¤1':1,'ì§„ë£Œì‹¤2':2,'ì§„ë£Œì‹¤3':3,'ì§„ë£Œì‹¤4':4 }[department];

    if (!roomIndex) {
      return alert('ì§„ë£Œì‹¤ì„ ì •í™•íˆ ì„ íƒí•´ì£¼ì„¸ìš”.');
    }
    const rows = document.querySelectorAll('.schedule-row');
    let targetCell = null;
    for (const row of rows) {
      if (row.querySelector('.time-col').textContent.trim() === timeStr) {
        const cell = row.querySelectorAll('.cell')[roomIndex-1];
        if (cell.innerHTML.trim() !== '') {
          return alert("í•´ë‹¹ ì‹œê°„ëŒ€ì— ì´ë¯¸ ì˜ˆì•½ì´ ì¡´ì¬í•©ë‹ˆë‹¤.");
        }
        targetCell = cell;
        break;
      }
    }
    if (!targetCell) {
      return alert("ì…ë ¥í•œ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ì…€ì´ ì—†ìŠµë‹ˆë‹¤.");
    }

    // (2) ì„œë²„ ì „ì†¡
    const payload = {
      name:   this.name.value,
      rrn:    this.rrn.value,
      phone:  this.phone.value,
      gender: this.gender.value,
      date:   this.date.value,
      room:   department,
      disease:this.disease.value,
      doctor: this.doctor.value
    };
    fetch("/acceptance/appointment", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    })
    .then(r => r.text().then(msg => { if(!r.ok) throw new Error(msg); return msg; }))
    .then(msg => {
      // (3) í™”ë©´ ë°˜ì˜
      targetCell.classList.add('green');
      targetCell.innerHTML = `[${payload.name}]<br>${payload.rrn}`;
      Object.entries(payload).forEach(([k,v]) => targetCell.dataset[k] = v);
      alert(msg);
      closeModal();
    })
    .catch(err => alert("ì˜ˆì•½ ì‹¤íŒ¨: " + err.message));
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 4) ì˜ˆì•½ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
  let selectedCell = null;
  function openReservationDetailModal(cell) {
    selectedCell = cell;
    const deptSelect = document.querySelector('select[name="editDepartment"]');
    deptSelect.value = cell.dataset.department || '';
    ['Name','RRN','Phone','Date','Department','Disease','Doctor','Status']
      .forEach(field => {
        const inp = document.querySelector(`[name="edit${field}"]`);
        if (inp) inp.value = cell.dataset[field.toLowerCase()] || '';
      });
    document.getElementById('reservationDetailModal').style.display = 'flex';
  }
  document.querySelector('.schedule-table')
          .addEventListener('click', function(e) {
    if (e.target.classList.contains('green')) {
      openReservationDetailModal(e.target);
    }
  });
  function closeDetailModal() {
    document.getElementById('reservationDetailModal').style.display = 'none';
  }
  window.closeDetailModal = closeDetailModal;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 5) ì˜ˆì•½ ìˆ˜ì •
  document.getElementById('editReservationForm')
          .addEventListener('submit', function(e) {
    e.preventDefault();
    if (!selectedCell) return;

    // (1) ìˆ˜ì • ë°ì´í„° ì½ê¸°
    const newName       = this.editName.value;
    const newRRN        = this.editRRN.value;
    const newPhone      = this.editPhone.value;
    const newDate       = this.editDate.value;
    const newDepartment = this.editDepartment.value;
    const newDisease    = this.editDisease.value;
    const newDoctor     = this.editDoctor.value;
    const newStatus     = this.status.value;

    const updatePayload = {
      name: newName,
      rrn: newRRN,
      phone: newPhone,
      gender: selectedCell.dataset.gender || '',
      date: newDate,
      originalDate: selectedCell.dataset.date,
      room: newDepartment,
      disease: newDisease,
      doctor: newDoctor,
      status: newStatus
    };

    // (2) ì„œë²„ ì „ì†¡
    fetch("/acceptance/appointment", {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(updatePayload)
    })
    .then(r => r.text().then(msg => { if(!r.ok) throw new Error(msg); return msg; }))
    .then(msg => {
      alert(msg);
      // ê¸°ì¡´ ì…€ ì´ˆê¸°í™”
      selectedCell.classList.remove('green','waiting','confirmed');
      selectedCell.innerHTML = '';
      Object.keys(selectedCell.dataset).forEach(k=>delete selectedCell.dataset[k]);

      // ìƒˆ ì…€ ê³„ì‚° ë° ê·¸ë¦¬ê¸°
      const dt = new Date(newDate);
      const tStr = `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
      let newCell = null;
      document.querySelectorAll('.schedule-row').forEach(row => {
        if (row.querySelector('.time-col').textContent.trim() === tStr) {
          newCell = row.querySelectorAll('.cell')[{
            'ì§„ë£Œì‹¤1':0,'ì§„ë£Œì‹¤2':1,'ì§„ë£Œì‹¤3':2,'ì§„ë£Œì‹¤4':3
          }[newDepartment]];
        }
      });
      if (newCell) {
        newCell.classList.add('green');
        newCell.innerHTML = `[${newName}]<br>${newRRN}`;
        Object.entries(updatePayload).forEach(([k,v]) => newCell.dataset[k] = v);
        newCell.classList.add(newStatus==='í™•ì •'?'confirmed':'waiting');
        newCell.addEventListener('click', ()=>openReservationDetailModal(newCell));
      }
      closeDetailModal();
    })
    .catch(err => alert("ìˆ˜ì • ì‹¤íŒ¨: " + err.message));
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 6) ì˜ˆì•½ ì·¨ì†Œ
  window.cancelReservation = function() {
    if (!selectedCell || !confirm("ì •ë§ë¡œ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    fetch("/acceptance/appointment", {
      method: "DELETE",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        date: selectedCell.dataset.date,
        rrn:  selectedCell.dataset.rrn
      })
    })
    .then(r => r.text().then(msg=>{ if(!r.ok) throw new Error(msg); return msg; }))
    .then(msg => {
      alert(msg);
      selectedCell.classList.remove('green','waiting','confirmed');
      selectedCell.innerHTML = '';
      selectedCell = null;
      closeDetailModal();
    })
    .catch(err => alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message));
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 7) ë‚ ì§œ/ë·° ì œì–´ ë¡œì§

  // Day/Week íƒ­
  function showTab(view) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.schedule-view').forEach(v=>v.classList.remove('active'));
    if (view==='day') {
      document.querySelector('button[onclick*="day"]').classList.add('active');
      document.getElementById('dayView').classList.add('active');
      document.querySelector('.top-center-date').style.display = 'flex';
      document.querySelector('.top-center-week').style.display = 'none';
      document.querySelector('.register-btn-fixed').style.display = 'inline-block';
    } else {
      document.querySelector('button[onclick*="week"]').classList.add('active');
      document.getElementById('weekView').classList.add('active');
      document.querySelector('.top-center-date').style.display = 'none';
      document.querySelector('.top-center-week').style.display = 'flex';
      document.querySelector('.register-btn-fixed').style.display = 'none';
      updateWeekDisplay();
    }
  }
  document.querySelectorAll('.tab').forEach(tab =>
    tab.addEventListener('click', ()=>showTab(tab.textContent.toLowerCase()))
  );

  // ë‚ ì§œ ì´ë™
  let currentDateObj = new Date();
  function updateDateDisplay() {
	  document.getElementById('currentDate').textContent =
		  formatLocalDate(currentDateObj);
  }
  function changeDate(days) {
    currentDateObj.setDate(currentDateObj.getDate() + days);
    updateDateDisplay();
    if (document.getElementById('weekView').classList.contains('active')) {
      updateWeekDisplay();
    } else {
      loadAppointmentsByDate(formatLocalDate(currentDateObj));
    }
  }
  window.changeDate = changeDate; // ì¸ë¼ì¸ onclick ìš©

  // ìº˜ë¦°ë” ì•„ì´ì½˜
  document.querySelectorAll('.date-icon').forEach(icon=>{
    icon.addEventListener('click', ()=>{
      const modal = document.getElementById(
        document.getElementById('weekView').classList.contains('active')
          ? 'monthPickerModal' : 'calendarModal'
      );
      modal.style.display='flex';
    });
  });
  function closeCalendarModal() { document.getElementById('calendarModal').style.display='none'; }
  function closeMonthPickerModal(){ document.getElementById('monthPickerModal').style.display='none'; }

  // loadAppointmentsByDate ì •ì˜
  function loadAppointmentsByDate(dateString) {
    document.querySelectorAll('.cell').forEach(c=>{
      c.classList.remove('green');
      c.innerHTML=''; Object.keys(c.dataset).forEach(k=>delete c.dataset[k]);
    });
    fetch(`/acceptance/appointments?date=${dateString}`)
      .then(r=>r.ok? r.json() : Promise.reject(r.status))
      .then(list=>{
        list.forEach(appt=>{
          const dt = new Date(appt.date);
          const t = `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
          const roomIndex = {'ì§„ë£Œì‹¤1':1,'ì§„ë£Œì‹¤2':2,'ì§„ë£Œì‹¤3':3,'ì§„ë£Œì‹¤4':4}[appt.room];
          if (!roomIndex) return;
          document.querySelectorAll('.schedule-row').forEach(row=>{
            if (row.querySelector('.time-col').textContent.trim()===t) {
              const cell = row.querySelectorAll('.cell')[roomIndex-1];
              cell.classList.add('green');
              cell.innerHTML = `[${appt.name}]<br>${appt.rrn}`;
              ['name','rrn','phone','date','department','disease','doctor','status']
                .forEach(k=>cell.dataset[k]=appt[k]);
            }
          });
        });
      })
      .catch(err=>console.error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨",err));
  }

  // updateWeekDisplay & loadAppointmentsForWeek ì •ì˜
  function updateWeekDisplay() {
    const cur = new Date(currentDateObj);
    const dow = (cur.getDay()+6)%7; // ì›”=0
    const monday = new Date(cur); monday.setDate(cur.getDate()-dow);
    const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
    document.getElementById('weekDateRange').textContent =
    	`${formatLocalDate(monday)} ~ ${formatLocalDate(sunday)}`;
    const dates = Array.from({length:5},(_,i)=>{
    	const d = new Date(monday);
    	d.setDate(monday.getDate()+i);
    	return formatLocalDate(d);
    });
    loadAppointmentsForWeek(dates);
  }

  function loadAppointmentsForWeek(dateList) {
	  dateList.forEach(dateStr => {
		fetch(`/acceptance/appointments?date=${dateStr}`)
		.then(r => r.ok ? r.json() : Promise.reject(r.status))
		.then(list => {
		          /* â€¦ ì…€ ì±„ìš°ê¸° ë¡œì§ â€¦ */
		})
		.catch(() => {});
	});
  }
  // ì´ˆê¸° ë¡œë“œ
  updateDateDisplay();
  loadAppointmentsByDate(formatLocalDate(new Date()));
  
});
  
	function formatLocalDate(date) {
	  const yyyy = date.getFullYear();
	  const mm   = String(date.getMonth()+1).padStart(2,'0');
	  const dd   = String(date.getDate()).padStart(2,'0');
	  return `${yyyy}-${mm}-${dd}`;
	}

</script>
</body>
</html>