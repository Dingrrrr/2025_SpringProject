<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>환자 진료 기록 관리</title>
      <link rel="stylesheet" href="/css/AcceptanceReceipt.css">
</head>
<body>
    <!-- 사이드 바 -->
<div class = "sidebar">
	<div class = "profile">
		<div class = "profile-icon">👤</div>
		<span th:text="${userName}">수납 이름</span>
	</div>
	
	<div class = "menu-item">

	<a href = "/acceptance/acceptanceHome">
	<div class = "menu-item">
		<div class = "menu-icon">🏠</div>
		<span>홈</span>
	</div>
	</a>
	
	<div class="menu-item has-submenu" onclick="toggleSubMenu(this)">
		<div class = "menu-icon">📋</div>
		<span>진료</span>
	</div>
	
	<ul class="submenu">
	<a href="/acceptance/acceptanceDoctor">
   	 	<li class="submenu-item active">의사 스케줄</li></a>
   	 <a href ="/acceptance/acceptanceCondition">
    	<li class="submenu-item">진료 상태</li></a>
	</ul>
	
	
	<a href="/acceptance/acceptanceReception" class="menu-item">
	  <div class="menu-icon">👥</div>
	  <span>예약</span>
	</a>
	
	<div class = "menu-item">
		<div class = "menu-icon">✏️</div>
		<span>수납</span>
	</div>
	
	<a href = "/Drug/Drug">
	<div class = "menu-item">
		<div class = "menu-icon">💜</div>
		<span>재고</span>
		
	</div>
	</a>
	
	<div class="menu-item has-submenu" onclick="toggleSubMenu(this)">
  <div class="menu-icon">🛌</div>
  <span>입원</span>
</div>

<ul class="submenu">
  <a href="/Inpatient/Inpatient">
    <li class="submenu-item">입원 관리</li>
  </a>
  <a href="/Inpatient/InpatientStatistics">
    <li class="submenu-item">입원 통계</li>
  </a>
</ul>

<a th:href="@{/Login/Logout}" class="menu-item logout">
    		<div class="menu-icon">🚪</div>
    		<span>로그아웃</span>
		</a>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="main-content">
        <!-- 좌측 환자 정보 패널 -->
        <div class="patient-panel">
            <div class="patient-header">
                고객정보
                <button class="edit-patient-btn" onclick="togglePatientEdit()">수정</button>
            </div>
            
            <div class="patient-info">
                <div class="info-row">
                    <div class="info-label">고객명:</div>
                    <div class="info-value">
                        <span class="display-text">김건우</span>
                        <input type="text" class="edit-input" value="김건우" style="display:none;">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">고객번호:</div>
                    <div class="info-value">
                        <span class="display-text">2023001</span>
                        <input type="text" class="edit-input" value="2023001" style="display:none;">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">주민번호:</div>
                    <div class="info-value">
                        <span class="display-text">830815-1****</span>
                        <input type="text" class="edit-input" value="830815-1****" style="display:none;">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">생년월일:</div>
                    <div class="info-value">
                        <span class="display-text">1983-08-15</span>
                        <input type="date" class="edit-input" value="1983-08-15" style="display:none;">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">연령:</div>
                    <div class="info-value">
                        <span class="display-text">40세</span>
                        <input type="text" class="edit-input" value="40세" style="display:none;">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">성별:</div>
                    <div class="info-value">
                        <span class="display-text">남</span>
                        <select class="edit-input" style="display:none;">
                            <option value="남" selected>남</option>
                            <option value="여">여</option>
                        </select>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">연락처:</div>
                    <div class="info-value">
                        <span class="display-text">010-1234-5678</span>
                        <input type="tel" class="edit-input" value="010-1234-5678" style="display:none;">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">주소:</div>
                    <div class="info-value">
                        <span class="display-text">서울시 강남구</span>
                        <input type="text" class="edit-input" value="서울시 강남구" style="display:none;">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">보험유형:</div>
                    <div class="info-value">
                        <span class="display-text">건강보험</span>
                        <select class="edit-input" style="display:none;">
                            <option value="건강보험" selected>건강보험</option>
                            <option value="의료급여">의료급여</option>
                            <option value="산재보험">산재보험</option>
                        </select>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">최종방문:</div>
                    <div class="info-value">
                        <span class="display-text">2023-08-18</span>
                        <input type="date" class="edit-input" value="2023-08-18" style="display:none;">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">총방문:</div>
                    <div class="info-value">
                        <span class="display-text">15회</span>
                        <input type="number" class="edit-input" value="15" min="0" style="display:none;">
                    </div>
                </div>
                
                <div class="patient-edit-buttons" style="display:none; margin-top: 15px;">
                    <button class="save-patient-btn" onclick="savePatientInfo()">저장</button>
                    <button class="cancel-patient-btn" onclick="cancelPatientEdit()">취소</button>
                </div>
            </div>

            <div class="patient-notes">
                <div class="notes-title">
                    메모/특이사항
                    <button class="edit-notes-btn" onclick="toggleNotesEdit()">수정</button>
                </div>
                <div class="notes-content">
                    <div class="notes-display">
                        - 고혈압 병력 있음<br>
                        - 당뇨 가족력<br>
                        - 정기검진 필요<br>
                        - 약물 알레르기: 페니실린<br>
                        - 흡연력: 금연 2년차<br>
                        - 운동: 주 3회 헬스<br>
                        - 기타: 야간 근무로 인한 수면 패턴 불규칙
                    </div>
                    <textarea class="notes-edit" style="display:none; width:100%; height:150px; padding:10px; border:1px solid #ddd; border-radius:4px; resize:vertical;">- 고혈압 병력 있음
- 당뇨 가족력
- 정기검진 필요
- 약물 알레르기: 페니실린
- 흡연력: 금연 2년차
- 운동: 주 3회 헬스
- 기타: 야간 근무로 인한 수면 패턴 불규칙</textarea>
                </div>
                
                <div class="notes-edit-buttons" style="display:none; margin-top: 10px;">
                    <button class="save-notes-btn" onclick="saveNotes()">저장</button>
                    <button class="cancel-notes-btn" onclick="cancelNotesEdit()">취소</button>
                </div>
            </div>
        </div>

        <!-- 우측 기록 테이블 -->
        <div class="records-panel">
            <div class="records-header">
                <div class="records-title">진료 기록 및 수납 내역</div>
                <div class="header-buttons">
                    <button class="header-btn add-record-btn" onclick="showAddRecordModal()">추가</button>
                </div>
            </div>

            <div class="table-container">
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>구분</th>
                            <th>진료내용</th>
                            <th>담당의</th>
                            <th>진료비</th>
                            <th>보험청구</th>
                            <th>환자부담</th>
                            <th>수납액</th>
                            <th>미수납액</th>
                            <th>상태</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="date-cell" data-field="date">2023-08-17</td>
                            <td data-field="type">초진</td>
                            <td class="diagnosis-cell" data-field="diagnosis">고혈압 정기검진 및 처방</td>
                            <td data-field="doctor">김의사</td>
                            <td class="amount-cell" data-field="total">30,000</td>
                            <td class="amount-cell" data-field="insurance">21,000</td>
                            <td class="amount-cell" data-field="patient">9,000</td>
                            <td class="amount-cell" data-field="paid">9,000</td>
                            <td class="amount-cell" data-field="unpaid">0</td>
                            <td class="status-cell status-완료" data-field="status">완료</td>
                            <td class="action-cell">
                                <button class="edit-btn" onclick="editRow(this)">수정</button>
                                <button class="save-btn" onclick="saveRow(this)" style="display:none;">저장</button>
                                <button class="cancel-btn" onclick="cancelEdit(this)" style="display:none;">취소</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="date-cell" data-field="date">2023-08-10</td>
                            <td data-field="type">재진</td>
                            <td class="diagnosis-cell" data-field="diagnosis">당뇨 검사 및 상담</td>
                            <td data-field="doctor">이의사</td>
                            <td class="amount-cell" data-field="total">25,000</td>
                            <td class="amount-cell" data-field="insurance">17,500</td>
                            <td class="amount-cell" data-field="patient">7,500</td>
                            <td class="amount-cell" data-field="paid">7,500</td>
                            <td class="amount-cell" data-field="unpaid">0</td>
                            <td class="status-cell status-완료" data-field="status">완료</td>
                            <td class="action-cell">
                                <button class="edit-btn" onclick="editRow(this)">수정</button>
                                <button class="save-btn" onclick="saveRow(this)" style="display:none;">저장</button>
                                <button class="cancel-btn" onclick="cancelEdit(this)" style="display:none;">취소</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="date-cell" data-field="date">2023-08-10</td>
                            <td data-field="type">재진</td>
                            <td class="diagnosis-cell" data-field="diagnosis">혈압약 처방 및 모니터링</td>
                            <td data-field="doctor">김의사</td>
                            <td class="amount-cell" data-field="total">200,000</td>
                            <td class="amount-cell" data-field="insurance">140,000</td>
                            <td class="amount-cell" data-field="patient">60,000</td>
                            <td class="amount-cell" data-field="paid">30,000</td>
                            <td class="amount-cell" data-field="unpaid">30,000</td>
                            <td class="status-cell status-대기" data-field="status">미수납</td>
                            <td class="action-cell">
                                <button class="edit-btn" onclick="editRow(this)">수정</button>
                                <button class="save-btn" onclick="saveRow(this)" style="display:none;">저장</button>
                                <button class="cancel-btn" onclick="cancelEdit(this)" style="display:none;">취소</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="date-cell" data-field="date">2023-08-10</td>
                            <td data-field="type">초진</td>
                            <td class="diagnosis-cell" data-field="diagnosis">종합건강검진 1차</td>
                            <td data-field="doctor">박의사</td>
                            <td class="amount-cell" data-field="total">70,000</td>
                            <td class="amount-cell" data-field="insurance">49,000</td>
                            <td class="amount-cell" data-field="patient">21,000</td>
                            <td class="amount-cell" data-field="paid">21,000</td>
                            <td class="amount-cell" data-field="unpaid">0</td>
                            <td class="status-cell status-완료" data-field="status">완료</td>
                            <td class="action-cell">
                                <button class="edit-btn" onclick="editRow(this)">수정</button>
                                <button class="save-btn" onclick="saveRow(this)" style="display:none;">저장</button>
                                <button class="cancel-btn" onclick="cancelEdit(this)" style="display:none;">취소</button>
                            </td>
                        </tr>
                        <tr class="highlighted-row">
                            <td class="date-cell" data-field="date">2023-08-10</td>
                            <td data-field="type">검사</td>
                            <td class="diagnosis-cell" data-field="diagnosis">혈액검사 및 소변검사 1차</td>
                            <td data-field="doctor">최의사</td>
                            <td class="amount-cell" data-field="total">70,000</td>
                            <td class="amount-cell" data-field="insurance">49,000</td>
                            <td class="amount-cell" data-field="patient">21,000</td>
                            <td class="amount-cell" data-field="paid">21,000</td>
                            <td class="amount-cell" data-field="unpaid">0</td>
                            <td class="status-cell status-완료" data-field="status">완료</td>
                            <td class="action-cell">
                                <button class="edit-btn" onclick="editRow(this)">수정</button>
                                <button class="save-btn" onclick="saveRow(this)" style="display:none;">저장</button>
                                <button class="cancel-btn" onclick="cancelEdit(this)" style="display:none;">취소</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="date-cell">2023-07-25</td>
                            <td>미용</td>
                            <td class="diagnosis-cell">피부관리 및 미용시술</td>
                            <td>정의사</td>
                            <td class="amount-cell">수술비용</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">수술비용</td>
                            <td class="amount-cell">수술비용</td>
                            <td class="amount-cell">0</td>
                            <td class="status-cell status-완료">완료</td>
                            <td class="action-cell">
                                <button class="edit-btn" onclick="editRow(this)">수정</button>
                                <button class="save-btn" onclick="saveRow(this)" style="display:none;">저장</button>
                                <button class="cancel-btn" onclick="cancelEdit(this)" style="display:none;">취소</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="date-cell">2023-07-24</td>
                            <td>초진</td>
                            <td class="diagnosis-cell">초진</td>
                            <td>김의사</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="status-cell status-대기">완료</td>
                            <td class="action-cell">
                                <button class="edit-btn" onclick="editRow(this)">수정</button>
                                <button class="save-btn" onclick="saveRow(this)" style="display:none;">저장</button>
                                <button class="cancel-btn" onclick="cancelEdit(this)" style="display:none;">취소</button>
                            </td>
                        </tr>
                        <tr class="highlighted-row">
                            <td class="date-cell">2023-07-24</td>
                            <td>재진</td>
                            <td class="diagnosis-cell">아픔</td>
                            <td>-</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="status-cell status-취소">완료</td>
                            <td class="action-cell">
                                <button class="edit-btn" onclick="editRow(this)">수정</button>
                                <button class="save-btn" onclick="saveRow(this)" style="display:none;">저장</button>
                                <button class="cancel-btn" onclick="cancelEdit(this)" style="display:none;">취소</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="date-cell">2023-07-19</td>
                            <td>초진</td>
                            <td class="diagnosis-cell">보험/치과</td>
                            <td>이의사</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="amount-cell">-</td>
                            <td class="status-cell status-대기">완료</td>
                            <td class="action-cell">
                                <button class="edit-btn" onclick="editRow(this)">수정</button>
                                <button class="save-btn" onclick="saveRow(this)" style="display:none;">저장</button>
                                <button class="cancel-btn" onclick="cancelEdit(this)" style="display:none;">취소</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="stats-panel">
                <div class="stats-group">
                    <div class="stat-item">
                        <span class="stat-label">총진료비:</span>
                        <span class="stat-value">1,567,472</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">보험청구:</span>
                        <span class="stat-value">1,097,230</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">환자부담:</span>
                        <span class="stat-value">470,242</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">수납완료:</span>
                        <span class="stat-value">440,242</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">미수납:</span>
                        <span class="stat-value" style="color: #dc3545;">30,000</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 기록 추가 모달 -->
    <div id="addRecordModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>새 진료 기록 추가</h3>
                <span class="close" onclick="closeAddRecordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addRecordForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>날짜</label>
                            <input type="date" id="recordDate" required>
                        </div>
                        <div class="form-group">
                            <label>구분</label>
                            <select id="recordType" required>
                                <option value="">선택하세요</option>
                                <option value="초진">초진</option>
                                <option value="재진">재진</option>
                                <option value="검사">검사</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>진료내용</label>
                            <input type="text" id="recordContent" placeholder="진료 내용을 입력하세요" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>담당의</label>
                            <select id="recordDoctor" required>
                                <option value="">선택하세요</option>
                                <option value="김의사">김의사</option>
                                <option value="이의사">이의사</option>
                                <option value="박의사">박의사</option>
                                <option value="최의사">최의사</option>
                                <option value="정의사">정의사</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>상태</label>
                            <select id="recordStatus" required>
                                <option value="">선택하세요</option>
                                <option value="완료">완료</option>
                                <option value="미수납">미수납</option>                               
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>진료비</label>
                            <input type="number" id="recordFee" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label>보험청구</label>
                            <input type="number" id="recordInsurance" placeholder="0" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>환자부담</label>
                            <input type="number" id="recordPatientPay" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label>수납액</label>
                            <input type="number" id="recordPaid" placeholder="0" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>미수납액</label>
                            <input type="number" id="recordUnpaid" placeholder="0" min="0">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeAddRecordModal()">취소</button>
                <button type="button" class="btn-save" onclick="addNewRecord()">저장</button>
            </div>
        </div>
    </div>

   <script>
// 메뉴 클릭 이벤트
document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', function(e) {
        if (this.getAttribute('href') === '#') {
            e.preventDefault();
        }
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
    });
}); // 이 부분이 누락되어 있었음!

// 기록 추가 함수 (모달 대신 직접 테이블에 추가)
function showAddRecordModal() {
    const tableBody = document.querySelector('.records-table tbody');
    const newRow = document.createElement('tr');
    
    const today = new Date().toISOString().split('T')[0];
    
    newRow.innerHTML = `
        <td class="date-cell edit-input-cell">
            <input type="date" value="${today}" />
        </td>
        <td class="edit-input-cell">
            <select class="form-control">
                <option value="">선택하세요</option>
                <option value="초진">초진</option>
                <option value="재진">재진</option>
                <option value="검사">검사</option>               
            </select>
        </td>
        <td class="edit-input-cell">
            <input type="text" placeholder="진료 내용을 입력하세요" />
        </td>
        <td class="edit-input-cell">
            <select class="form-control">
                <option value="">선택하세요</option>
                <option value="김의사">김의사</option>
                <option value="이의사">이의사</option>
                <option value="박의사">박의사</option>
                <option value="최의사">최의사</option>
                <option value="정의사">정의사</option>
            </select>
        </td>
        <td class="edit-input-cell">
            <input type="number" placeholder="0" min="0" />
        </td>
        <td class="edit-input-cell">
            <input type="number" placeholder="0" min="0" />
        </td>
        <td class="edit-input-cell">
            <input type="number" placeholder="0" min="0" />
        </td>
        <td class="edit-input-cell">
            <input type="number" placeholder="0" min="0" />
        </td>
        <td class="edit-input-cell">
            <input type="number" placeholder="0" min="0" />
        </td>
        <td class="edit-input-cell">
            <select class="form-control">
                <option value="">선택하세요</option>
                <option value="완료">완료</option>
                <option value="미수납">미수납</option>
            </select>
        </td>
        <td class="action-cell">
            <button class="save-btn" onclick="saveNewRow(this)">저장</button>
            <button class="cancel-btn" onclick="cancelNewRow(this)">취소</button>
        </td>
    `;
    
    tableBody.insertBefore(newRow, tableBody.firstChild);
    newRow.querySelector('select').focus();
}

function saveNewRow(button) {
    const row = button.closest('tr');
    
    const dateInput = row.querySelector('td:nth-child(1) input');
    const typeSelect = row.querySelector('td:nth-child(2) select');
    const contentInput = row.querySelector('td:nth-child(3) input');
    const doctorSelect = row.querySelector('td:nth-child(4) select');
    const feeInput = row.querySelector('td:nth-child(5) input');
    const insuranceInput = row.querySelector('td:nth-child(6) input');
    const patientInput = row.querySelector('td:nth-child(7) input');
    const paidInput = row.querySelector('td:nth-child(8) input');
    const unpaidInput = row.querySelector('td:nth-child(9) input');
    const statusSelect = row.querySelector('td:nth-child(10) select');
    
    if (!dateInput.value || !typeSelect.value || !contentInput.value.trim() || 
        !doctorSelect.value || !statusSelect.value) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }
    
    let statusClass = 'status-cell ';
    switch(statusSelect.value) {
        case '완료': statusClass += 'status-완료'; break;
        case '미수납': statusClass += 'status-대기'; break;
        case '취소': statusClass += 'status-취소'; break;
        default: statusClass += 'status-대기';
    }
    
    row.innerHTML = `
        <td class="date-cell">${dateInput.value}</td>
        <td>${typeSelect.value}</td>
        <td class="diagnosis-cell">${contentInput.value}</td>
        <td>${doctorSelect.value}</td>
        <td class="amount-cell">${feeInput.value || '-'}</td>
        <td class="amount-cell">${insuranceInput.value || '-'}</td>
        <td class="amount-cell">${patientInput.value || '-'}</td>
        <td class="amount-cell">${paidInput.value || '-'}</td>
        <td class="amount-cell">${unpaidInput.value || '-'}</td>
        <td class="${statusClass}">${statusSelect.value}</td>
        <td class="action-cell">
            <button class="edit-btn" onclick="editRow(this)">수정</button>
            <button class="save-btn" onclick="saveRow(this)" style="display:none;">저장</button>
            <button class="cancel-btn" onclick="cancelEdit(this)" style="display:none;">취소</button>
        </td>
    `;
    
    alert('새 진료 기록이 추가되었습니다.');
}

function cancelNewRow(button) {
    const row = button.closest('tr');
    row.remove();
}

// 서브메뉴 클릭 이벤트
document.querySelectorAll('.submenu-item').forEach(item => {
    item.addEventListener('click', function() {
        document.querySelectorAll('.submenu-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
    });
});

// 헤더 버튼 클릭 이벤트
document.querySelectorAll('.header-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.header-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const filterType = this.textContent.trim();
        console.log('필터 적용:', filterType);
    });
});

// 테이블 행 클릭 이벤트
document.querySelectorAll('.records-table tbody tr').forEach(row => {
    row.addEventListener('click', function() {
        document.querySelectorAll('.records-table tbody tr').forEach(r => {
            if (!r.classList.contains('highlighted-row')) {
                r.style.backgroundColor = '';
            }
        });
        if (!this.classList.contains('highlighted-row')) {
            this.style.backgroundColor = '#e3f2fd';
        }
    });
});

// 고객 정보 수정 기능
let isPatientEditing = false;
let originalPatientData = {};

function togglePatientEdit() {
    const editBtn = document.querySelector('.edit-patient-btn');
    const displayTexts = document.querySelectorAll('.patient-info .display-text');
    const editInputs = document.querySelectorAll('.patient-info .edit-input');
    const editButtons = document.querySelector('.patient-edit-buttons');

    if (!isPatientEditing) {
        isPatientEditing = true;
        editBtn.textContent = '수정중...';
        editBtn.disabled = true;
        
        displayTexts.forEach((text, index) => {
            originalPatientData[index] = text.textContent;
        });

        displayTexts.forEach(text => text.style.display = 'none');
        editInputs.forEach(input => input.style.display = 'block');
        editButtons.style.display = 'block';
    }
}

function savePatientInfo() {
    const displayTexts = document.querySelectorAll('.patient-info .display-text');
    const editInputs = document.querySelectorAll('.patient-info .edit-input');
    const editButtons = document.querySelector('.patient-edit-buttons');
    const editBtn = document.querySelector('.edit-patient-btn');

    editInputs.forEach((input, index) => {
        if (displayTexts[index]) {
            if (input.tagName === 'SELECT') {
                displayTexts[index].textContent = input.options[input.selectedIndex].text;
            } else if (input.type === 'number') {
                displayTexts[index].textContent = input.value + '회';
            } else {
                displayTexts[index].textContent = input.value;
            }
        }
    });

    displayTexts.forEach(text => text.style.display = 'block');
    editInputs.forEach(input => input.style.display = 'none');
    editButtons.style.display = 'none';
    
    editBtn.textContent = '수정';
    editBtn.disabled = false;
    isPatientEditing = false;

    alert('고객 정보가 저장되었습니다.');
}

function cancelPatientEdit() {
    const displayTexts = document.querySelectorAll('.patient-info .display-text');
    const editInputs = document.querySelectorAll('.patient-info .edit-input');
    const editButtons = document.querySelector('.patient-edit-buttons');
    const editBtn = document.querySelector('.edit-patient-btn');

    editInputs.forEach((input, index) => {
        if (originalPatientData[index]) {
            if (input.tagName === 'SELECT') {
                input.value = originalPatientData[index];
            } else if (input.type === 'number') {
                input.value = originalPatientData[index].replace('회', '');
            } else {
                input.value = originalPatientData[index];
            }
        }
    });

    displayTexts.forEach(text => text.style.display = 'block');
    editInputs.forEach(input => input.style.display = 'none');
    editButtons.style.display = 'none';
    
    editBtn.textContent = '수정';
    editBtn.disabled = false;
    isPatientEditing = false;
}

// 메모 수정 기능
let isNotesEditing = false;
let originalNotesData = '';

function toggleNotesEdit() {
    const editBtn = document.querySelector('.edit-notes-btn');
    const notesDisplay = document.querySelector('.notes-display');
    const notesEdit = document.querySelector('.notes-edit');
    const editButtons = document.querySelector('.notes-edit-buttons');

    if (!isNotesEditing) {
        isNotesEditing = true;
        editBtn.textContent = '수정중...';
        editBtn.disabled = true;
        
        originalNotesData = notesDisplay.innerHTML;

        notesDisplay.style.display = 'none';
        notesEdit.style.display = 'block';
        editButtons.style.display = 'block';
    }
}

function saveNotes() {
    const editBtn = document.querySelector('.edit-notes-btn');
    const notesDisplay = document.querySelector('.notes-display');
    const notesEdit = document.querySelector('.notes-edit');
    const editButtons = document.querySelector('.notes-edit-buttons');

    const newContent = notesEdit.value.replace(/\n/g, '<br>');
    notesDisplay.innerHTML = newContent;

    notesDisplay.style.display = 'block';
    notesEdit.style.display = 'none';
    editButtons.style.display = 'none';
    
    editBtn.textContent = '수정';
    editBtn.disabled = false;
    isNotesEditing = false;

    alert('메모가 저장되었습니다.');
}

function cancelNotesEdit() {
    const editBtn = document.querySelector('.edit-notes-btn');
    const notesDisplay = document.querySelector('.notes-display');
    const notesEdit = document.querySelector('.notes-edit');
    const editButtons = document.querySelector('.notes-edit-buttons');

    notesEdit.value = originalNotesData.replace(/<br>/g, '\n');

    notesDisplay.style.display = 'block';
    notesEdit.style.display = 'none';
    editButtons.style.display = 'none';
    
    editBtn.textContent = '수정';
    editBtn.disabled = false;
    isNotesEditing = false;
}

// 테이블 행 수정 기능
let editingRow = null;
let originalRowData = {};

function editRow(button) {
    if (editingRow && editingRow !== button.closest('tr')) {
        cancelEdit(editingRow.querySelector('.cancel-btn'));
    }

    const row = button.closest('tr');
    editingRow = row;
    
    const cells = row.querySelectorAll('td');
    originalRowData = {};
    cells.forEach((cell, index) => {
        originalRowData[index] = cell.textContent.trim();
    });

    convertCellsToInputs(row);

    const editBtn = row.querySelector('.edit-btn');
    const saveBtn = row.querySelector('.save-btn');
    const cancelBtn = row.querySelector('.cancel-btn');
    
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
}

function saveRow(button) {
    const row = button.closest('tr');
    
    const typeSelect = row.querySelector('td:nth-child(2) select');
    const contentInput = row.querySelector('td:nth-child(3) input');
    const doctorSelect = row.querySelector('td:nth-child(4) select');
    const statusSelect = row.querySelector('td:nth-child(10) select');

    if (!typeSelect.value || !contentInput.value.trim() || !doctorSelect.value || !statusSelect.value) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }

    convertInputsToCells(row);

    const editBtn = row.querySelector('.edit-btn');
    const saveBtn = row.querySelector('.save-btn');
    const cancelBtn = row.querySelector('.cancel-btn');
    
    editBtn.style.display = 'inline-block';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';

    editingRow = null;
    alert('수정사항이 저장되었습니다.');
}

function cancelEdit(button) {
    const row = button.closest('tr');
    
    const cells = row.querySelectorAll('td');
    cells.forEach((cell, index) => {
        if (originalRowData[index] !== undefined && index < 10) {
            cell.innerHTML = originalRowData[index];
            cell.className = getCellClassName(index, originalRowData[index]);
        }
    });

    const editBtn = row.querySelector('.edit-btn');
    const saveBtn = row.querySelector('.save-btn');
    const cancelBtn = row.querySelector('.cancel-btn');
    
    editBtn.style.display = 'inline-block';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';

    editingRow = null;
}

function convertCellsToInputs(row) {
    const cells = row.querySelectorAll('td');
    
    // 구분 (2번째 컬럼)
    const typeCell = cells[1];
    const typeValue = typeCell.textContent.trim();
    typeCell.innerHTML = `
        <select class="form-control">
            <option value="초진" ${typeValue === '초진' ? 'selected' : ''}>초진</option>
            <option value="재진" ${typeValue === '재진' ? 'selected' : ''}>재진</option>
            <option value="검사" ${typeValue === '검사' ? 'selected' : ''}>검사</option>          
        </select>
    `;
    typeCell.className = 'edit-input-cell';

    // 진료내용 (3번째 컬럼)
    const contentCell = cells[2];
    const contentValue = contentCell.textContent.trim();
    contentCell.innerHTML = `<input type="text" value="${contentValue}" />`;
    contentCell.className = 'edit-input-cell';

    // 담당의 (4번째 컬럼)
    const doctorCell = cells[3];
    const doctorValue = doctorCell.textContent.trim();
    doctorCell.innerHTML = `
        <select class="form-control">
            <option value="김의사" ${doctorValue === '김의사' ? 'selected' : ''}>김의사</option>
            <option value="이의사" ${doctorValue === '이의사' ? 'selected' : ''}>이의사</option>
            <option value="박의사" ${doctorValue === '박의사' ? 'selected' : ''}>박의사</option>
            <option value="최의사" ${doctorValue === '최의사' ? 'selected' : ''}>최의사</option>
            <option value="정의사" ${doctorValue === '정의사' ? 'selected' : ''}>정의사</option>
            <option value="-" ${doctorValue === '-' ? 'selected' : ''}>-</option>
        </select>
    `;
    doctorCell.className = 'edit-input-cell';

    // 진료비 ~ 미수납액 (5~9번째 컬럼)
    for (let i = 4; i <= 8; i++) {
        const cell = cells[i];
        const value = cell.textContent.trim();
        if (value !== '-') {
            cell.innerHTML = `<input type="number" value="${value.replace(/,/g, '')}" min="0" />`;
        } else {
            cell.innerHTML = `<input type="text" value="-" />`;
        }
        cell.className = 'edit-input-cell';
    }

    // 상태 (10번째 컬럼)
    const statusCell = cells[9];
    const statusValue = statusCell.textContent.trim();
    statusCell.innerHTML = `
        <select class="form-control">
            <option value="완료" ${statusValue === '완료' ? 'selected' : ''}>완료</option>
            <option value="미수납" ${statusValue === '미수납' ? 'selected' : ''}>미수납</option>   
        </select>
    `;
    statusCell.className = 'edit-input-cell';
}

function convertInputsToCells(row) {
    const cells = row.querySelectorAll('td');
    
    const typeSelect = cells[1].querySelector('select');
    cells[1].innerHTML = typeSelect.value;
    cells[1].className = '';

    const contentInput = cells[2].querySelector('input');
    cells[2].innerHTML = contentInput.value;
    cells[2].className = 'diagnosis-cell';

    const doctorSelect = cells[3].querySelector('select');
    cells[3].innerHTML = doctorSelect.value;
    cells[3].className = '';

    for (let i = 4; i <= 8; i++) {
        const input = cells[i].querySelector('input');
        let value = input.value;
        if (input.type === 'number' && value && value !== '0') {
            value = parseInt(value).toLocaleString();
        } else if (value === '0' || value === '') {
            value = '-';
        }
        cells[i].innerHTML = value;
        cells[i].className = 'amount-cell';
    }

    const statusSelect = cells[9].querySelector('select');
    const statusValue = statusSelect.value;
    let statusClass = 'status-cell ';
    switch(statusValue) {
        case '완료':
            statusClass += 'status-완료';
            break;
        case '미수납':
            statusClass += 'status-대기';
            break;
        case '취소':
            statusClass += 'status-취소';
            break;
        default:
            statusClass += 'status-대기';
    }
    cells[9].innerHTML = statusValue;
    cells[9].className = statusClass;
}

function getCellClassName(index, value) {
    switch(index) {
        case 0:
            return 'date-cell';
        case 2:
            return 'diagnosis-cell';
        case 4:
        case 5:
        case 6:
        case 7:
        case 8:
            return 'amount-cell';
        case 9:
            let statusClass = 'status-cell ';
            if (value === '완료') statusClass += 'status-완료';
            else if (value === '미수납') statusClass += 'status-대기';
            else if (value === '취소') statusClass += 'status-취소';
            else statusClass += 'status-대기';
            return statusClass;
        default:
            return '';
    }
}
</script>
</body>
</html>