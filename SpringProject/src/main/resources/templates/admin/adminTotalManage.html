<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í†µê³„ ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/adminstyle.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
<!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <div class="profile">
            <div class="profile-icon">ğŸ‘¤</div>
            <span>ë‚´ í”„ë¡œí•„</span>
        </div>
        
        <a href="/admin/adminMemberManage" class="menu-item">
            <div class="menu-icon">ğŸ‘¥</div>
            <span>íšŒì› ê´€ë¦¬</span>
        </a>
               
        <a href="/admin/adminCalendarManage" class="menu-item" id="chart-menu">
            <div class="menu-icon">ğŸ“‹</div>
            <span>ì¼ì • ê´€ë¦¬</span>
        </a>
        
        <a href="/admin/adminRoomManage" class="menu-item">
            <div class="menu-icon">ğŸ›ï¸</div>
            <span>ë³‘ì‹¤ ê´€ë¦¬</span>
        </a>
        
        <a href="/admin/adminTotalManage" class="menu-item active">
            <div class="menu-icon">ğŸ“ˆ</div>
            <span>í†µê³„</span>
        </a>
        
        <a th:href="@{/Login/Logout}" class="menu-item">
	      <div class="menu-icon">ğŸšª</div>
	      <span>ë¡œê·¸ì•„ì›ƒ</span>
	    </a>
    </div>

    <div class="main-content" style="padding:20px 20px 0 20px">
        <div class="dashboard-grid">
			
			<!-- 1. ìµœê·¼ ì¼ì£¼ì¼ ì™¸ë˜í™˜ì ìˆ˜ -->
		  <div class="chart-card">
		    <h3>ìµœê·¼ ì¼ì£¼ì¼ ì™¸ë˜í™˜ì ìˆ˜</h3>
		    <div class="chart-container">
		      <canvas id="weeklyOutpatientChart"></canvas>
		    </div>
		  </div>
		  
		  <!-- 2. ì›”ë³„ ì™¸ë˜í™˜ì ìˆ˜ -->
		  <div class="chart-card">
		    <h3>ì›”ë³„ ì˜ˆì•½ ë°ì´í„° í†µê³„</h3>
		    <div class="chart-container">
		      <canvas id="monthlyOutpatientChart"></canvas>
		    </div>
		  </div>
		
		  <!-- 3. ì—°ë ¹ëŒ€ë³„ í™˜ì ìˆ˜ -->
		  <div class="chart-card">
		    <h3>ì—°ë ¹ëŒ€ë³„ í™˜ì ìˆ˜</h3>
		    <div class="chart-container">
		      <canvas id="ageGroupChart"></canvas>
		    </div>
		  </div>
		
		  <!-- 4. ì§„ë£Œ ìƒíƒœë³„ í™˜ì ìˆ˜ -->
		  <div class="chart-card">
		    <h3>ë‹¹ì¼ ì§„ë£Œ ìƒíƒœë³„ í™˜ì ìˆ˜</h3>
		    <div class="chart-container">
		      <canvas id="statusChart"></canvas>
		    </div>
		  </div>
		  
		  <!-- 5. ì…ì› í˜„í™© -->
			<div class="chart-card">
			  <h3>ë³‘ì‹¤ ì‚¬ìš© í˜„í™©</h3>
			  <div class="chart-container">
			    <canvas id="bedStatusChart"></canvas>
			  </div>
			</div>
			
			<!-- 6. ì›”ë³„ ë§¤ì¶œ -->
			<div class="chart-card">
			  <h3>ì›”ë³„ ë§¤ì¶œ</h3>
			  <div class="chart-container">
			    <canvas id="revenueChart"></canvas>
			  </div>
			</div>
						
		</div>
    </div>
    
    <div id="chartModal" class="modal">
	  <div class="modal-content chart-modal-content">
	    <span class="close-chart-modal">&times;</span>
	    <div class="modal-flex">
	      <div class="modal-left">
	        <canvas id="modalChart" width="600" height="400"></canvas>
	      </div>
	      <div class="modal-right">
	        <h4 id="modalChartTitle">ì°¨íŠ¸ ì œëª©</h4>
	        <p id="modalChartInfo">ì—¬ê¸°ì— ì°¨íŠ¸ ì„¤ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
	      </div>
	    </div>
	  </div>
	</div>
    

    <script>
        const createBarChart = (id, labels, data, label) => {
            new Chart(document.getElementById(id), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label,
                        data,
                        backgroundColor: '#42a5f5',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        };

        const createDoughnutChart = (id, labels, data, colors) => {
            new Chart(document.getElementById(id), {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    cutout: '50%'
                }
            });
        };
        
        let currentChartData = null;
        let modalChart = null;

        document.querySelectorAll('canvas').forEach(canvas => {
        	  canvas.addEventListener('click', () => {
        	    const id = canvas.id;
        	    const chartInstance = Chart.getChart(id);
        	    if (!chartInstance) return;

        	    const chartData = chartInstance.data;
        	    const chartOptions = chartInstance.options;
        	    const chartType = chartInstance.config.type;

        	    document.getElementById('modalChartTitle').textContent = chartType.toUpperCase();
        	    document.getElementById('modalChartInfo').textContent =
        	      chartDescriptions[id] || 'ì°¨íŠ¸ ì •ë³´ ì—†ìŒ';

        	    const modal = document.getElementById('chartModal');
        	    modal.style.display = 'block';

        	    setTimeout(() => {
        	      const ctx = document.getElementById('modalChart').getContext('2d');

        	      // âœ… ì´ì „ ì°¨íŠ¸ ì œê±°
        	      if (modalChart) modalChart.destroy();

        	      // âœ… ìƒˆë¡œ Chart ìƒì„±
        	      modalChart = new Chart(ctx, {
        	        type: chartType,
        	        data: JSON.parse(JSON.stringify(chartData)),     // ì•ˆì „í•˜ê²Œ ë³µì œ
        	        options: JSON.parse(JSON.stringify(chartOptions)) // ë§ˆì°¬ê°€ì§€ë¡œ ë³µì œ
        	      });
        	    }, 100);
        	  });
        	});
        
     	// âœ… ì¶”ê°€: ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelector('.close-chart-modal').addEventListener('click', () => {
          document.getElementById('chartModal').style.display = 'none';
        });
        
        const loadMonthlyOutpatientChart = async () => {
        	  try {
        	    const res = await fetch("/admin/adminTotalManage/monthly-stats");
        	    const data = await res.json();

        	    const labels = Object.keys(data);         // ex: ["2024-01", "2024-02"]
        	    const values = Object.values(data);       // ex: [25, 40, 38, ...]

        	    createBarChart('monthlyOutpatientChart', labels, values, 'ì™¸ë˜í™˜ì ìˆ˜');
        	  } catch (error) {
        	    console.error("ì›”ë³„ ì™¸ë˜í™˜ì ìˆ˜ ë¡œë“œ ì‹¤íŒ¨:", error);
        	  }
        	};
        	
        	const loadChart = async (id, url, type = 'bar', label = '', colors = []) => {
        		  try {
        		    const res = await fetch(url);
        		    const data = await res.json();
        		    const labels = Object.keys(data);
        		    const values = Object.values(data);

        		    if (type === 'bar') {
        		      createBarChart(id, labels, values, label);
        		    } else if (type === 'doughnut') {
        		      createDoughnutChart(id, labels, values, colors);
        		    }
        		  } catch (e) {
        		    console.error(`${id} ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨`, e);
        		  }
        		};

        	
        		window.addEventListener('DOMContentLoaded', () => {
        			  loadMonthlyOutpatientChart();
        			  loadChart('ageGroupChart', '/admin/adminTotalManage/age-groups', 'bar', 'ì—°ë ¹ëŒ€ë³„ í™˜ì ìˆ˜');
        			  loadChart('weeklyOutpatientChart', '/admin/adminTotalManage/weekly-outpatients', 'bar', 'ìµœê·¼ ì¼ì£¼ì¼ ì™¸ë˜í™˜ì ìˆ˜');
        			  loadChart('statusChart', '/admin/adminTotalManage/status-today', 'doughnut', '', ['#4caf50', '#ffc107', '#f44336']);
        			  loadChart('bedStatusChart', '/admin/adminTotalManage/bed-status', 'doughnut', '', ['#ff7043', '#66bb6a']);
        			  loadChart('revenueChart', '/admin/adminTotalManage/revenue-monthly', 'bar', 'ì›”ë³„ ë§¤ì¶œ');
        		});
        		
        </script>
    
    <style>
    .modal {
	  display: none;
	  position: fixed;
	  z-index: 2000;
	  left: 0;
	  top: 0;
	  width: 100%;
	  height: 100%;
	  background-color: rgba(0,0,0,0.5);
	}
	
	.chart-modal-content {
	  background-color: #fff;
	  width: 100%;
	  height: 100%;
	  margin: 5% auto;
	  padding: 20px;
	  border-radius: 8px;
	  position: relative;
	  display: flex;
	  flex-direction: column;
	}
	
	.modal-flex {
	  display: flex;
	  height: 100%;
	  gap: 20px;
	}
	
	.modal-left {
	  flex: 2;
	  display: flex;
	  justify-content: center;
	  align-items: center;
	  min-height: 300px;
	}
	
	.modal-left canvas {
	  width: 100% !important;
	  height: auto !important;
	  max-height: 100%;
	}
	
	.modal-right {
	  flex: 1;
	  overflow-y: auto;
	}
	
	.close-chart-modal {
	  position: absolute;
	  top: 10px;
	  right: 15px;
	  font-size: 20px;
	  font-weight: bold;
	  cursor: pointer;
	}
    
    
    </style>
</body>
</html>
