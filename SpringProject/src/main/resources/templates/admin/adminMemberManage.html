<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리자 회원 관리</title>
  <link rel="stylesheet" href="/css/adminstyle.css">
</head>
<body>
  <div class="sidebar">
    <div class="profile-section">
      <div class="profile-header">
        <img src="/icons/profile.png" alt="프로필 아이콘">
        <span class="profile-text">내 프로필</span>
      </div>
    </div>

    <ul class="nav-menu">
	  <li><a href="/admin/adminMemberManage">회원 관리</a></li>
	  <li><a href="/admin/adminCalendarManage">일정 관리</a></li>
	  <li><a href="/admin/adminRoomManage">병실 관리</a></li>
	  <li><a href="/admin/adminTotalManage">통계</a></li>
	</ul>

    <div class="logout-section">
      <li class="logout-item">로그아웃</li>
    </div>
  </div>

  <div class="main">
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="doctor">의사</button>
        <button class="tab-btn" data-tab="nurse">간호사</button>
        <button class="tab-btn" data-tab="billing">수납원</button>
        <button class="tab-btn" data-tab="staff">환자</button>
      </div>

      <!-- 탭 반복 구조 -->
      <div class="tab-content active" id="doctor">
		  <div class="table-controls">
		    <div class="left-controls">
		      <select class="filter-select">
		        <option value="0">ID</option>
		        <option value="1">이름</option>
		      </select>
		      <input type="text" class="search-input" placeholder="검색어 입력">
		    </div>
		    <select class="sort-select">
		      <option value="0">ID순</option>
		      <option value="1">이름순</option>
		    </select>
		  </div>
		  <table>
		    <thead>
		      <tr>
		        <th>ID</th>
		        <th>이름</th>
		        <th>생년월일</th>
		        <th>전화번호</th>
		        <th>성별</th>
		        <th>주민등록번호</th>
		        <th>주소</th>
		        <th>이메일</th>
		      </tr>
		    </thead>
		    <tbody>
		      <tr th:each="user : ${doctor}" th:attr="data-id=${user.usersId}">
		        <td th:text="${user.usersId}"></td>
		        <td th:text="${user.usersName}"></td>
		        <td th:text="${user.usersBirth}"></td>
		        <td th:text="${user.usersPhone}"></td>
		        <td th:text="${user.usersGender}"></td>
		        <td th:text="${user.usersIdcard}"></td>
		        <td th:text="${user.usersAddress}"></td>
		        <td th:text="${user.usersEmail}"></td>
		      </tr>
		    </tbody>
		  </table>
		</div>

      <!-- 탭 반복 구조 -->
      <div class="tab-content" id="nurse">
		  <div class="table-controls">
		    <div class="left-controls">
		      <select class="filter-select">
		        <option value="0">ID</option>
		        <option value="1">이름</option>
		      </select>
		      <input type="text" class="search-input" placeholder="검색어 입력">
		    </div>
		    <select class="sort-select">
		      <option value="0">ID순</option>
		      <option value="1">이름순</option>
		    </select>
		  </div>
		  <table>
		    <thead>
		      <tr>
		        <th>ID</th>
		        <th>이름</th>
		        <th>생년월일</th>
		        <th>전화번호</th>
		        <th>성별</th>
		        <th>주민등록번호</th>
		        <th>주소</th>
		        <th>이메일</th>
		      </tr>
		    </thead>
		    <tbody>
		      <tr th:each="user : ${nurse}" th:attr="data-id=${user.usersId}">
		        <td th:text="${user.usersId}"></td>
		        <td th:text="${user.usersName}"></td>
		        <td th:text="${user.usersBirth}"></td>
		        <td th:text="${user.usersPhone}"></td>
		        <td th:text="${user.usersGender}"></td>
		        <td th:text="${user.usersIdcard}"></td>
		        <td th:text="${user.usersAddress}"></td>
		        <td th:text="${user.usersEmail}"></td>
		      </tr>
		    </tbody>
		  </table>
		</div>

      <!-- 탭 반복 구조 -->
      <div class="tab-content" id="billing">
		  <div class="table-controls">
		    <div class="left-controls">
		      <select class="filter-select">
		        <option value="0">ID</option>
		        <option value="1">이름</option>
		      </select>
		      <input type="text" class="search-input" placeholder="검색어 입력">
		    </div>
		    <select class="sort-select">
		      <option value="0">ID순</option>
		      <option value="1">이름순</option>
		    </select>
		  </div>
		  <table>
		    <thead>
		      <tr>
		        <th>ID</th>
		        <th>이름</th>
		        <th>생년월일</th>
		        <th>전화번호</th>
		        <th>성별</th>
		        <th>주민등록번호</th>
		        <th>주소</th>
		        <th>이메일</th>
		      </tr>
		    </thead>
		    <tbody>
		      <tr th:each="user : ${billing}" th:attr="data-id=${user.usersId}">
		        <td th:text="${user.usersId}"></td>
		        <td th:text="${user.usersName}"></td>
		        <td th:text="${user.usersBirth}"></td>
		        <td th:text="${user.usersPhone}"></td>
		        <td th:text="${user.usersGender}"></td>
		        <td th:text="${user.usersIdcard}"></td>
		        <td th:text="${user.usersAddress}"></td>
		        <td th:text="${user.usersEmail}"></td>
		      </tr>
		    </tbody>
		  </table>
		</div>

      <div class="tab-content" id="staff">
		  <div class="table-controls">
		    <div class="left-controls">
		      <select class="filter-select">
		        <option value="0">ID</option>
		        <option value="1">이름</option>
		      </select>
		      <input type="text" class="search-input" placeholder="검색어 입력">
		    </div>
		    <select class="sort-select">
		      <option value="0">ID순</option>
		      <option value="1">이름순</option>
		    </select>
		  </div>
		  <table>
		    <thead>
		      <tr>
		        <th>ID</th>
		        <th>이름</th>
		        <th>성별</th>
		        <th>생년월일</th>
		        <th>전화번호</th>
		        <th>주소</th>
		        <th>증상</th>
		        <th>상태</th>
		      </tr>
		    </thead>
		    <tbody id="patient-body">
			  <!-- JavaScript로 데이터 채움 -->
			</tbody>
		  </table>
		</div>
    </div>
  </div>
	  
<!-- ✅ 정보 확인 및 수정 모달 -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <form id="editForm">
      <div id="formFields"></div>
      <div style="margin-top: 20px;">
        <button type="button" id="saveBtn" class="btn-action">저장</button>
        <button type="button" id="deleteBtn" class="btn-action" style="background-color: #e74c3c;">삭제</button>
      </div>
    </form>
  </div>
</div>

  <style>
  .modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fff;
  margin: 10% auto;
  padding: 20px;
  border-radius: 8px;
  width: 350px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  position: relative;
}

.close-modal {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 20px;
  font-weight: bold;
  color: #aaa;
  cursor: pointer;
}

.close-modal:hover {
  color: #333;
}
 
.btn-action {
  padding: 6px 12px;
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-action:hover {
  background-color: #2980b9;
}

  
  </style>

  <script>
    // 탭 전환
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        tabContents.forEach(c => {
          c.classList.remove('active');
          if (c.id === target) c.classList.add('active');
        });
      });
    });

    // 검색
    document.querySelectorAll('.tab-content').forEach(tab => {
      const searchInput = tab.querySelector('.search-input');
      const filterSelect = tab.querySelector('.filter-select');
      const rows = tab.querySelectorAll('tbody tr');

      if (searchInput && filterSelect) {
        searchInput.addEventListener('input', () => {
          const keyword = searchInput.value.toLowerCase();
          const colIndex = parseInt(filterSelect.value);

          rows.forEach(row => {
            const cellText = row.cells[colIndex].textContent.toLowerCase();
            row.style.display = cellText.includes(keyword) ? '' : 'none';
          });
        });
      }
    });

    // 정렬
    document.querySelectorAll('.sort-select').forEach(select => {
      select.addEventListener('change', () => {
        const table = select.closest('.tab-content').querySelector('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const index = parseInt(select.value);

        rows.sort((a, b) => {
          const aText = a.cells[index].textContent;
          const bText = b.cells[index].textContent;
          return aText.localeCompare(bText);
        });

        rows.forEach(row => tbody.appendChild(row));
      });
    });
    
    let selectedRow = null;

 // 테이블 행 클릭 시 모달 표시 및 input 생성
    document.querySelectorAll('.tab-content table tbody tr').forEach(row => {
      row.addEventListener('click', () => {
        selectedRow = row;

        const cells = Array.from(row.cells);
        const headers = Array.from(row.closest('table').querySelectorAll('thead th'));

        const formFields = headers.map((th, idx) => {
          if (!cells[idx]) return "";  // 보호 코드 추가
          return `
            <label>${th.textContent}</label><br>
            <input type="text" value="${cells[idx].textContent}" data-idx="${idx}" style="width: 100%; margin-bottom: 10px;">
          `;
        }).join('');
        document.getElementById('formFields').innerHTML = formFields;

        infoModal.style.display = 'block';
      });
    });
 
 	// 수정 시 Ajax 요청
    saveBtn.addEventListener("click", () => {
      const inputs = document.querySelectorAll("#formFields input");
      const data = {};

      inputs.forEach((input) => {
        const idx = input.getAttribute("data-idx");
        const header = selectedRow.closest("table").querySelectorAll("thead th")[idx].textContent.trim();
        data[header] = input.value;
      });

      fetch("/admin/adminMemberManage/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          usersId: data["ID"],
          usersName: data["이름"],
          usersPhone: data["전화번호"],
          usersEmail: data["이메일"],
          usersAddress: data["주소"],
          usersBirth: data["생년월일"],
          usersGender: data["성별"],
          usersIdcard: data["주민등록번호"]
        })
      })
        .then((res) => res.text())
        .then((msg) => alert(msg));
    });

	 // 삭제 시 Ajax 요청
    document.getElementById('deleteBtn').addEventListener('click', () => {
      if (!confirm('정말 삭제하시겠습니까?')) return;

      const userId = selectedRow.cells[0].textContent.trim();  // ID는 첫 번째 열

      fetch(`/admin/adminMemberManage/delete/${userId}`, {
        method: 'DELETE'
      })
        .then(response => response.text())
        .then(msg => {
          alert(msg);
          selectedRow.remove();
          infoModal.style.display = 'none';
        });
    });
   
    const infoModal = document.getElementById('infoModal');

    document.querySelector('.close-modal').addEventListener('click', () => {
      infoModal.style.display = 'none';
      selectedRow = null;
    });
    
 	// 환자 목록 불러오기
    if (document.getElementById("staff")) {
      fetch("/admin/adminMemberManage/patients")
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("patient-body");
          tbody.innerHTML = "";
          data.forEach(patient => {
            const row = document.createElement("tr");
            row.innerHTML = `
            	  <td>${patient.patientId}</td>
            	  <td>${patient.patientName}</td>
            	  <td>${patient.patientGender}</td>
            	  <td>${patient.patientBirth}</td>
            	  <td>${patient.patientPhone}</td>
            	  <td>${patient.patientAddress}</td>
            	  <td>${patient.patientSymptom}</td>
            	  <td>${patient.patientType}</td>
            	`;
            row.addEventListener("click", () => openPatientModal(row, patient));
            tbody.appendChild(row);
          });
        });
    }

    // 모달 열기 함수
    function openPatientModal(row, patient) {
    	selectedRow = row;
    	document.getElementById("formFields").innerHTML = `
    		  <label>ID</label><br><input type="text" value="${patient.patientId}" data-key="patientId" readonly><br>
    		  <label>이름</label><br><input type="text" value="${patient.patientName}" data-key="patientName"><br>
    		  <label>성별</label><br><input type="text" value="${patient.patientGender}" data-key="patientGender"><br>
    		  <label>생년월일</label><br><input type="text" value="${patient.patientBirth}" data-key="patientBirth"><br>
    		  <label>전화번호</label><br><input type="text" value="${patient.patientPhone}" data-key="patientPhone"><br>
    		  <label>주소</label><br><input type="text" value="${patient.patientAddress}" data-key="patientAddress"><br>
    		  <label>증상</label><br><input type="text" value="${patient.patientSymptom}" data-key="patientSymptom"><br>
    		  <label>상태</label><br><input type="text" value="${patient.patientType}" data-key="patientType"><br>
    		`;
    	  infoModal.style.display = "block";
    }
    	
 	// 날짜 값을 yyyy-MM-dd 형식으로 변환
    function formatBirthToISO(birthStr) {
      return birthStr.replace(/\./g, '-'); // "2010.06.03" → "2010-06-03"
    }

    // 수정 시 Ajax 요청
    saveBtn.addEventListener("click", () => {
	  const inputs = document.querySelectorAll("#formFields input");
	  const patient = {};
	
	  inputs.forEach((input) => {
	    const key = input.getAttribute("data-key");
	    let value = input.value.trim() || null;
	
	    if (key === "patientBirth") {
	      value = formatBirthToISO(value); // ← 여기 핵심!!
	    }
	
	    patient[key] = value;
	  });
	
	  console.log("patientBirth 최종 값:", patient.patientBirth);
	
	  fetch("/admin/adminMemberManage/patients/update", {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify(patient)
	  })
	    .then(res => res.text())
	    .then(msg => {
	      alert(msg);
	      location.reload();
	    });
	});

    // 삭제
    deleteBtn.addEventListener("click", () => {
      const id = document.querySelector("#formFields input[data-key='patientId']").value;
      if (!confirm("정말 삭제하시겠습니까?")) return;

      fetch(`/admin/adminMemberManage/patients/delete/${id}`, {
        method: "DELETE"
      })
        .then(res => res.text())
        .then(msg => {
          alert(msg);
          location.reload();
        });
    });

  </script>
</body>
</html>
