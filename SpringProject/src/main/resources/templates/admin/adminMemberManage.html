<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì íšŒì› ê´€ë¦¬</title>
  <link rel="stylesheet" href="/css/adminstyle.css">
</head>
<body>
  <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <div class="profile">
            <div class="profile-icon">ğŸ‘¤</div>
            <span>ë‚´ í”„ë¡œí•„</span>
        </div>
        
        <a href="/admin/adminMemberManage" class="menu-item active">
            <div class="menu-icon">ğŸ‘¥</div>
            <span>íšŒì› ê´€ë¦¬</span>
        </a>
               
        <a href="/admin/adminCalendarManage" class="menu-item" id="chart-menu">
            <div class="menu-icon">ğŸ“‹</div>
            <span>ì¼ì • ê´€ë¦¬</span>
        </a>
        
        <a href="/admin/adminRoomManage" class="menu-item">
            <div class="menu-icon">ğŸ›ï¸</div>
            <span>ë³‘ì‹¤ ê´€ë¦¬</span>
        </a>
        
        <a href="/admin/adminTotalManage" class="menu-item">
            <div class="menu-icon">ğŸ“ˆ</div>
            <span>í†µê³„</span>
        </a>
        
        <a th:href="@{/Login/Logout}" class="menu-item">
	      <div class="menu-icon">ğŸšª</div>
	      <span>ë¡œê·¸ì•„ì›ƒ</span>
	    </a>
    </div>

  <div class="main">
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="doctor">ì˜ì‚¬</button>
        <button class="tab-btn" data-tab="nurse">ê°„í˜¸ì‚¬</button>
        <button class="tab-btn" data-tab="billing">ìˆ˜ë‚©ì›</button>
        <button class="tab-btn" data-tab="staff">í™˜ì</button>
      </div>

      <!-- íƒ­ ë°˜ë³µ êµ¬ì¡° -->
      <div class="tab-content active" id="doctor">
		  <div class="table-controls">
		    <div class="left-controls">
		      <select class="filter-select">
		        <option value="0">ID</option>
		        <option value="1">ì´ë¦„</option>
		      </select>
		      <input type="text" class="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
		    </div>
		    <select class="sort-select">
		      <option value="0">IDìˆœ</option>
		      <option value="1">ì´ë¦„ìˆœ</option>
		    </select>
		  </div>
		  <table>
		    <thead>
		      <tr>
		        <th>ID</th>
		        <th>ì´ë¦„</th>
		        <th>ìƒë…„ì›”ì¼</th>
		        <th>ì „í™”ë²ˆí˜¸</th>
		        <th>ì„±ë³„</th>
		        <th>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</th>
		        <th>ì£¼ì†Œ</th>
		        <th>ì´ë©”ì¼</th>
		      </tr>
		    </thead>
		    <tbody>
		      <tr th:each="user : ${doctor}" th:attr="data-id=${user.usersId}">
		        <td th:text="${user.usersId}"></td>
		        <td th:text="${user.usersName}"></td>
		        <td th:text="${user.usersBirth}"></td>
		        <td th:text="${user.usersPhone}"></td>
		        <td th:text="${user.usersGender}"></td>
		        <td th:text="${user.usersIdcard}"></td>
		        <td th:text="${user.usersAddress}"></td>
		        <td th:text="${user.usersEmail}"></td>
		      </tr>
		    </tbody>
		  </table>
		</div>

      <!-- íƒ­ ë°˜ë³µ êµ¬ì¡° -->
      <div class="tab-content" id="nurse">
		  <div class="table-controls">
		    <div class="left-controls">
		      <select class="filter-select">
		        <option value="0">ID</option>
		        <option value="1">ì´ë¦„</option>
		      </select>
		      <input type="text" class="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
		    </div>
		    <select class="sort-select">
		      <option value="0">IDìˆœ</option>
		      <option value="1">ì´ë¦„ìˆœ</option>
		    </select>
		  </div>
		  <table>
		    <thead>
		      <tr>
		        <th>ID</th>
		        <th>ì´ë¦„</th>
		        <th>ìƒë…„ì›”ì¼</th>
		        <th>ì „í™”ë²ˆí˜¸</th>
		        <th>ì„±ë³„</th>
		        <th>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</th>
		        <th>ì£¼ì†Œ</th>
		        <th>ì´ë©”ì¼</th>
		      </tr>
		    </thead>
		    <tbody>
		      <tr th:each="user : ${nurse}" th:attr="data-id=${user.usersId}">
		        <td th:text="${user.usersId}"></td>
		        <td th:text="${user.usersName}"></td>
		        <td th:text="${user.usersBirth}"></td>
		        <td th:text="${user.usersPhone}"></td>
		        <td th:text="${user.usersGender}"></td>
		        <td th:text="${user.usersIdcard}"></td>
		        <td th:text="${user.usersAddress}"></td>
		        <td th:text="${user.usersEmail}"></td>
		      </tr>
		    </tbody>
		  </table>
		</div>

      <!-- íƒ­ ë°˜ë³µ êµ¬ì¡° -->
      <div class="tab-content" id="billing">
		  <div class="table-controls">
		    <div class="left-controls">
		      <select class="filter-select">
		        <option value="0">ID</option>
		        <option value="1">ì´ë¦„</option>
		      </select>
		      <input type="text" class="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
		    </div>
		    <select class="sort-select">
		      <option value="0">IDìˆœ</option>
		      <option value="1">ì´ë¦„ìˆœ</option>
		    </select>
		  </div>
		  <table>
		    <thead>
		      <tr>
		        <th>ID</th>
		        <th>ì´ë¦„</th>
		        <th>ìƒë…„ì›”ì¼</th>
		        <th>ì „í™”ë²ˆí˜¸</th>
		        <th>ì„±ë³„</th>
		        <th>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</th>
		        <th>ì£¼ì†Œ</th>
		        <th>ì´ë©”ì¼</th>
		      </tr>
		    </thead>
		    <tbody>
		      <tr th:each="user : ${billing}" th:attr="data-id=${user.usersId}">
		        <td th:text="${user.usersId}"></td>
		        <td th:text="${user.usersName}"></td>
		        <td th:text="${user.usersBirth}"></td>
		        <td th:text="${user.usersPhone}"></td>
		        <td th:text="${user.usersGender}"></td>
		        <td th:text="${user.usersIdcard}"></td>
		        <td th:text="${user.usersAddress}"></td>
		        <td th:text="${user.usersEmail}"></td>
		      </tr>
		    </tbody>
		  </table>
		</div>

      <div class="tab-content" id="staff">
		  <div class="table-controls">
		    <div class="left-controls">
		      <select class="filter-select">
		        <option value="0">ID</option>
		        <option value="1">ì´ë¦„</option>
		      </select>
		      <input type="text" class="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
		    </div>
		    <select class="sort-select">
		      <option value="0">IDìˆœ</option>
		      <option value="1">ì´ë¦„ìˆœ</option>
		    </select>
		  </div>
		  <table>
		    <thead>
		      <tr>
		        <th>ID</th>
		        <th>ì´ë¦„</th>
		        <th>ì„±ë³„</th>
		        <th>ìƒë…„ì›”ì¼</th>
		        <th>ì „í™”ë²ˆí˜¸</th>
		        <th>ì£¼ì†Œ</th>
		        <th>ì¦ìƒ</th>
		        <th>ìƒíƒœ</th>
		      </tr>
		    </thead>
		    <tbody id="patient-body">
			  <!-- JavaScriptë¡œ ë°ì´í„° ì±„ì›€ -->
			</tbody>
		  </table>
		</div>
    </div>
  </div>
	  
<!-- âœ… ì •ë³´ í™•ì¸ ë° ìˆ˜ì • ëª¨ë‹¬ -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <form id="editForm">
      <div id="formFields"></div>
      <div style="margin-top: 20px;">
        <button type="button" id="saveBtn" class="btn-action">ì €ì¥</button>
        <button type="button" id="deleteBtn" class="btn-action" style="background-color: #e74c3c;">ì‚­ì œ</button>
      </div>
    </form>
  </div>
</div>

  <style>
  .modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fff;
  margin: 10% auto;
  padding: 20px;
  border-radius: 8px;
  width: 350px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  position: relative;
}

.close-modal {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 20px;
  font-weight: bold;
  color: #aaa;
  cursor: pointer;
}

.close-modal:hover {
  color: #333;
}
 
.btn-action {
  padding: 6px 12px;
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-action:hover {
  background-color: #2980b9;
}

  
  </style>

  <script>
    // íƒ­ ì „í™˜
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        tabContents.forEach(c => {
          c.classList.remove('active');
          if (c.id === target) c.classList.add('active');
        });
      });
    });

    // ê²€ìƒ‰
    document.querySelectorAll('.tab-content').forEach(tab => {
      const searchInput = tab.querySelector('.search-input');
      const filterSelect = tab.querySelector('.filter-select');
      const rows = tab.querySelectorAll('tbody tr');

      if (searchInput && filterSelect) {
        searchInput.addEventListener('input', () => {
          const keyword = searchInput.value.toLowerCase();
          const colIndex = parseInt(filterSelect.value);

          rows.forEach(row => {
            const cellText = row.cells[colIndex].textContent.toLowerCase();
            row.style.display = cellText.includes(keyword) ? '' : 'none';
          });
        });
      }
    });

    // ì •ë ¬
    document.querySelectorAll('.sort-select').forEach(select => {
      select.addEventListener('change', () => {
        const table = select.closest('.tab-content').querySelector('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const index = parseInt(select.value);

        rows.sort((a, b) => {
          const aText = a.cells[index].textContent;
          const bText = b.cells[index].textContent;
          return aText.localeCompare(bText);
        });

        rows.forEach(row => tbody.appendChild(row));
      });
    });
    
    let selectedRow = null;

 // í…Œì´ë¸” í–‰ í´ë¦­ ì‹œ ëª¨ë‹¬ í‘œì‹œ ë° input ìƒì„±
    document.querySelectorAll('.tab-content table tbody tr').forEach(row => {
      row.addEventListener('click', () => {
        selectedRow = row;

        const cells = Array.from(row.cells);
        const headers = Array.from(row.closest('table').querySelectorAll('thead th'));

        const formFields = headers.map((th, idx) => {
          if (!cells[idx]) return "";  // ë³´í˜¸ ì½”ë“œ ì¶”ê°€
          return `
            <label>${th.textContent}</label><br>
            <input type="text" value="${cells[idx].textContent}" data-idx="${idx}" style="width: 100%; margin-bottom: 10px;">
          `;
        }).join('');
        document.getElementById('formFields').innerHTML = formFields;

        infoModal.style.display = 'block';
      });
    });
 
 	// ìˆ˜ì • ì‹œ Ajax ìš”ì²­
    saveBtn.addEventListener("click", () => {
      const inputs = document.querySelectorAll("#formFields input");
      const data = {};

      inputs.forEach((input) => {
        const idx = input.getAttribute("data-idx");
        const header = selectedRow.closest("table").querySelectorAll("thead th")[idx].textContent.trim();
        data[header] = input.value;
      });

      fetch("/admin/adminMemberManage/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          usersId: data["ID"],
          usersName: data["ì´ë¦„"],
          usersPhone: data["ì „í™”ë²ˆí˜¸"],
          usersEmail: data["ì´ë©”ì¼"],
          usersAddress: data["ì£¼ì†Œ"],
          usersBirth: data["ìƒë…„ì›”ì¼"],
          usersGender: data["ì„±ë³„"],
          usersIdcard: data["ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸"]
        })
      })
        .then((res) => res.text())
        .then((msg) => alert(msg));
    });
   
    const infoModal = document.getElementById('infoModal');

    document.querySelector('.close-modal').addEventListener('click', () => {
      infoModal.style.display = 'none';
      selectedRow = null;
    });
    
 	// í™˜ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    if (document.getElementById("staff")) {
      fetch("/admin/adminMemberManage/patients")
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("patient-body");
          tbody.innerHTML = "";
          data.forEach(patient => {
            const row = document.createElement("tr");
            row.innerHTML = `
            	  <td>${patient.patientId}</td>
            	  <td>${patient.patientName}</td>
            	  <td>${patient.patientGender}</td>
            	  <td>${patient.patientBirth}</td>
            	  <td>${patient.patientPhone}</td>
            	  <td>${patient.patientAddress}</td>
            	  <td>${patient.patientSymptom}</td>
            	  <td>${patient.patientType}</td>
            	`;
            row.addEventListener("click", () => openPatientModal(row, patient));
            tbody.appendChild(row);
          });
        });
    }

    // ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
    function openPatientModal(row, patient) {
    	selectedRow = row;
    	document.getElementById("formFields").innerHTML = `
    		  <label>ID</label><br><input type="text" value="${patient.patientId}" data-key="patientId" readonly><br>
    		  <label>ì´ë¦„</label><br><input type="text" value="${patient.patientName}" data-key="patientName"><br>
    		  <label>ì„±ë³„</label><br><input type="text" value="${patient.patientGender}" data-key="patientGender"><br>
    		  <label>ìƒë…„ì›”ì¼</label><br><input type="text" value="${patient.patientBirth}" data-key="patientBirth"><br>
    		  <label>ì „í™”ë²ˆí˜¸</label><br><input type="text" value="${patient.patientPhone}" data-key="patientPhone"><br>
    		  <label>ì£¼ì†Œ</label><br><input type="text" value="${patient.patientAddress}" data-key="patientAddress"><br>
    		  <label>ì¦ìƒ</label><br><input type="text" value="${patient.patientSymptom}" data-key="patientSymptom"><br>
    		  <label>ìƒíƒœ</label><br><input type="text" value="${patient.patientType}" data-key="patientType"><br>
    		`;
    	  infoModal.style.display = "block";
    }
    	
 	// ë‚ ì§œ ê°’ì„ yyyy-MM-dd í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    function formatBirthToISO(birthStr) {
      return birthStr.replace(/\./g, '-'); // "2010.06.03" â†’ "2010-06-03"
    }

    // ìˆ˜ì • ì‹œ Ajax ìš”ì²­
    saveBtn.addEventListener("click", () => {
	  const inputs = document.querySelectorAll("#formFields input");
	  const patient = {};
	
	  inputs.forEach((input) => {
	    const key = input.getAttribute("data-key");
	    let value = input.value.trim() || null;
	
	    if (key === "patientBirth") {
	      value = formatBirthToISO(value); // â† ì—¬ê¸° í•µì‹¬!!
	    }
	
	    patient[key] = value;
	  });
	
	  console.log("patientBirth ìµœì¢… ê°’:", patient.patientBirth);
	
	  fetch("/admin/adminMemberManage/patients/update", {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify(patient)
	  })
	    .then(res => res.text())
	    .then(msg => {
	      alert(msg);
	      location.reload();
	    });
	});

    document.getElementById('deleteBtn').addEventListener('click', () => {
    	  const isPatientTab = document.querySelector('.tab-btn[data-tab="staff"]').classList.contains('active');

    	  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    	  if (isPatientTab) {
    	    // í™˜ì ì‚­ì œ
    	    const id = document.querySelector("#formFields input[data-key='patientId']").value;
    	    fetch(`/admin/adminMemberManage/patients/delete/${id}`, {
    	      method: "DELETE"
    	    })
    	      .then(res => res.text())
    	      .then(msg => {
    	        alert(msg);
    	        location.reload();
    	      });

    	  } else {
    	    // ì¼ë°˜ ì‚¬ìš©ì ì‚­ì œ
    	    const userId = selectedRow.cells[0].textContent.trim();
    	    fetch(`/admin/adminMemberManage/delete/${userId}`, {
    	      method: 'DELETE'
    	    })
    	      .then(response => response.text())
    	      .then(msg => {
    	        alert(msg);
    	        selectedRow.remove();
    	        infoModal.style.display = 'none';
    	      });
    	  }
    	});

  </script>
</body>
</html>
