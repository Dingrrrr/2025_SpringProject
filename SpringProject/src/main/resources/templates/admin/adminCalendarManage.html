
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì ìŠ¤ì¼€ì¤„ ê´€ë¦¬</title>
  <link rel="stylesheet" href="/css/adminstyle.css">
</head>
<body>
   <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <div class="profile">
            <div class="profile-icon">ğŸ‘¤</div>
            <span>ë‚´ í”„ë¡œí•„</span>
        </div>
        
        <a href="/admin/adminMemberManage" class="menu-item">
            <div class="menu-icon">ğŸ‘¥</div>
            <span>íšŒì› ê´€ë¦¬</span>
        </a>
               
        <a href="/admin/adminCalendarManage" class="menu-item active" id="chart-menu">
            <div class="menu-icon">ğŸ“‹</div>
            <span>ì¼ì • ê´€ë¦¬</span>
        </a>
        
        <a href="/admin/adminRoomManage" class="menu-item">
            <div class="menu-icon">ğŸ›ï¸</div>
            <span>ë³‘ì‹¤ ê´€ë¦¬</span>
        </a>
        
        <a href="/admin/adminTotalManage" class="menu-item">
            <div class="menu-icon">ğŸ“ˆ</div>
            <span>í†µê³„</span>
        </a>
        
        <a th:href="@{/Login/Logout}" class="menu-item">
	      <div class="menu-icon">ğŸšª</div>
	      <span>ë¡œê·¸ì•„ì›ƒ</span>
	    </a>
    </div>

  <div class="main">
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="doctor">ì˜ì‚¬</button>
        <button class="tab-btn" data-tab="nurse">ê°„í˜¸ì‚¬</button>
        <button class="tab-btn" data-tab="billing">ìˆ˜ë‚©ì›</button>
      </div>

      <!-- íƒ­ ë°˜ë³µ êµ¬ì¡° -->
      <div class="tab-content active" id="doctor">
        <div class="table-controls">
		  <div class="left-controls">
		    <select class="filter-select">
		      <option value="0">ID</option>
		      <option value="1">ì´ë¦„</option>
		    </select>
		    <input type="text" class="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
		  </div>
		
		  <div class="right-controls">
		    <select class="sort-select">
		      <option value="0">IDìˆœ</option>
		      <option value="1">ì´ë¦„ìˆœ</option>
		    </select>
		    <button type="button" class="btn-action add-schedule-btn">ì¶”ê°€</button>
		  </div>
		</div>
        <table>
          <thead>
            <tr>
              <th>ID</th><th>ì´ë¦„</th><th>ê·¼ë¬´ ìš”ì¼</th><th>ê·¼ë¬´ ì‹œì‘ ì‹œê°„</th><th>ê·¼ë¬´ ì¢…ë£Œ ì‹œê°„</th><th>ìŠ¤ì¼€ì¤„ ìœ í˜•</th>
            </tr>
          </thead>
          <tbody>
			  <tr th:each="sched : ${doctorScheds}" th:attr="data-id=${sched.scheduleId}">
			    <td th:text="${sched.user.usersId}"></td>
			    <td th:text="${sched.user.usersName}"></td>
			    <td th:text="${#strings.arrayJoin(sched.workDays.toArray(), ', ')}"></td>
			    <td th:text="${sched.startTime}"></td>
			    <td th:text="${sched.endTime}"></td>
			    <td th:text="${sched.type}"></td>
			  </tr>
		</tbody>
        </table>
      </div>

      <div class="tab-content" id="nurse">
        <div class="table-controls">
		  <div class="left-controls">
		    <select class="filter-select">
		      <option value="0">ID</option>
		      <option value="1">ì´ë¦„</option>
		    </select>
		    <input type="text" class="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
		  </div>
		
		  <div class="right-controls">
		    <select class="sort-select">
		      <option value="0">IDìˆœ</option>
		      <option value="1">ì´ë¦„ìˆœ</option>
		    </select>
		    <button type="button" class="btn-action add-schedule-btn">ì¶”ê°€</button>
		  </div>
		</div>
        <table>
          <thead>
            <tr>
              <th>ID</th><th>ì´ë¦„</th><th>ê·¼ë¬´ ìš”ì¼</th><th>ê·¼ë¬´ ì‹œì‘ ì‹œê°„</th><th>ê·¼ë¬´ ì¢…ë£Œ ì‹œê°„</th><th>ìŠ¤ì¼€ì¤„ ìœ í˜•</th>
            </tr>
          </thead>
          <tbody>
			  <tr th:each="sched : ${nurseScheds}" th:attr="data-id=${sched.scheduleId}">
			    <td th:text="${sched.user.usersId}"></td>
			   	<td th:text="${sched.user.usersName}"></td>
			    <td th:text="${#strings.arrayJoin(sched.workDays.toArray(), ', ')}"></td>
			    <td th:text="${sched.startTime}"></td>
			    <td th:text="${sched.endTime}"></td>
			    <td th:text="${sched.type}"></td>
			  </tr>
		</tbody>
        </table>
      </div>

      <div class="tab-content" id="billing">
        <div class="table-controls">
		  <div class="left-controls">
		    <select class="filter-select">
		      <option value="0">ID</option>
		      <option value="1">ì´ë¦„</option>
		    </select>
		    <input type="text" class="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
		  </div>
		
		  <div class="right-controls">
		    <select class="sort-select">
		      <option value="0">IDìˆœ</option>
		      <option value="1">ì´ë¦„ìˆœ</option>
		    </select>
		    <button type="button" class="btn-action add-schedule-btn">ì¶”ê°€</button>
		  </div>
		</div>
        <table>
          <thead>
            <tr>
              <th>ID</th><th>ì´ë¦„</th><th>ê·¼ë¬´ ìš”ì¼</th><th>ê·¼ë¬´ ì‹œì‘ ì‹œê°„</th><th>ê·¼ë¬´ ì¢…ë£Œ ì‹œê°„</th><th>ìŠ¤ì¼€ì¤„ ìœ í˜•</th>
            </tr>
          </thead>
          <tbody>
          	<tr th:each="sched : ${billingScheds}" th:attr="data-id=${sched.scheduleId}">
			    <td th:text="${sched.user.usersId}"></td>
			    <td th:text="${sched.user.usersName}"></td>
			    <td th:text="${#strings.arrayJoin(sched.workDays.toArray(), ', ')}"></td>
			    <td th:text="${sched.startTime}"></td>
			    <td th:text="${sched.endTime}"></td>
			    <td th:text="${sched.type}"></td>
			  </tr>
		</tbody>
        </table>
      </div>
    </div>
  </div>
	  
<!-- âœ… ì •ë³´ í™•ì¸ ë° ìˆ˜ì • ëª¨ë‹¬ -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <form id="editForm">
      <div id="formFields"></div>
      <div style="margin-top: 20px;">
        <button type="button" id="saveBtn" class="btn-action">ì €ì¥</button>
        <button type="button" id="deleteBtn" class="btn-action" style="background-color: #e74c3c;">ì‚­ì œ</button>
      </div>
    </form>
  </div>
</div>

  <style>
  .modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fff;
  margin: 10% auto;
  padding: 20px;
  border-radius: 8px;
  width: 350px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  position: relative;
}

.close-modal {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 20px;
  font-weight: bold;
  color: #aaa;
  cursor: pointer;
}

.close-modal:hover {
  color: #333;
}
 
.btn-action {
  padding: 6px 12px;
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-action:hover {
  background-color: #2980b9;
}

  
  </style>

  <script>
    // íƒ­ ì „í™˜
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        tabContents.forEach(c => {
          c.classList.remove('active');
          if (c.id === target) c.classList.add('active');
        });
      });
    });

    // ê²€ìƒ‰
    document.querySelectorAll('.tab-content').forEach(tab => {
      const searchInput = tab.querySelector('.search-input');
      const filterSelect = tab.querySelector('.filter-select');
      const rows = tab.querySelectorAll('tbody tr');

      if (searchInput && filterSelect) {
        searchInput.addEventListener('input', () => {
          const keyword = searchInput.value.toLowerCase();
          const colIndex = parseInt(filterSelect.value);

          rows.forEach(row => {
            const cellText = row.cells[colIndex].textContent.toLowerCase();
            row.style.display = cellText.includes(keyword) ? '' : 'none';
          });
        });
      }
    });

    // ì •ë ¬
    document.querySelectorAll('.sort-select').forEach(select => {
      select.addEventListener('change', () => {
        const table = select.closest('.tab-content').querySelector('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const index = parseInt(select.value);

        rows.sort((a, b) => {
          const aText = a.cells[index].textContent;
          const bText = b.cells[index].textContent;
          return aText.localeCompare(bText);
        });

        rows.forEach(row => tbody.appendChild(row));
      });
    });
    
    let selectedRow = null;

    // í…Œì´ë¸” í–‰ í´ë¦­ ì‹œ ëª¨ë‹¬ í‘œì‹œ ë° input ìƒì„±
	document.querySelectorAll('.tab-content table tbody tr').forEach(row => {
	  row.addEventListener('click', () => {
	    selectedRow = row;
	
	    const cells = Array.from(row.cells);
	    const headers = Array.from(row.closest('table').querySelectorAll('thead th'));
	
	    const nameMap = {
	      "ID": "usersId",
	      "ì´ë¦„": "usersName",
	      "ê·¼ë¬´ ìš”ì¼": "workDays",
	      "ê·¼ë¬´ ì‹œì‘ ì‹œê°„": "startTime",
	      "ê·¼ë¬´ ì¢…ë£Œ ì‹œê°„": "endTime",
	      "ìŠ¤ì¼€ì¤„ ìœ í˜•": "type"
	    };
	
	    const formFields = headers.map((th, idx) => {
	      const nameAttr = nameMap[th.textContent.trim()] || `field${idx}`;
	      return `
	        <label>${th.textContent}</label><br>
	        <input type="text" name="${nameAttr}" value="${cells[idx].textContent.trim()}" style="width: 100%; margin-bottom: 10px;">
	      `;
	    }).join('');
	    
	    document.getElementById('formFields').innerHTML = formFields;
	    infoModal.style.display = 'block';
	  });
	});
 
 	// ì €ì¥ ì‹œ Ajax ìš”ì²­
    saveBtn.addEventListener("click", () => {
	  const data = {};
	
	  // ëª¨ë“  input(name í¬í•¨ëœ ê²ƒë“¤) ìˆ˜ì§‘
	  const inputs = document.querySelectorAll("#formFields input[name], #formFields select[name]");
	  inputs.forEach((input) => {
	    data[input.name] = input.value.trim();
	  });
	
	  // ì‹œê°„ ìœ íš¨ì„± ê²€ì‚¬
	  const isValidTime = (t) => /^([01]\d|2[0-3]):[0-5]\d$/.test(t);
	  if (!isValidTime(data.startTime) || !isValidTime(data.endTime)) {
	    alert("ì‹œê°„ í˜•ì‹ì€ HH:mm (ì˜ˆ: 09:00) í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
	    return;
	  }
	
	  // workDays ë¬¸ìì—´ â†’ ë°°ì—´ ë³€í™˜
	  data.workDays = (data.workDays || "").split(",").map(day => day.trim());
	
	  const url = selectedRow
	    ? `/admin/adminCalendarManage/update`
	    : `/admin/adminCalendarManage/create`;
	
	  const payload = selectedRow
	    ? { scheduleId: selectedRow.getAttribute("data-id"), ...data }
	    : data;
	
	  // ë””ë²„ê¹…ìš© ì¶œë ¥
	  console.log("ë³´ë‚¼ ë°ì´í„° payload:", payload);
	
	  fetch(url, {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify(payload)
	  })
	    .then((res) => res.text())
	    .then((msg) => {
	      alert(msg);
	      location.reload();
	    });
	});

    // ì‚­ì œ ì‹œ Ajax ìš”ì²­
    document.getElementById('deleteBtn').addEventListener('click', () => {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      fetch(`/admin/adminCalendarManage/delete/${selectedRow.getAttribute('data-id')}`, {
        method: 'DELETE'
      })
      .then(response => response.text())
      .then(msg => {
        alert(msg);
        selectedRow.remove();
        infoModal.style.display = 'none';
      });
    });
    
    const infoModal = document.getElementById('infoModal');

    document.querySelector('.close-modal').addEventListener('click', () => {
      infoModal.style.display = 'none';
      selectedRow = null;
    });

    document.querySelectorAll('.add-schedule-btn').forEach(btn => {
    	  btn.addEventListener('click', () => {
    	    const tab = btn.closest('.tab-content');
    	    const tabId = tab.id; // doctor, nurse, billing
    	    selectedRow = null;

    	    const gradeMap = {
    	      doctor: 'ì˜ì‚¬',
    	      nurse: 'ê°„í˜¸ì‚¬',
    	      billing: 'ìˆ˜ë‚©'
    	    };

    	    fetch(`/admin/adminCalendarManage/users?grade=${gradeMap[tabId]}`)
    	      .then(response => response.json())
    	      .then(userList => {
    	    	  const idSelectHTML = `
    	    		  <label>ID</label><br>
    	    		  <select id="idSelect" name="usersId" style="width: 100%; margin-bottom: 10px;">
    	    		    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
    	    		    ${userList.map(user => `<option value="${user.usersId}">${user.usersId}</option>`).join('')}
    	    		  </select>
    	    		`;

    	    		const nameInputHTML = `
    	    		  <label>ì´ë¦„</label><br>
    	    		  <input type="text" id="nameInput" name="usersName" disabled style="width: 100%; margin-bottom: 10px;">
    	    		`;

    	    		const otherFields = [
    	    		  { label: 'ê·¼ë¬´ ìš”ì¼', placeholder: 'ì˜ˆ: ì›”,í™”,ìˆ˜', name: 'workDays' },
    	    		  { label: 'ê·¼ë¬´ ì‹œì‘ ì‹œê°„', placeholder: 'ì˜ˆ: 09:00', name: 'startTime' },
    	    		  { label: 'ê·¼ë¬´ ì¢…ë£Œ ì‹œê°„', placeholder: 'ì˜ˆ: 18:00', name: 'endTime' },
    	    		  { label: 'ìŠ¤ì¼€ì¤„ ìœ í˜•', placeholder: 'ì˜ˆ: ì¶œê·¼, í‡´ê·¼', name: 'type' }
    	    		];

    	    		const otherInputsHTML = otherFields.map((field) => `
    	    		  <label>${field.label}</label><br>
    	    		  <input type="text" name="${field.name}" placeholder="${field.placeholder}" style="width: 100%; margin-bottom: 10px;">
    	    		`).join('');

    	        document.getElementById('formFields').innerHTML = idSelectHTML + nameInputHTML + otherInputsHTML;

    	        document.getElementById('idSelect').addEventListener('change', e => {
    	          const selectedId = e.target.value;
    	          const selectedUser = userList.find(u => u.usersId === selectedId);
    	          document.getElementById('nameInput').value = selectedUser ? selectedUser.usersName : '';
    	        });

    	        infoModal.style.display = 'block';
    	      });
    	  });
    	});

  </script>
</body>
</html>
