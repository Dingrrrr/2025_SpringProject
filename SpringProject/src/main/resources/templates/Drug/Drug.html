<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¬ê³  ê´€ë¦¬ - í†µí•© íŒ¨ë„</title>
  <link rel="stylesheet" href="/css/drug.css">
</head>
<body class="inventory">

 <!-- ì‚¬ì´ë“œ ë°” -->
<div class = "sidebar">
	<div class = "profile">
		<div class = "profile-icon">ğŸ‘¤</div>
		<span th:text="${userName}">ìˆ˜ë‚© ì´ë¦„</span>
	</div>
	
	<div class = "menu-item">
		<div class = "menu-icon">ğŸ””</div>
		<span>ì•Œë¦¼</span>
	</div>
	<a href = "/acceptance/acceptanceHome">
	<div class = "menu-item">
		<div class = "menu-icon">ğŸ </div>
		<span>í™ˆ</span>
	</div>
	</a>
	
	<div class="menu-item has-submenu" onclick="toggleSubMenu(this)">
		<div class = "menu-icon">ğŸ“‹</div>
		<span>ì§„ë£Œ</span>
	</div>
	
	<ul class="submenu">
	<a href="/acceptance/acceptanceDoctor">
   	 	<li class="submenu-item active">ì˜ì‚¬ ìŠ¤ì¼€ì¤„</li></a>
   	 <a href ="/acceptance/acceptanceCondition">
    	<li class="submenu-item">ì§„ë£Œ ìƒíƒœ</li></a>
	</ul>
	
	
	<a href="/acceptance/acceptanceReception" class="menu-item">
	  <div class="menu-icon">ğŸ‘¥</div>
	  <span>ì˜ˆì•½</span>
	</a>
	
	<div class = "menu-item">
		<div class = "menu-icon">âœï¸</div>
		<span>ìˆ˜ë‚©</span>
	</div>
	
	<a href = "/Drug/Drug">
	<div class = "menu-item">
		<div class = "menu-icon">ğŸ’œ</div>
		<span>ì¬ê³ </span>
		
	</div>
	</a>
	
	<div class="menu-item has-submenu" onclick="toggleSubMenu(this)">
  <div class="menu-icon">ğŸ›Œ</div>
  <span>ì…ì›</span>
</div>

<ul class="submenu">
  <a href="/Inpatient/Inpatient">
    <li class="submenu-item">ì…ì› ê´€ë¦¬</li>
  </a>
  <a href="/Inpatient/InpatientStatistics">
    <li class="submenu-item">ì…ì› í†µê³„</li>
  </a>
</ul>
<a th:href="@{/Login/Logout}" class="menu-item logout">
    		<div class="menu-icon">ğŸšª</div>
    		<span>ë¡œê·¸ì•„ì›ƒ</span>
		</a>
    </div>
      <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <div class="inventory-main">
    <div class="header-bar">
      <div class="header-left">
        <input type="text" id="search-input" placeholder="ê²€ìƒ‰">
        <select id="type-filter">
		  <option value="">ì „ì²´</option>
		  <option value="INTERNAL">ë‚´ë³µì•½</option>
		  <option value="EXTERNAL">ì™¸ìš©ì•½</option>
		  <option value="INJECTION">ì£¼ì‚¬</option>
		  <option value="LIQUID">ìˆ˜ì•¡ì œ</option>
		  <option value="ETC">ê¸°íƒ€</option>
		</select>


        <select id="sort-filter">
		  <option value="name_asc">ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ</option>
		  <option value="name_desc">ì´ë¦„ ë‚´ë¦¼ì°¨ìˆœ</option>
		  <option value="stock_desc">ì¬ê³  ë§ì€ ìˆœ</option>
		  <option value="stock_asc">ì¬ê³  ì ì€ ìˆœ</option>
		</select>

        <label><input type="checkbox" id="stock-only"> ì¬ê³  ë³´ìœ </label>
      </div>
      <div class="header-right">
        <button onclick="window.open('/Drug/Add', 'AddDrugPopup', 'width=700,height=650')">+ ì œí’ˆ ì¶”ê°€</button>
        <button id="manage-btn" onclick="toggleEditMode()">âš™ ì œí’ˆ ê´€ë¦¬</button>
      </div>
    </div>

    <div class="content">
      <!-- ì™¼ìª½ íŒ¨ë„ -->
      <div class="panel" id="product-panel">
        <!-- JSë¡œ ì•½í’ˆ ì¹´ë“œ ë™ì  ì‚½ì… -->
      </div>

      <!-- ì˜¤ë¥¸ìª½ ìƒì„¸ì •ë³´ íŒ¨ë„ -->
      <div class="panel right-panel" id="detail-panel">
        <h2>ìƒì„¸ ì •ë³´</h2>
        <div class="placeholder">ì•½í’ˆì„ ì„ íƒí•˜ë©´ ì´ê³³ì— ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>
  
  <!-- ì¶œê³  ëª¨ë‹¬ -->
<div id="withdraw-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <h3>ì•½í’ˆ ì¶œê³ </h3>
    <p id="withdraw-drug-name"></p>
    <p>í˜„ì¬ ì¬ê³ : <span id="withdraw-current-stock"></span></p>

    <label for="withdraw-amount">ì¶œê³  ìˆ˜ëŸ‰</label>
    <input type="number" id="withdraw-amount" min="1" />

    <div class="modal-buttons">
      <button onclick="closeWithdrawModal()">ì·¨ì†Œ</button>
      <button onclick="submitWithdraw()">ì¶œê³ </button>
    </div>
  </div>
</div>
 <!-- ì…ê³  ëª¨ë‹¬ -->
<div id="add-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <h3>ì•½í’ˆ ì…ê³ </h3>
    <p id="add-drug-name"></p>
    <p>í˜„ì¬ ì¬ê³ : <span id="add-current-stock"></span></p>

    <label for="add-amount">ì…ê³  ìˆ˜ëŸ‰</label>
    <input type="number" id="add-amount" min="1" />

    <div class="modal-buttons">
      <button onclick="closeAddModal()">ì·¨ì†Œ</button>
      <button onclick="submitAdd()">ì…ê³ </button>
    </div>
  </div>
</div>


<script>
  let currentDrug = null;
  let isEditing = false;
  let loadedDrugs = [];

  const FORM_TYPE_LABELS = {
    INTERNAL: "ë‚´ë³µì•½",
    EXTERNAL: "ì™¸ìš©ì•½",
    INJECTION: "ì£¼ì‚¬",
    LIQUID: "ìˆ˜ì•¡ì œ",
    ETC: "ê¸°íƒ€"
  };
	
	//í† ê¸€
function toggleSubMenu(menuItem) {
  const allMenuItems = document.querySelectorAll('.menu-item');
  const allSubmenus = document.querySelectorAll('.submenu');

  // í˜„ì¬ ì´ë¯¸ ì—´ë ¤ ìˆëŠ” ê²½ìš° ë‹«ê¸°
  const isActive = menuItem.classList.contains('active');
  allMenuItems.forEach(item => item.classList.remove('active'));
  allSubmenus.forEach(sub => sub.style.display = 'none');

  // ë‹¤ì‹œ ì—´ê¸° (ë‹«ê¸° ìƒíƒœì˜€ë‹¤ë©´)
  if (!isActive) {
    menuItem.classList.add('active');
    const submenu = menuItem.nextElementSibling;
    if (submenu && submenu.classList.contains('submenu')) {
      submenu.style.display = 'block';
    }
  }
}

// âœ… ë©”ë‰´ ì´ˆê¸°í™” ë° í•˜ìœ„ ë©”ë‰´ í™œì„±í™”
document.addEventListener('DOMContentLoaded', function () {
  const submenuItems = document.querySelectorAll('.submenu-item');
  submenuItems.forEach(item => {
    item.addEventListener('click', function () {
      submenuItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
    });
  });

  // ì‚¬ì´ë“œë°” ì´ˆê¸°í™”: í™œì„±í™”ëœ ë©”ë‰´ê°€ ìˆìœ¼ë©´ submenu ì—´ê¸°
  const activeMenu = document.querySelector('.menu-item.has-submenu.active');
  if (activeMenu) {
    const submenu = activeMenu.nextElementSibling;
    if (submenu && submenu.classList.contains('submenu')) {
      submenu.style.display = 'block';
    }
  }
});
	
  async function loadInventoryCards() {
  try {
    const res = await fetch("/api/inventory/summary");
    if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜: ì¬ê³  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    loadedDrugs = await res.json();  // ì „ì²´ ì•½í’ˆ ì €ì¥
    renderInventoryCards(loadedDrugs);  // ë Œë”ë§
  } catch (err) {
    alert("ì¬ê³  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    console.error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
  }
}

window.loadInventoryCards = loadInventoryCards;  // âœ… ë°”ë¡œ ì•„ë˜ ì¶”ê°€


  function renderInventoryCards(drugs) {
    const panel = document.getElementById("product-panel");
    panel.innerHTML = "";

    drugs.forEach(drug => {
      const card = document.createElement("div");
      card.className = "product-card";
      card.onclick = () => showDetail(drug);
		 console.log("drug.type:", drug.type);//ì½˜ì†” ë¡œê·¸
      const typeLabel = FORM_TYPE_LABELS[drug.type] || drug.type;

      card.innerHTML = `
        <div class="info-block">
          <div class="name">${drug.name}</div>
          <div class="info">${typeLabel} | ${drug.code}</div>
        </div>
        <div class="stock">${drug.stock}</div>
      `;
      panel.appendChild(card);
    });
  }

  document.getElementById("search-input").addEventListener("input", function () {
    const keyword = this.value.trim().toLowerCase();

    const filtered = loadedDrugs.filter(drug =>
      drug.name.toLowerCase().includes(keyword) ||
      drug.code.toLowerCase().includes(keyword) ||
      (FORM_TYPE_LABELS[drug.type] || drug.type).toLowerCase().includes(keyword)
    );

    renderInventoryCards(filtered);
  });

  async function loadInventoryLogs(drugId) {
    try {
      const res = await fetch(`/api/inventory/logs?drugId=${drugId}`);
      if (!res.ok) throw new Error("ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
      return await res.json();
    } catch (err) {
      console.error("ì…ì¶œê³  ë¡œê·¸ ì˜¤ë¥˜:", err);
      return [];
    }
  }

  async function showDetail(drug) {
    currentDrug = drug;
    isEditing = false;
    document.getElementById("manage-btn").textContent = "âš™ ì œí’ˆ ê´€ë¦¬";

    const detailPanel = document.getElementById("detail-panel");
    const typeLabel = FORM_TYPE_LABELS[drug.type] || drug.type;

    const logs = await loadInventoryLogs(drug.drugId);
    if (logs.length > 0) {
      drug.lastLogId = logs[0].logId;
    }

    const logRows = logs.length > 0 ? logs.map(log => `
      <tr>
        <td>${log.occurredAt?.slice(0, 10) || "-"}</td>
        <td>${log.changeType === 'IN' ? 'ì…ê³ ' : 'ì¶œê³ '}</td>
        <td>${log.quantity}</td>
        <td>${log.location || '-'}</td>
      </tr>
    `).join("") : `<tr><td colspan='4'>ì…ì¶œê³  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>`;

    detailPanel.innerHTML = `
      <div class="drug-info-card">
        <div class="title-row"><h2>${drug.name}</h2></div>
        <div class="info-grid" id="drug-info">
          <div class="info-item"><label>ì¢…ë¥˜</label><div>${typeLabel}</div></div>
          <div class="info-item"><label>ì•½í’ˆ ì½”ë“œ</label><div>${drug.code}</div></div>
          <div class="info-item"><label>ë³´ê´€ ìœ„ì¹˜</label><div>${drug.location}</div></div>
          <div class="info-item"><label>ì¬ê³ </label><div>${drug.stock}</div></div>
        </div>

        <div class="section-title">ì…ì¶œê³  ë‚´ì—­</div>
        <table class="log-table">
          <thead><tr><th>ë‚ ì§œ</th><th>êµ¬ë¶„</th><th>ìˆ˜ëŸ‰</th><th>ìœ„ì¹˜</th></tr></thead>
          <tbody>${logRows}</tbody>
        </table>

        <div class="button-group">
          <button onclick="openWithdrawModal()" class="withdraw-button">ì¶œê³ </button>
          <button onclick="openAddModal()" class="add-button">ì…ê³ </button>
        </div>
      </div>
    `;
  }

  function toggleEditMode() {
    const button = document.getElementById("manage-btn");
    if (!currentDrug) return alert("ë¨¼ì € ì•½í’ˆì„ ì„ íƒí•˜ì„¸ìš”.");

    if (!isEditing) {
      isEditing = true;
      button.textContent = "ğŸ’¾ ì œí’ˆ ì €ì¥";
      enterEditMode(currentDrug);
    } else {
      saveDrugChanges();
      isEditing = false;
      button.textContent = "âš™ ì œí’ˆ ê´€ë¦¬";
    }
  }

  function enterEditMode(drug) {
    const detailPanel = document.getElementById("detail-panel");

    detailPanel.innerHTML = `
      <div class="drug-info-card">
        <div class="title-row"><h2>${drug.name} ìˆ˜ì •</h2></div>
        <div class="info-grid" id="drug-info-edit">
          <div class="info-item"><label>ì¢…ë¥˜</label><input type="text" value="${drug.type}" /></div>
          <div class="info-item"><label>ì•½í’ˆ ì½”ë“œ</label><input type="text" value="${drug.code}" /></div>
          <div class="info-item"><label>ë³´ê´€ ìœ„ì¹˜</label><input type="text" value="${drug.location}" /></div>
          <div class="info-item"><label>ì¬ê³ </label><input type="number" value="${drug.stock}" /></div>
        </div>
      </div>
    `;
  }

  function saveDrugChanges() {
    const inputs = document.querySelectorAll("#drug-info-edit input");
    const updated = {
      location: inputs[2].value,
      stock: parseInt(inputs[3].value)
    };
    submitDrugEdit(updated);
  }

  async function submitDrugEdit(updated) {
    const logId = currentDrug.lastLogId;
    const { location, stock } = updated;

    if (!logId || isNaN(stock)) {
      alert("ì˜¬ë°”ë¥¸ ì…ë ¥ê°’ì´ ì•„ë‹™ë‹ˆë‹¤.");
      return;
    }

    const body = { logId, location, quantity: stock };

    try {
      const res = await fetch("/api/inventory/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        alert("ì œí’ˆ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadInventoryCards();
      } else {
        alert("ìˆ˜ì • ì‹¤íŒ¨");
      }
    } catch (e) {
      console.error("ìˆ˜ì • ìš”ì²­ ì‹¤íŒ¨", e);
    }
  }

  function openWithdrawModal() {
    if (!currentDrug) return;
    document.getElementById("withdraw-drug-name").innerText = currentDrug.name;
    document.getElementById("withdraw-current-stock").innerText = currentDrug.stock;
    document.getElementById("withdraw-amount").value = "";
    document.getElementById("withdraw-modal").style.display = "flex";
  }

  function closeWithdrawModal() {
    document.getElementById("withdraw-modal").style.display = "none";
    document.getElementById("withdraw-amount").value = "";
  }

  async function submitWithdraw() {
    const amount = parseInt(document.getElementById("withdraw-amount").value);
    const btn = event.target;

    if (isNaN(amount) || amount <= 0 || amount > currentDrug.stock) {
      alert("ì¶œê³  ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    btn.disabled = true;

    try {
      const res = await fetch("/api/inventory/withdraw", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ drugId: currentDrug.drugId, quantity: amount })
      });

      if (!res.ok) throw new Error("ì¶œê³  ìš”ì²­ ì‹¤íŒ¨");

      alert("ì¶œê³ ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      closeWithdrawModal();
      loadInventoryCards();
    } catch (e) {
      console.error(e);
      alert("ì¶œê³  ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    } finally {
      btn.disabled = false;
    }
  }

  function openAddModal() {
    if (!currentDrug) return;
    document.getElementById("add-drug-name").innerText = currentDrug.name;
    document.getElementById("add-current-stock").innerText = currentDrug.stock;
    document.getElementById("add-amount").value = "";
    document.getElementById("add-modal").style.display = "flex";
  }

  function closeAddModal() {
    document.getElementById("add-modal").style.display = "none";
    document.getElementById("add-amount").value = "";
  }

async function submitAdd() {
  const amount = parseInt(document.getElementById("add-amount").value);
  const btn = event.target;

  if (isNaN(amount) || amount <= 0) {
    alert("ì…ê³  ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  btn.disabled = true;

  try {
    const res = await fetch("/api/inventory/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        drugId: currentDrug.drugId,
        name: currentDrug.name,
        code: currentDrug.code,
        location: currentDrug.location,
        quantity: amount,
        type: currentDrug.type,  // "INTERNAL", "ë‚´ë³µì•½" ë“±
        changeType: "IN"
      })
    });

    if (!res.ok) throw new Error("ì…ê³  ìš”ì²­ ì‹¤íŒ¨");

    alert("ì…ê³ ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    closeAddModal();
    loadInventoryCards();
  } catch (e) {
    console.error(e);
    alert("ì…ê³  ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  } finally {
    btn.disabled = false;
  }
}

  
  function applyFilters() {
 
  const keyword = document.getElementById("search-input").value.trim().toLowerCase();
  const selectedLabel = document.getElementById("type-filter").options[
    document.getElementById("type-filter").selectedIndex
  ].text;
  const sortOption = document.getElementById("sort-filter")?.value || "name_asc"; // ì •ë ¬ ê¸°ë³¸ê°’
  const stockOnly = document.getElementById("stock-only").checked;
	
  let filtered = loadedDrugs.filter(drug =>
    (selectedLabel === "ì „ì²´" || (FORM_TYPE_LABELS[drug.type] || drug.type) === selectedLabel) &&
    (
      drug.name.toLowerCase().includes(keyword) ||
      drug.code.toLowerCase().includes(keyword) ||
      (FORM_TYPE_LABELS[drug.type] || drug.type).toLowerCase().includes(keyword)
    ) &&
     (!stockOnly || drug.stock > 0) 
  );

  switch (sortOption) {
    case "name_asc":
      filtered.sort((a, b) => a.name.localeCompare(b.name));
      break;
    case "name_desc":
      filtered.sort((a, b) => b.name.localeCompare(a.name));
      break;
    case "stock_desc":
      filtered.sort((a, b) => b.stock - a.stock);
      break;
    case "stock_asc":
      filtered.sort((a, b) => a.stock - b.stock);
      break;
  }

  renderInventoryCards(filtered);
}
  

  window.onload = function () {
  loadInventoryCards();

  document.getElementById("search-input").addEventListener("input", applyFilters);
  document.getElementById("type-filter").addEventListener("change", applyFilters);
  document.getElementById("sort-filter").addEventListener("change", applyFilters);
  document.getElementById("stock-only").addEventListener("change", applyFilters);
};


</script>
</body>
</html>
