<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê°„í˜¸ì‚¬ í™ˆ</title>
  <link rel="stylesheet" href="/css/NurseHomestyle.css" />
</head>
<body>
  <div class="container">
    <!-- ======================================= -->
    <!-- â† ì‚¬ì´ë“œë°”(ë¹¨ê°„ìƒ‰ ë™ê·¸ë¼ë¯¸ ë¶€ë¶„) -->
    <div class="sidebar">
      <!-- í”„ë¡œí•„ ì˜ì—­ -->
      <div class="profile">
        <div class="profile-icon">ğŸ‘¤</div>
        <span th:text="${userName}">ê°„í˜¸ì‚¬ ì´ë¦„</span>
      </div>

      <!-- ë©”ë‰´ í•­ëª©ë“¤ -->
      <a th:href="@{NurseHome}" class="menu-item active">
        <div class="menu-icon">ğŸ””</div>
        <span>ì•Œë¦¼</span>
      </a>
      <a th:href="@{VitalRecord}" class="menu-item">
        <div class="menu-icon">ğŸ’œ</div>
        <span>ë°”ì´íƒˆ ê¸°ë¡</span>
      </a>
      <a th:href="@{NurseChart}" class="menu-item">
        <div class="menu-icon">ğŸ“‹</div>
        <span>ì°¨íŠ¸</span>
      </a>
      <a th:href="@{MedicationRecord}" class="menu-item">
        <div class="menu-icon">ğŸ‘¥</div>
        <span>íˆ¬ì•½ ë° ì²˜ì¹˜ ê¸°ë¡</span>
      </a>
      <a th:href="@{/Login/Logout}" class="menu-item logout">
    <div class="menu-icon">ğŸšª</div>
    <span>ë¡œê·¸ì•„ì›ƒ</span>
</a>
    </div>
    <!-- ======================================= -->

    <!-- â†’ ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ (ì•Œë¦¼ + ì²´í¬ë¦¬ìŠ¤íŠ¸) -->
    <div class="main-content">
      <div class="content-area">

        <!-- ========================= ì•Œë¦¼ í—¤ë” ========================= -->
        <div class="notifications-header">
          <h3>ì•Œë¦¼</h3>
          <!-- ì•Œë¦¼ ê²€ìƒ‰ í•„í„° -->
          <div class="notif-controls">
            <input
              type="text"
              id="notifSearch"
              class="notif-search"
              placeholder="ì•Œë¦¼ ê²€ìƒ‰..."
              onkeyup="filterNotifications()"
            />
            <button id="markAllReadBtn" class="btn-sm">ì „ì²´ ì½ìŒ ì²˜ë¦¬</button>
          </div>
        </div>

        <!-- ========================= ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ (ìµœëŒ€ 10ê°œ) ========================= -->
        <ul id="notificationList" class="notification-list">
          <!-- ì—¬ê¸°ëŠ” JavaScript ë¡œë”© ì‹œ ì™„ì „íˆ ë¹„ì›Œë‘ê³ , JSì—ì„œ ë™ì ìœ¼ë¡œ <li> ì±„ìš°ê¸° -->
        </ul>

        <!-- ========================= ì²´í¬ë¦¬ìŠ¤íŠ¸ í—¤ë” ========================= -->
        <div class="checklist-header">
          <h3>ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
          <button id="addChecklistBtn" class="btn-sm">ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±</button>
        </div>

        <!-- ========================= ì²´í¬ë¦¬ìŠ¤íŠ¸ ========================= -->
        <ul id="checklist" class="checklist">
          
        </ul>

      </div>
    </div>
  </div>

  <!-- ========================= JavaScript ë¡œì§ ========================= -->
  <script th:inline="javascript">
  /*<![CDATA[*/
  // ì„¸ì…˜ì—ì„œ model.addAttribute("usersId", loginUser.getUsersId()); ë¡œ ë„˜ê²¨ì˜¨ ê°’
  const nurseId = /*[[${usersId}]]*/ "nurse1";
  /*]]>*/

  document.addEventListener("DOMContentLoaded", () => {
    fetchNotifications();
    document.getElementById("markAllReadBtn")
            .addEventListener("click", markAllAsRead);
    document.getElementById("addChecklistBtn")
            .addEventListener("click", addChecklistItem);
  });

  /**
   * 1) ê°„í˜¸ì‚¬(nurseId)ì˜ ì•Œë¦¼ì„ ë°›ì•„ì™€ì„œ <ul id="notificationList">ì— ë Œë”ë§
   */
  function fetchNotifications() {
    fetch(`/api/notif/${nurseId}`)
      .then(res => res.json())
      .then(data => {
        const listEl = document.getElementById("notificationList");
        listEl.innerHTML = "";

        if (!data || data.length === 0) {
          // ì•Œë¦¼ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ë¹ˆ ìŠ¬ë¡¯ ëŒ€ì‹  â€œì•Œë¦¼ ì—†ìŒâ€ë§Œ ë³´ì—¬ì¤€ë‹¤
          const li = document.createElement("li");
          li.className = "notification-item empty";
          li.innerHTML = `
            <div class="notif-left">
              <span class="notif-text">ì•Œë¦¼ ì—†ìŒ</span>
            </div>
          `;
          listEl.appendChild(li);
          return;
        }

        data.forEach(item => {
          const li = document.createElement("li");
          // â˜… ì—¬ê¸°ì„œ item.read ë¥¼ ì‚¬ìš© â˜…
          const cls = item.read ? "read" : "unread";
          li.className = `notification-item ${cls}`;
          li.setAttribute("data-notif-id", item.notifId);

          // ì•„ì´ì½˜, ì‹œê°„ ë¬¸ìì—´ ìƒì„±
          const icon = "â°";
          const d = new Date(item.createdAt);
          const hh = d.getHours();
          const mm = ("0" + d.getMinutes()).slice(-2);
          const timeText = `${hh}:${mm}`;

          // ì½ìŒ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì œê±°
          let readButtonHtml = "";
          if (!item.read) {
            readButtonHtml = `<button class="mark-read"
                                onclick="markAsRead(${item.notifId}, this)">
                                ì½ìŒ
                              </button>`;
          }

          li.innerHTML = `
            <div class="notif-left">
              <span class="notif-icon">${icon}</span>
              <span class="notif-text">${item.message}</span>
            </div>
            <div class="notif-right">
              <span class="time">${timeText}</span>
              ${readButtonHtml}
            </div>
          `;
          listEl.appendChild(li);
        });
      })
      .catch(err => console.error(err));
  }

  /**
   * 2) ê°œë³„ ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ (PATCH /api/notif/read/{notifId})
   */
  function markAsRead(notifId, btn) {
    fetch(`/api/notif/read/${notifId}`, { method: "PATCH" })
      .then(() => {
        const li = btn.closest(".notification-item");
        li.classList.remove("unread");
        li.classList.add("read");
        btn.remove(); // ë²„íŠ¼ ì œê±°
      })
      .catch(err => console.error(err));
  }

  /**
   * 3) ì „ì²´ ì½ìŒ ì²˜ë¦¬ (POST /api/notif/mark-all-read)
   */
  function markAllAsRead() {
    fetch(`/api/notif/mark-all-read`, { method: "POST" })
      .then(() => {
        // ì„±ê³µí•˜ë©´ í™”ë©´ì— ë‚¨ì•„ ìˆëŠ” ëª¨ë“  unread í•­ëª©ì— ëŒ€í•´ ë²„íŠ¼ ì œê±°
        document.querySelectorAll(".notification-item.unread").forEach(li => {
          li.classList.remove("unread");
          li.classList.add("read");
          const btn = li.querySelector(".mark-read");
          if (btn) btn.remove();
        });
      })
      .catch(err => console.error(err));
  }

  /**
   * 4) ì•Œë¦¼ ê²€ìƒ‰ í•„í„° (keyup ì´ë²¤íŠ¸)
   */
  function filterNotifications() {
    const input = document.getElementById("notifSearch");
    const filter = input.value.toLowerCase();
    document.querySelectorAll(".notification-item").forEach(li => {
      const textNode = li.querySelector(".notif-text");
      if (!textNode) return;
      const txt = textNode.innerText.toLowerCase();
      li.style.display = txt.includes(filter) ? "" : "none";
    });
  }

  /**
   * 5) ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ
   */
  function addChecklistItem() {
    const name = prompt("ìƒˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if (name && name.trim()) {
      const ul = document.getElementById("checklist");
      const id = "task" + Date.now();
      const li = document.createElement("li");
      li.className = "checklist-item";
      li.innerHTML = `
        <input type="checkbox" id="${id}" />
        <label for="${id}">${name}</label>
        <button class="delete-task" onclick="deleteTask(this)">ì‚­ì œ</button>
      `;
      ul.appendChild(li);
    }
  }

  /**
   * 6) ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì‚­ì œ
   */
  function deleteTask(btn) {
    btn.closest(".checklist-item").remove();
  }
</script>
</body>
</html>
