<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê°„í˜¸ì‚¬ í™ˆ</title>
  <link rel="stylesheet" href="/css/NurseHomestyle.css" />
</head>
<body>
  <div class="container">
    <!-- ======================================= -->
    <!-- â† ì‚¬ì´ë“œë°”(ë¹¨ê°„ìƒ‰ ë™ê·¸ë¼ë¯¸ ë¶€ë¶„) -->
    <div class="sidebar">
      <!-- í”„ë¡œí•„ ì˜ì—­ -->
      <div class="profile">
        <div class="profile-icon">ğŸ‘¤</div>
        <span th:text="${userName}">ê°„í˜¸ì‚¬ ì´ë¦„</span>
      </div>

      <!-- ë©”ë‰´ í•­ëª©ë“¤ -->
      <a th:href="@{NurseHome}" class="menu-item active">
        <div class="menu-icon">ğŸ””</div>
        <span>ì•Œë¦¼</span>
      </a>
      <a th:href="@{VitalRecord}" class="menu-item">
        <div class="menu-icon">ğŸ’œ</div>
        <span>ë°”ì´íƒˆ ê¸°ë¡</span>
      </a>
      <a th:href="@{NurseChart}" class="menu-item">
        <div class="menu-icon">ğŸ“‹</div>
        <span>ì°¨íŠ¸</span>
      </a>
      <a th:href="@{MedicationRecord}" class="menu-item">
        <div class="menu-icon">ğŸ’Š</div>
        <span>íˆ¬ì•½ ë° ì²˜ì¹˜ ê¸°ë¡</span>
      </a>
      <a th:href="@{/Login/Logout}" class="menu-item">
        <div class="menu-icon">ğŸšª</div>
        <span>ë¡œê·¸ì•„ì›ƒ</span>
      </a>
    </div>
    <!-- ======================================= -->

    <!-- â†’ ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ (ì•Œë¦¼ + ì²´í¬ë¦¬ìŠ¤íŠ¸) -->
    <div class="main-content">
      <div class="content-area">

        <!-- ========================= ì•Œë¦¼ í—¤ë” ========================= -->
        <div class="notifications-header">
          <h3>ì•Œë¦¼</h3>
          <!-- ì•Œë¦¼ ê²€ìƒ‰ í•„í„° -->
          <div class="notif-controls">
            <input
              type="text"
              id="notifSearch"
              class="notif-search"
              placeholder="ì•Œë¦¼ ê²€ìƒ‰..."
              onkeyup="filterNotifications()"
            />
            <button id="markAllReadBtn" class="btn-sm">ì „ì²´ ì½ìŒ ì²˜ë¦¬</button>
          </div>
        </div>

        <!-- ========================= ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ (ìµœëŒ€ 10ê°œ) ========================= -->
        <ul id="notificationList" class="notification-list">
          <!-- ì—¬ê¸°ëŠ” JavaScript ë¡œë”© ì‹œ ì™„ì „íˆ ë¹„ì›Œë‘ê³ , JSì—ì„œ ë™ì ìœ¼ë¡œ <li> ì±„ìš°ê¸° -->
        </ul>

        <!-- ========================= ì²´í¬ë¦¬ìŠ¤íŠ¸ í—¤ë” ========================= -->
        <div class="checklist-header">
          <h3>ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
          <button id="addChecklistBtn" class="btn-sm">ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±</button>
        </div>

        <!-- ========================= ì²´í¬ë¦¬ìŠ¤íŠ¸ ========================= -->
        <ul id="checklist" class="checklist">
          
        </ul>

      </div>
    </div>
  </div>

  <!-- ========================= JavaScript ë¡œì§ ========================= -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    const nurseId = /*[[${usersId}]]*/ "nurse1";
    /*]]>*/

    document.addEventListener("DOMContentLoaded", () => {
      fetchNotifications();
    });

    function fetchNotifications() {
      fetch(`/api/notif/${nurseId}`)
        .then((res) => res.json())
        .then((data) => {
          const listEl = document.getElementById("notificationList");
          listEl.innerHTML = "";
          for (let i = 0; i < 10; i++) {
            const item = data[i];
            const li = document.createElement("li");
            if (item) {
              const cls = item.isRead ? "read" : "unread";
              li.className = `notification-item ${cls}`;
              li.setAttribute("data-notif-id", item.notifId);
              const icon = "â°";
              const d = new Date(item.createdAt);
              const hh = d.getHours();
              const mm = ("0" + d.getMinutes()).slice(-2);
              const timeText = `${hh}:${mm}`;
              li.innerHTML = `
                <div class="notif-left">
                  <span class="notif-icon">${icon}</span>
                  <span class="notif-text">${item.message}</span>
                </div>
                <div class="notif-right">
                  <span class="time">${timeText}</span>
                  ${
                    item.isRead
                      ? ""
                      : `<button class="mark-read" onclick="markAsRead(${item.notifId}, this)">ì½ìŒ</button>`
                  }
                </div>
              `;
            } else {
              li.className = "notification-item empty";
              li.innerHTML = `
                <div class="notif-left">
                  <span class="notif-text">ì•Œë¦¼ ì—†ìŒ</span>
                </div>
              `;
            }
            listEl.appendChild(li);
          }
        })
        .catch((err) => console.error(err));
    }

    function markAsRead(notifId, btn) {
      fetch(`/api/notif/read/${notifId}`, { method: "PATCH" })
        .then(() => {
          const li = btn.closest(".notification-item");
          li.classList.remove("unread");
          li.classList.add("read");
          btn.remove();
        })
        .catch((err) => console.error(err));
    }

    document.getElementById("markAllReadBtn").addEventListener("click", () => {
      fetch(`/api/notif/${nurseId}`)
        .then((res) => res.json())
        .then((data) => {
          const unread = data.filter((it) => !it.isRead);
          return Promise.all(
            unread.map((it) =>
              fetch(`/api/notif/read/${it.notifId}`, { method: "PATCH" })
            )
          );
        })
        .then(() => {
          document
            .querySelectorAll(".notification-item.unread")
            .forEach((li) => {
              li.classList.remove("unread");
              li.classList.add("read");
              const btn = li.querySelector(".mark-read");
              if (btn) btn.remove();
            });
        })
        .catch((err) => console.error(err));
    });

    function filterNotifications() {
      const input = document.getElementById("notifSearch");
      const filter = input.value.toLowerCase();
      document.querySelectorAll(".notification-item").forEach((li) => {
        const textNode = li.querySelector(".notif-text");
        if (!textNode) return;
        const txt = textNode.innerText.toLowerCase();
        li.style.display = txt.includes(filter) ? "" : "none";
      });
    }

    document.getElementById("addChecklistBtn").addEventListener("click", () => {
      const name = prompt("ìƒˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
      if (name && name.trim()) {
        const ul = document.getElementById("checklist");
        const id = "task" + Date.now();
        const li = document.createElement("li");
        li.className = "checklist-item";
        li.innerHTML = `
          <input type="checkbox" id="${id}" />
          <label for="${id}">${name}</label>
          <button class="delete-task" onclick="deleteTask(this)">ì‚­ì œ</button>
        `;
        ul.appendChild(li);
      }
    });

    function deleteTask(btn) {
      btn.closest(".checklist-item").remove();
    }
  </script>
</body>
</html>
