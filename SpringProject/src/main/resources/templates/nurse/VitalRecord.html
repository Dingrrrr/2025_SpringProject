<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바이탈 기록 대시보드</title>
       <link rel="stylesheet" href="/css/VitalRecordstyle.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <!-- 사이드바 -->
    <div class="sidebar">
        <div class="profile">
            <div class="profile-icon">👤</div>
            <span>내 프로필</span>
        </div>
        
        <a href="NurseHome" class="menu-item">
            <div class="menu-icon">🔔</div>
            <span>알림</span>
        </a>
          
        <a href="VitalRecord" class="menu-item active">
            <div class="menu-icon">💜</div>
            <span>바이탈 기록</span>
        </a>
                     
        <a href="NurseChart" class="menu-item">
            <div class="menu-icon">📋</div>
            <span>차트</span>
        </a>
        
        <a href="MedicationRecord" class="menu-item">
            <div class="menu-icon">👥</div>
            <span>투약 및 처치 기록</span>
        </a>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="main-content">
        <!-- 헤더 -->
        <div class="header">
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="환자 검색" id="patientSearch">
                <button class="search-btn" onclick="searchPatient()">🔍</button>
            </div>
            <div class="patient-info" id="patientName">환자를 선택해주세요</div>
            <div class="patient-details" id="patientDetails">환자 정보가 표시됩니다</div>
        </div>

        <!-- 최신 바이탈 요약 -->
        <div class="vital-summary">
            <div class="vital-card">
                <div class="vital-value" id="latestBP">-/-</div>
                <div class="vital-label">혈압 (mmHg)</div>
                <div class="vital-time" id="bpTime">-</div>
            </div>
            <div class="vital-card">
                <div class="vital-value" id="latestPulse">-</div>
                <div class="vital-label">맥박 (bpm)</div>
                <div class="vital-time" id="pulseTime">-</div>
            </div>
            <div class="vital-card">
                <div class="vital-value" id="latestTemp">-</div>
                <div class="vital-label">체온 (°C)</div>
                <div class="vital-time" id="tempTime">-</div>
            </div>
            <div class="vital-card">
                <div class="vital-value" id="latestResp">-</div>
                <div class="vital-label">호흡수 (/분)</div>
                <div class="vital-time" id="respTime">-</div>
            </div>
        </div>

        <!-- 대시보드 그리드 -->
        <div class="dashboard-grid">
            <!-- 혈압 추이 -->
            <div class="chart-card">
                <h3>
                    혈압 추이
                    <div class="chart-options">
                        <span class="chart-option active" onclick="updateBPChart('time')">시간별</span>
                        <span class="chart-option" onclick="updateBPChart('weekly')">주간별</span>
                    </div>
                </h3>
                <div class="chart-container">
                    <canvas id="bloodPressureChart"></canvas>
                </div>
            </div>

            <!-- 맥박수 -->
            <div class="chart-card">
                <h3>
                    맥박수 (시간대별)
                </h3>
                <div class="chart-container">
                    <canvas id="pulseRateChart"></canvas>
                </div>
            </div>

            <!-- 체온 및 호흡 분석 -->
            <div class="chart-card">
                <h3>
                    체온 및 호흡 분석
                    <div class="chart-options">
                        <span class="chart-option active" onclick="updateTempRespChart('time')">시간별</span>
                        <span class="chart-option" onclick="updateTempRespChart('weekly')">주간별</span>
                    </div>
                </h3>
                <div class="chart-container">
                    <canvas id="tempRespChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentPatientId = null;
        let charts = {};

        // Chart.js 기본 설정
        Chart.defaults.font.family = 'Malgun Gothic';
        Chart.defaults.font.size = 12;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            // 샘플 데이터로 차트 초기화 (실제로는 DB에서 데이터를 가져옴)
            loadSampleData();
        });

        // 차트 초기화
        function initializeCharts() {
            // 혈압 추이 차트
            const bloodPressureCtx = document.getElementById('bloodPressureChart').getContext('2d');
            charts.bloodPressure = new Chart(bloodPressureCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '수축기압 (bp_systolic)',
                        data: [],
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: '이완기압 (bp_diastolic)',
                        data: [],
                        borderColor: '#64b5f6',
                        backgroundColor: 'rgba(100, 181, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 50,
                            max: 200
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // 맥박수 모니터링 차트 (시간대별 고정)
            const pulseRateCtx = document.getElementById('pulseRateChart').getContext('2d');
            charts.pulseRate = new Chart(pulseRateCtx, {
                type: 'bar',
                data: {
                    labels: ['아침', '점심', '저녁', '야간'],
                    datasets: [{
                        label: '맥박수 (pulse_rate)',
                        data: [],
                        backgroundColor: ['#81c784', '#64b5f6', '#ffb74d', '#f06292'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 120
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // 체온 및 호흡 분석 차트
            const tempRespCtx = document.getElementById('tempRespChart').getContext('2d');
            charts.tempResp = new Chart(tempRespCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '체온 (temperature)',
                        data: [],
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4
                    }, {
                        label: '호흡수 (respiration_rate)',
                        data: [],
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 35,
                            max: 42,
                            title: {
                                display: true,
                                text: '체온 (°C)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 10,
                            max: 30,
                            title: {
                                display: true,
                                text: '호흡수 (/분)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 환자 검색 함수
        function searchPatient() {
            const searchValue = document.getElementById('patientSearch').value;
            if (searchValue.trim()) {
                // 실제 DB 연동 시에는 patient_id로 검색
                loadPatientData(searchValue);
            }
        }

        // 환자 데이터 로드 (DB 연동 함수)
        function loadPatientData(patientQuery) {
            // 실제 DB 연동 코드 예시:
            /*
            fetch('/api/patient/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: patientQuery })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentPatientId = data.patient.patient_id;
                    updatePatientInfo(data.patient);
                    loadVitalRecords(currentPatientId);
                }
            });
            */
            
            // 샘플 데이터로 테스트
            currentPatientId = 'P001';
            updatePatientInfo({
                patient_id: 'P001',
                name: patientQuery,
                gender: '남',
                birth_date: '2000-08-04',
                phone: '010-7462-6853'
            });
            loadVitalRecords(currentPatientId);
        }

        // 환자 정보 업데이트
        function updatePatientInfo(patient) {
            document.getElementById('patientName').textContent = patient.name + ' 환자';
            document.getElementById('patientDetails').textContent = 
                `성별:${patient.gender} 생년월일:${patient.birth_date} 전화번호:${patient.phone}`;
        }

        // 바이탈 기록 로드 (DB 연동 함수)
        function loadVitalRecords(patientId) {
            // 실제 DB 연동 코드 예시:
            /*
            fetch(`/api/vital-records/${patientId}`)
            .then(response => response.json())
            .then(data => {
                updateVitalSummary(data.latest);
                updateAllCharts(data.records);
            });
            */
            
            // 샘플 데이터로 테스트
            loadSampleVitalData();
        }

        // 최신 바이탈 요약 업데이트
        function updateVitalSummary(latestVital) {
            if (latestVital) {
                document.getElementById('latestBP').textContent = 
                    `${latestVital.bp_systolic}/${latestVital.bp_diastolic}`;
                document.getElementById('latestPulse').textContent = latestVital.pulse_rate;
                document.getElementById('latestTemp').textContent = latestVital.temperature.toFixed(1);
                document.getElementById('latestResp').textContent = latestVital.respiration_rate;
                
                const recordTime = new Date(latestVital.recorded_at).toLocaleString('ko-KR');
                document.getElementById('bpTime').textContent = recordTime;
                document.getElementById('pulseTime').textContent = recordTime;
                document.getElementById('tempTime').textContent = recordTime;
                document.getElementById('respTime').textContent = recordTime;
            }
        }

        // 혈압 차트 업데이트
        function updateBPChart(period) {
            setActiveOption(event.target);
            if (period === 'time') {
                // 시간별 (아침, 점심, 저녁, 야간)
                charts.bloodPressure.data.labels = ['아침', '점심', '저녁', '야간'];
                // 실제로는 DB에서 시간대별 데이터를 가져옴
            } else if (period === 'weekly') {
                // 주간별
                charts.bloodPressure.data.labels = ['월', '화', '수', '목', '금', '토', '일'];
                // 실제로는 DB에서 주간별 데이터를 가져옴
            }
            charts.bloodPressure.update();
        }

        // 체온/호흡 차트 업데이트
        function updateTempRespChart(period) {
            setActiveOption(event.target);
            if (period === 'time') {
                // 시간별 (아침, 점심, 저녁, 야간)
                charts.tempResp.data.labels = ['아침', '점심', '저녁', '야간'];
                // 실제로는 DB에서 시간대별 데이터를 가져옴
            } else if (period === 'weekly') {
                // 주간별
                charts.tempResp.data.labels = ['월', '화', '수', '목', '금', '토', '일'];
                // 실제로는 DB에서 주간별 데이터를 가져옴
            }
            charts.tempResp.update();
        }

        // 활성 옵션 설정
        function setActiveOption(clickedElement) {
            const parent = clickedElement.parentElement;
            parent.querySelectorAll('.chart-option').forEach(opt => opt.classList.remove('active'));
            clickedElement.classList.add('active');
        }

        // 샘플 데이터 로드 함수
        function loadSampleData() {
            // 샘플 환자 데이터 로드
            updatePatientInfo({
                patient_id: 'P001',
                name: '민규짱',
                gender: '남',
                birth_date: '2000-08-04',
                phone: '010-7462-6853'
            });
            
            loadSampleVitalData();
        }

        function loadSampleVitalData() {
            // 최신 바이탈 데이터 샘플
            const latestVital = {
                bp_systolic: 125,
                bp_diastolic: 82,
                pulse_rate: 78,
                temperature: 36.7,
                respiration_rate: 18,
                recorded_at: new Date().toISOString()
            };
            updateVitalSummary(latestVital);

            // 차트 데이터 샘플 (시간대별 기본)
            const sampleData = {
                bloodPressure: {
                    timeLabels: ['아침', '점심', '저녁', '야간'],
                    timeSystolic: [120, 125, 118, 132],
                    timeDiastolic: [80, 82, 78, 85],
                    weeklyLabels: ['월', '화', '수', '목', '금', '토', '일'],
                    weeklySystolic: [120, 125, 118, 132, 128, 122, 130],
                    weeklyDiastolic: [80, 82, 78, 85, 83, 79, 84]
                },
                pulseRate: {
                    timeData: [72, 85, 78, 68] // 아침, 점심, 저녁, 야간
                },
                tempResp: {
                    timeLabels: ['아침', '점심', '저녁', '야간'],
                    timeTemperature: [36.5, 36.8, 37.1, 36.6],
                    timeRespiration: [16, 17, 20, 17],
                    weeklyLabels: ['월', '화', '수', '목', '금', '토', '일'],
                    weeklyTemperature: [36.5, 36.7, 36.8, 37.1, 36.9, 36.6, 36.4],
                    weeklyRespiration: [16, 18, 17, 20, 19, 17, 15]
                }
            };

            // 차트 업데이트 (기본값: 시간별)
            charts.bloodPressure.data.labels = sampleData.bloodPressure.timeLabels;
            charts.bloodPressure.data.datasets[0].data = sampleData.bloodPressure.timeSystolic;
            charts.bloodPressure.data.datasets[1].data = sampleData.bloodPressure.timeDiastolic;
            charts.bloodPressure.update();

            charts.pulseRate.data.datasets[0].data = sampleData.pulseRate.timeData;
            charts.pulseRate.update();

            charts.tempResp.data.labels = sampleData.tempResp.timeLabels;
            charts.tempResp.data.datasets[0].data = sampleData.tempResp.timeTemperature;
            charts.tempResp.data.datasets[1].data = sampleData.tempResp.timeRespiration;
            charts.tempResp.update();
        }

        // 메뉴 클릭 이벤트
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });
    </script>
</body>
</html>