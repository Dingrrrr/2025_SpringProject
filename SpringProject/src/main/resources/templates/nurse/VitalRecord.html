<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°”ì´íƒˆ ê¸°ë¡ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="/css/VitalRecordstyle.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <div class="profile">
            <div class="profile-icon">ğŸ‘¤</div>
            <span>ë‚´ í”„ë¡œí•„</span>
        </div>
        
        <a href="NurseHome" class="menu-item">
            <div class="menu-icon">ğŸ””</div>
            <span>ì•Œë¦¼</span>
        </a>
          
        <a href="VitalRecord" class="menu-item active">
            <div class="menu-icon">ğŸ’œ</div>
            <span>ë°”ì´íƒˆ ê¸°ë¡</span>
        </a>
                     
        <a href="NurseChart" class="menu-item">
            <div class="menu-icon">ğŸ“‹</div>
            <span>ì°¨íŠ¸</span>
        </a>
        
        <a href="MedicationRecord" class="menu-item">
            <div class="menu-icon">ğŸ‘¥</div>
            <span>íˆ¬ì•½ ë° ì²˜ì¹˜ ê¸°ë¡</span>
        </a>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="main-content">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="search-bar" style="position: relative;">
                <input type="text" class="search-input" placeholder="í™˜ì ê²€ìƒ‰" id="patientSearch">
                <button class="search-btn" onclick="searchPatient()">ğŸ”</button>
                <!-- ê²€ìƒ‰ ê²°ê³¼ ë“œë¡­ë‹¤ìš´ -->
                <div class="search-dropdown" id="search-dropdown" style="display: none;"></div>
            </div>
            <div class="patient-info" id="patientName">í™˜ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            <div class="patient-details" id="patientDetails">í™˜ì ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
        </div>

        <!-- ìµœì‹  ë°”ì´íƒˆ ìš”ì•½ -->
        <div class="vital-summary">
            <div class="vital-card">
                <div class="vital-value" id="latestBP">-/-</div>
                <div class="vital-label">í˜ˆì•• (mmHg)</div>
                <div class="vital-time" id="bpTime">-</div>
            </div>
            <div class="vital-card">
                <div class="vital-value" id="latestPulse">-</div>
                <div class="vital-label">ë§¥ë°• (bpm)</div>
                <div class="vital-time" id="pulseTime">-</div>
            </div>
            <div class="vital-card">
                <div class="vital-value" id="latestTemp">-</div>
                <div class="vital-label">ì²´ì˜¨ (Â°C)</div>
                <div class="vital-time" id="tempTime">-</div>
            </div>
            <div class="vital-card">
                <div class="vital-value" id="latestResp">-</div>
                <div class="vital-label">í˜¸í¡ìˆ˜ (/ë¶„)</div>
                <div class="vital-time" id="respTime">-</div>
            </div>
        </div>

        <!-- í˜„ì¬ ì‹œê°„ëŒ€ í‘œì‹œ -->
        <div style="text-align: center; margin: 20px 0; padding: 10px; background: #f5f5f5; border-radius: 8px;">
            <div style="font-size: 18px; font-weight: bold;" id="currentTimePeriod">
                <span id="timePeriodIcon">â°</span>
                <span id="timePeriodText">í˜„ì¬ ì‹œê°„ëŒ€</span>
                <span style="margin-left: 10px; font-size: 14px; color: #666;" id="currentTime"></span>
            </div>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ -->
        <div class="dashboard-grid">
            <!-- í˜ˆì•• ì¶”ì´ -->
            <div class="chart-card">
                <h3>
                    í˜ˆì•• ì¶”ì´
                    <div class="chart-options">
                        <span class="chart-option active" onclick="updateBPChart('time')">ì‹œê°„ë³„</span>
                        <span class="chart-option" onclick="updateBPChart('weekly')">ì£¼ê°„ë³„</span>
                    </div>
                </h3>
                <div class="chart-container">
                    <canvas id="bloodPressureChart"></canvas>
                </div>
            </div>

            <!-- ë§¥ë°•ìˆ˜ -->
            <div class="chart-card">
                <h3>ë§¥ë°•ìˆ˜ (ì‹œê°„ëŒ€ë³„)</h3>
                <div class="chart-container">
                    <canvas id="pulseRateChart"></canvas>
                </div>
            </div>

            <!-- ì²´ì˜¨ ë° í˜¸í¡ ë¶„ì„ -->
            <div class="chart-card">
                <h3>
                    ì²´ì˜¨ ë° í˜¸í¡ ë¶„ì„
                    <div class="chart-options">
                        <span class="chart-option active" onclick="updateTempRespChart('time')">ì‹œê°„ë³„</span>
                        <span class="chart-option" onclick="updateTempRespChart('weekly')">ì£¼ê°„ë³„</span>
                    </div>
                </h3>
                <div class="chart-container">
                    <canvas id="tempRespChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentPatientId = null;
        let charts = {};
        let patients = {}; // NurseChartì™€ ë™ì¼í•œ êµ¬ì¡°
        let vitalChartData = {};

        // Chart.js ê¸°ë³¸ ì„¤ì •
        Chart.defaults.font.family = 'Malgun Gothic';
        Chart.defaults.font.size = 12;

        // í˜„ì¬ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ì‹œê°„ëŒ€ ê²°ì • í•¨ìˆ˜
        function getCurrentTimePeriod() {
            const now = new Date();
            const hour = now.getHours();
            
            if (hour >= 6 && hour < 12) {
                return 'ì•„ì¹¨';
            } else if (hour >= 12 && hour < 18) {
                return 'ì ì‹¬';
            } else if (hour >= 18 && hour < 24) {
                return 'ì €ë…';
            } else { // 0-5ì‹œ
                return 'ì•¼ê°„';
            }
        }

        // ì‹œê°„ëŒ€ë³„ ìƒ‰ìƒ ë°˜í™˜ í•¨ìˆ˜
        function getTimePeriodColor(timePeriod) {
            const colors = {
                'ì•„ì¹¨': '#81c784',
                'ì ì‹¬': '#64b5f6', 
                'ì €ë…': '#ffb74d',
                'ì•¼ê°„': '#f06292'
            };
            return colors[timePeriod] || '#9e9e9e';
        }

        // ì‹œê°„ëŒ€ë³„ ì•„ì´ì½˜ ë°˜í™˜ í•¨ìˆ˜
        function getTimePeriodIcon(timePeriod) {
            const icons = {
                'ì•„ì¹¨': 'ğŸŒ…',
                'ì ì‹¬': 'â˜€ï¸',
                'ì €ë…': 'ğŸŒ†', 
                'ì•¼ê°„': 'ğŸŒ™'
            };
            return icons[timePeriod] || 'â°';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘...');
            initializeCharts();
            fetchInpatients(); // NurseChartì™€ ë™ì¼í•œ í™˜ì ë°ì´í„° ë¡œë“œ
            updateCurrentTimePeriod(); // í˜„ì¬ ì‹œê°„ëŒ€ í‘œì‹œ
            
            // 1ë¶„ë§ˆë‹¤ í˜„ì¬ ì‹œê°„ëŒ€ ì—…ë°ì´íŠ¸
            setInterval(updateCurrentTimePeriod, 60000);
        });

        // í˜„ì¬ ì‹œê°„ëŒ€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCurrentTimePeriod() {
            const currentPeriod = getCurrentTimePeriod();
            const now = new Date();
            
            document.getElementById('timePeriodIcon').textContent = getTimePeriodIcon(currentPeriod);
            document.getElementById('timePeriodText').textContent = `í˜„ì¬ ì‹œê°„ëŒ€: ${currentPeriod}`;
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // ì‹œê°„ëŒ€ë³„ ìƒ‰ìƒ ì ìš©
            const timePeriodDiv = document.getElementById('currentTimePeriod');
            timePeriodDiv.style.color = getTimePeriodColor(currentPeriod);
        }

        // ì…ì› í™˜ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (NurseChartì™€ ë™ì¼)
        async function fetchInpatients() {
            try {
                console.log('ì…ì› í™˜ì ë°ì´í„° ìš”ì²­ ì‹œì‘...');
                const response = await fetch('/nurse/api/patients/inpatients');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const patientList = await response.json();
                console.log('ë°›ì•„ì˜¨ í™˜ì ë°ì´í„°:', patientList);
                
                // ë°°ì—´ì„ ê°ì²´ë¡œ ë³€í™˜
                patients = {};
                patientList.forEach(patient => {
                    patients[patient.patient_id] = {
                        name: patient.patient_name,
                        gender: patient.patient_gender,
                        birth: patient.patient_birth,
                        phone: patient.patient_phone
                    };
                });
                
                console.log('ì…ì› í™˜ì ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', Object.keys(patients).length + 'ëª…');
                
            } catch (error) {
                console.error('í™˜ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                console.log('ìƒ˜í”Œ ë°ì´í„°ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.');
                
                // ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
                patients = {
                    1: { name: 'ê¹€ë¯¼ìˆ˜', gender: 'ë‚¨', birth: '1990-01-15', phone: '010-1234-5678' },
                    2: { name: 'ì´ì˜í¬', gender: 'ì—¬', birth: '1985-05-20', phone: '010-9876-5432' },
                    3: { name: 'ë°•ì² ìˆ˜', gender: 'ë‚¨', birth: '1992-12-03', phone: '010-5555-7777' }
                };
                console.log('ìƒ˜í”Œ í™˜ì ë°ì´í„° ë¡œë“œ:', Object.keys(patients).length + 'ëª…');
            }
        }

        // í™˜ì ê²€ìƒ‰ ê¸°ëŠ¥
        function searchPatient() {
            const searchTerm = document.getElementById('patientSearch').value.toLowerCase().trim();
            console.log('ê²€ìƒ‰ì–´:', searchTerm);
            console.log('í™˜ì ë°ì´í„°:', patients);
            
            if (searchTerm === '') {
                document.getElementById('search-dropdown').style.display = 'none';
                return;
            }
            
            // í™˜ì ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ì²˜ë¦¬
            if (!patients || Object.keys(patients).length === 0) {
                console.log('í™˜ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œë“œë¥¼ ì‹œë„í•©ë‹ˆë‹¤.');
                fetchInpatients().then(() => {
                    if (Object.keys(patients).length > 0) {
                        searchPatient(); // ë°ì´í„° ë¡œë“œ í›„ ë‹¤ì‹œ ê²€ìƒ‰
                    }
                });
                return;
            }
            
            // ê²€ìƒ‰ ê²°ê³¼ í•„í„°ë§
            const searchResults = Object.entries(patients).filter(([id, patient]) => {
                return patient.name.toLowerCase().includes(searchTerm) ||
                       patient.gender.toLowerCase().includes(searchTerm) ||
                       patient.birth.includes(searchTerm) ||
                       patient.phone.includes(searchTerm);
            });
            
            console.log('ê²€ìƒ‰ ê²°ê³¼:', searchResults);
            displaySearchResults(searchResults);
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(results) {
            const dropdown = document.getElementById('search-dropdown');
            dropdown.innerHTML = '';
            
            if (results.length === 0) {
                const noResult = document.createElement('div');
                noResult.style.padding = '10px';
                noResult.style.textAlign = 'center';
                noResult.style.color = '#666';
                noResult.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
                dropdown.appendChild(noResult);
            } else {
                results.forEach(([id, patient]) => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.style.cssText = `
                        padding: 10px;
                        cursor: pointer;
                        border-bottom: 1px solid #eee;
                        transition: background-color 0.2s;
                    `;
                    
                    resultItem.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 4px;">${patient.name}</div>
                        <div style="font-size: 12px; color: #666;">ì„±ë³„: ${patient.gender} | ìƒë…„ì›”ì¼: ${patient.birth}</div>
                    `;
                    
                    // í˜¸ë²„ íš¨ê³¼
                    resultItem.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f5f5f5';
                    });
                    
                    resultItem.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'white';
                    });
                    
                    resultItem.addEventListener('click', function() {
                        selectPatient(id, patient);
                    });
                    
                    dropdown.appendChild(resultItem);
                });
            }
            
            dropdown.style.cssText = `
                display: block;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background-color: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                z-index: 1000;
                max-height: 200px;
                overflow-y: auto;
            `;
        }

        // í™˜ì ì„ íƒ
        function selectPatient(patientId, patient) {
            console.log('ì„ íƒëœ í™˜ì ID:', patientId, 'í™˜ì ì •ë³´:', patient);
            currentPatientId = patientId; // ì—¬ê¸°ì„œ ì‹¤ì œ patient_idë¥¼ ì €ì¥
            updatePatientInfo(patient);
            document.getElementById('patientSearch').value = '';
            document.getElementById('search-dropdown').style.display = 'none';
            
            // ì„ íƒëœ í™˜ìì˜ ë°”ì´íƒˆ ë°ì´í„° ë¡œë“œ - patientId(ìˆ«ì)ë¥¼ ì „ë‹¬
            loadPatientVitalData(patientId);
        }

        // í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸
        function updatePatientInfo(patient) {
            document.getElementById('patientName').textContent = patient.name + ' í™˜ì';
            document.getElementById('patientDetails').textContent = 
                `ì„±ë³„: ${patient.gender} | ìƒë…„ì›”ì¼: ${patient.birth} | ì „í™”ë²ˆí˜¸: ${patient.phone}`;
        }

        // í™˜ì ì„ íƒ ì‹œ ì°¨íŠ¸ ì´ˆê¸°í™” ë° ë¡œë“œ
        function loadPatientVitalData(patientId) {
            try {
                console.log(`í™˜ì ID ${patientId}ì˜ ë°”ì´íƒˆ ë°ì´í„° ë¡œë“œ ì‹œì‘ (íƒ€ì…: ${typeof patientId})`);
                
                // patientIdê°€ ìˆ«ìì¸ì§€ í™•ì¸
                const numericPatientId = parseInt(patientId);
                if (isNaN(numericPatientId)) {
                    throw new Error(`ì˜ëª»ëœ í™˜ì ID: ${patientId}`);
                }
                
                // ì°¨íŠ¸ ì´ˆê¸°í™” (ì´ì „ í™˜ì ë°ì´í„° ì œê±°)
                initializeChartsData();
                
                // ìµœì‹  ë°”ì´íƒˆ ì‚¬ì¸ ì¡°íšŒ
                console.log('ìµœì‹  ë°”ì´íƒˆ ì‚¬ì¸ ìš”ì²­...');
                fetch(`/nurse/api/vitals/latest/${numericPatientId}`)
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('ìµœì‹  ë°”ì´íƒˆ ì¡°íšŒ ì‹¤íŒ¨');
                        }
                    })
                    .then(latestData => {
                        console.log('ìµœì‹  ë°”ì´íƒˆ ë°ì´í„°:', latestData);
                        updateVitalSummary(latestData);
                    })
                    .catch(error => {
                        console.error('ìµœì‹  ë°”ì´íƒˆ ì¡°íšŒ ì‹¤íŒ¨:', error);
                        // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                        updateVitalSummary({});
                    });

                // ì°¨íŠ¸ ë°ì´í„° ì¡°íšŒ
                console.log(`ì°¨íŠ¸ ë°ì´í„° ìš”ì²­: /nurse/api/vitals/chart-data/${numericPatientId}`);
                fetch(`/nurse/api/vitals/chart-data/${numericPatientId}`)
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('ì°¨íŠ¸ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
                        }
                    })
                    .then(chartData => {
                        console.log('ì°¨íŠ¸ ë°ì´í„° ì‘ë‹µ:', chartData);
                        vitalChartData = chartData;
                        
                        // ê° ì°¨íŠ¸ë¥¼ ê°œë³„ì ìœ¼ë¡œ ì‹œê°„ë³„ë¡œ ì´ˆê¸°í™”
                        updateBPChartOnly('time');
                        updateTempRespChartOnly('time');
                        updatePulseChart(); // ë§¥ë°•ì€ í•­ìƒ ì‹œê°„ëŒ€ë³„ë§Œ
                    })
                    .catch(error => {
                        console.error('ì°¨íŠ¸ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error);
                        // ì‹¤íŒ¨ ì‹œ ë¹ˆ ì°¨íŠ¸ í‘œì‹œ
                        vitalChartData = { timeData: [], weeklyData: [] };
                        updateBPChartOnly('time');
                        updateTempRespChartOnly('time');
                        updatePulseChart();
                    });
                
            } catch (error) {
                console.error('ë°”ì´íƒˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ ì‹œ ëª¨ë“  ì°¨íŠ¸ ì´ˆê¸°í™”
                initializeChartsData();
                updateVitalSummary({});
            }
        }

        // ì°¨íŠ¸ ë°ì´í„° ì´ˆê¸°í™”
        function initializeChartsData() {
            updateBPChartData(['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'], [0, 0, 0, 0], [0, 0, 0, 0]);
            updatePulseChartData([0, 0, 0, 0]);
            updateTempRespChartData(['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'], [0, 0, 0, 0], [0, 0, 0, 0]);
        }

        // ë§¥ë°• ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ì‹œê°„ëŒ€ë³„ë§Œ)
        function updatePulseChart() {
            if (!vitalChartData || !vitalChartData.timeData) {
                updatePulseChartData([0, 0, 0, 0]);
                return;
            }

            const timeLabels = ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'];
            const pulseData = [0, 0, 0, 0];

            vitalChartData.timeData.forEach(item => {
                const index = timeLabels.indexOf(item.time_period);
                if (index !== -1) {
                    pulseData[index] = parseFloat(item.avg_pulse || 0);
                }
            });

            updatePulseChartData(pulseData);
        }

        // ìµœì‹  ë°”ì´íƒˆ ìš”ì•½ ì—…ë°ì´íŠ¸
        function updateVitalSummary(latestVital) {
            if (latestVital && Object.keys(latestVital).length > 0) {
                const systolic = latestVital.bp_systolic || 0;
                const diastolic = latestVital.bp_diastolic || 0;
                
                document.getElementById('latestBP').textContent = `${systolic}/${diastolic}`;
                document.getElementById('latestPulse').textContent = latestVital.pulse_rate || '-';
                document.getElementById('latestTemp').textContent = latestVital.temperature ? 
                    parseFloat(latestVital.temperature).toFixed(1) : '-';
                document.getElementById('latestResp').textContent = latestVital.respiration_rate || '-';
                
                // ì‹œê°„ ì •ë³´ì— ì‹œê°„ëŒ€ í‘œì‹œ ì¶”ê°€
                let recordTime = '-';
                let timePeriodInfo = '';
                
                if (latestVital.recorded_at) {
                    const recordDate = new Date(latestVital.recorded_at);
                    recordTime = recordDate.toLocaleString('ko-KR');
                    
                    // í•´ë‹¹ ì‹œê°„ì˜ ì‹œê°„ëŒ€ ê³„ì‚°
                    const hour = recordDate.getHours();
                    let period = '';
                    if (hour >= 6 && hour < 12) period = 'ì•„ì¹¨';
                    else if (hour >= 12 && hour < 18) period = 'ì ì‹¬';
                    else if (hour >= 18 && hour < 24) period = 'ì €ë…';
                    else period = 'ì•¼ê°„';
                    
                    timePeriodInfo = ` (${getTimePeriodIcon(period)} ${period})`;
                    recordTime += timePeriodInfo;
                }
                
                document.getElementById('bpTime').innerHTML = recordTime;
                document.getElementById('pulseTime').innerHTML = recordTime;
                document.getElementById('tempTime').innerHTML = recordTime;
                document.getElementById('respTime').innerHTML = recordTime;
            } else {
                // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ê°’
                document.getElementById('latestBP').textContent = '-/-';
                document.getElementById('latestPulse').textContent = '-';
                document.getElementById('latestTemp').textContent = '-';
                document.getElementById('latestResp').textContent = '-';
                document.getElementById('bpTime').textContent = 'ë°ì´í„° ì—†ìŒ';
                document.getElementById('pulseTime').textContent = 'ë°ì´í„° ì—†ìŒ';
                document.getElementById('tempTime').textContent = 'ë°ì´í„° ì—†ìŒ';
                document.getElementById('respTime').textContent = 'ë°ì´í„° ì—†ìŒ';
            }
        }

        // ëª¨ë“  ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateAllCharts(period) {
            if (!vitalChartData || !vitalChartData.timeData) {
                console.log('ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ë¹ˆ ì°¨íŠ¸ í‘œì‹œ
                updateBPChartData(['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'], [0, 0, 0, 0], [0, 0, 0, 0]);
                updatePulseChartData([0, 0, 0, 0]);
                updateTempRespChartData(['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'], [0, 0, 0, 0], [0, 0, 0, 0]);
                return;
            }

            const data = period === 'time' ? vitalChartData.timeData : vitalChartData.weeklyData;
            console.log(`${period} ë°ì´í„° ì—…ë°ì´íŠ¸:`, data);
            
            if (period === 'time') {
                // ì‹œê°„ëŒ€ë³„ ë°ì´í„° ì²˜ë¦¬
                const timeLabels = ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'];
                const systolicData = [0, 0, 0, 0];
                const diastolicData = [0, 0, 0, 0];
                const pulseData = [0, 0, 0, 0];
                const tempData = [0, 0, 0, 0];
                const respData = [0, 0, 0, 0];

                // ì‹¤ì œ DB ë°ì´í„°ë¥¼ ì‹œê°„ëŒ€ë³„ë¡œ ë§¤í•‘
                data.forEach(item => {
                    const index = timeLabels.indexOf(item.time_period);
                    if (index !== -1) {
                        systolicData[index] = parseFloat(item.avg_systolic || 0);
                        diastolicData[index] = parseFloat(item.avg_diastolic || 0);
                        pulseData[index] = parseFloat(item.avg_pulse || 0);
                        tempData[index] = parseFloat(item.avg_temp || 0);
                        respData[index] = parseFloat(item.avg_resp || 0);
                    }
                });

                console.log('ì‹œê°„ëŒ€ë³„ ì²˜ë¦¬ëœ ë°ì´í„°:', {
                    systolic: systolicData,
                    diastolic: diastolicData,
                    pulse: pulseData,
                    temp: tempData,
                    resp: respData
                });

                updateBPChartData(timeLabels, systolicData, diastolicData);
                updatePulseChartData(pulseData);
                updateTempRespChartData(timeLabels, tempData, respData);
                
            } else {
                // ì£¼ê°„ë³„ ë°ì´í„° ì²˜ë¦¬
                const weeklyLabels = data.map(item => {
                    const date = new Date(item.date);
                    return ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
                });
                const systolicData = data.map(item => parseFloat(item.avg_systolic || 0));
                const diastolicData = data.map(item => parseFloat(item.avg_diastolic || 0));
                const tempData = data.map(item => parseFloat(item.avg_temp || 0));
                const respData = data.map(item => parseFloat(item.avg_resp || 0));

                console.log('ì£¼ê°„ë³„ ì²˜ë¦¬ëœ ë°ì´í„°:', {
                    labels: weeklyLabels,
                    systolic: systolicData,
                    diastolic: diastolicData,
                    temp: tempData,
                    resp: respData
                });

                updateBPChartData(weeklyLabels, systolicData, diastolicData);
                updateTempRespChartData(weeklyLabels, tempData, respData);
            }
        }

        // ì°¨íŠ¸ë³„ ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
        function updateBPChartData(labels, systolic, diastolic) {
            charts.bloodPressure.data.labels = labels;
            charts.bloodPressure.data.datasets[0].data = systolic;
            charts.bloodPressure.data.datasets[1].data = diastolic;
            
            // Yì¶• ë²”ìœ„ ì¡°ì • - ìµœëŒ€ 200ìœ¼ë¡œ ê³ ì •
            charts.bloodPressure.options.scales.y.min = 40;
            charts.bloodPressure.options.scales.y.max = 200;
            
            charts.bloodPressure.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            console.log('í˜ˆì•• ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', { labels, systolic, diastolic });
        }

        function updatePulseChartData(pulseData) {
            charts.pulseRate.data.datasets[0].data = pulseData;
            
            // Yì¶• ë²”ìœ„ ì¡°ì • - ìµœëŒ€ 200ìœ¼ë¡œ ê³ ì •
            charts.pulseRate.options.scales.y.min = 0;
            charts.pulseRate.options.scales.y.max = 200;
            
            charts.pulseRate.update('none');
            console.log('ë§¥ë°• ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', pulseData);
        }

        function updateTempRespChartData(labels, tempData, respData) {
            charts.tempResp.data.labels = labels;
            charts.tempResp.data.datasets[0].data = tempData;
            charts.tempResp.data.datasets[1].data = respData;
            
            // Yì¶• ë²”ìœ„ ì¡°ì • - ì²´ì˜¨ ìµœëŒ€ 42, í˜¸í¡ìˆ˜ ìµœëŒ€ 100
            charts.tempResp.options.scales.y.min = 35;
            charts.tempResp.options.scales.y.max = 42;
            charts.tempResp.options.scales.y1.min = 10;
            charts.tempResp.options.scales.y1.max = 100;
            
            charts.tempResp.update('none');
            console.log('ì²´ì˜¨/í˜¸í¡ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', { labels, tempData, respData });
        }

        // í˜ˆì•• ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ê°œë³„ ë™ì‘)
        function updateBPChart(period) {
            setActiveOption(event.target);
            updateBPChartOnly(period);
        }

        // ì²´ì˜¨/í˜¸í¡ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ê°œë³„ ë™ì‘)
        function updateTempRespChart(period) {
            setActiveOption(event.target);
            updateTempRespChartOnly(period);
        }

        // í˜ˆì•• ì°¨íŠ¸ë§Œ ì—…ë°ì´íŠ¸
        function updateBPChartOnly(period) {
            if (!vitalChartData) {
                console.log('ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (period === 'time') {
                // ì‹œê°„ëŒ€ë³„ (ì•„ì¹¨, ì ì‹¬, ì €ë…, ì•¼ê°„)
                const timeLabels = ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'];
                const systolicData = [0, 0, 0, 0];
                const diastolicData = [0, 0, 0, 0];

                if (vitalChartData.timeData) {
                    vitalChartData.timeData.forEach(item => {
                        const index = timeLabels.indexOf(item.time_period);
                        if (index !== -1) {
                            systolicData[index] = parseFloat(item.avg_systolic || 0);
                            diastolicData[index] = parseFloat(item.avg_diastolic || 0);
                        }
                    });
                }

                updateBPChartData(timeLabels, systolicData, diastolicData);
                
            } else if (period === 'weekly') {
                // ì£¼ê°„ë³„ (ì›”, í™”, ìˆ˜, ëª©, ê¸ˆ, í† , ì¼)
                const weeklyLabels = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
                const systolicData = [0, 0, 0, 0, 0, 0, 0];
                const diastolicData = [0, 0, 0, 0, 0, 0, 0];

                if (vitalChartData.weeklyData) {
                    vitalChartData.weeklyData.forEach(item => {
                        const date = new Date(item.date);
                        const dayIndex = (date.getDay() + 6) % 7; // ì›”ìš”ì¼ì„ 0ìœ¼ë¡œ ë§Œë“¤ê¸° (ì¼ìš”ì¼=0 -> ì›”ìš”ì¼=0)
                        systolicData[dayIndex] = parseFloat(item.avg_systolic || 0);
                        diastolicData[dayIndex] = parseFloat(item.avg_diastolic || 0);
                    });
                }

                updateBPChartData(weeklyLabels, systolicData, diastolicData);
            }
        }

        // ì²´ì˜¨/í˜¸í¡ ì°¨íŠ¸ë§Œ ì—…ë°ì´íŠ¸
        function updateTempRespChartOnly(period) {
            if (!vitalChartData) {
                console.log('ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (period === 'time') {
                // ì‹œê°„ëŒ€ë³„ (ì•„ì¹¨, ì ì‹¬, ì €ë…, ì•¼ê°„)
                const timeLabels = ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'];
                const tempData = [0, 0, 0, 0];
                const respData = [0, 0, 0, 0];

                if (vitalChartData.timeData) {
                    vitalChartData.timeData.forEach(item => {
                        const index = timeLabels.indexOf(item.time_period);
                        if (index !== -1) {
                            tempData[index] = parseFloat(item.avg_temp || 0);
                            respData[index] = parseFloat(item.avg_resp || 0);
                        }
                    });
                }

                updateTempRespChartData(timeLabels, tempData, respData);
                
            } else if (period === 'weekly') {
                // ì£¼ê°„ë³„ (ì›”, í™”, ìˆ˜, ëª©, ê¸ˆ, í† , ì¼)
                const weeklyLabels = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
                const tempData = [0, 0, 0, 0, 0, 0, 0];
                const respData = [0, 0, 0, 0, 0, 0, 0];

                if (vitalChartData.weeklyData) {
                    vitalChartData.weeklyData.forEach(item => {
                        const date = new Date(item.date);
                        const dayIndex = (date.getDay() + 6) % 7; // ì›”ìš”ì¼ì„ 0ìœ¼ë¡œ ë§Œë“¤ê¸°
                        tempData[dayIndex] = parseFloat(item.avg_temp || 0);
                        respData[dayIndex] = parseFloat(item.avg_resp || 0);
                    });
                }

                updateTempRespChartData(weeklyLabels, tempData, respData);
            }
        }

        // í™œì„± ì˜µì…˜ ì„¤ì •
        function setActiveOption(clickedElement) {
            const parent = clickedElement.parentElement;
            parent.querySelectorAll('.chart-option').forEach(opt => opt.classList.remove('active'));
            clickedElement.classList.add('active');
        }

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initializeCharts() {
            // í˜ˆì•• ì¶”ì´ ì°¨íŠ¸
            const bloodPressureCtx = document.getElementById('bloodPressureChart').getContext('2d');
            charts.bloodPressure = new Chart(bloodPressureCtx, {
                type: 'line',
                data: {
                    labels: ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'],
                    datasets: [{
                        label: 'ìˆ˜ì¶•ê¸°ì••',
                        data: [],
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'ì´ì™„ê¸°ì••',
                        data: [],
                        borderColor: '#64b5f6',
                        backgroundColor: 'rgba(100, 181, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 40,
                            max: 200  // í˜ˆì•• ìµœëŒ€ê°’ 200ìœ¼ë¡œ ê³ ì •
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // ë§¥ë°•ìˆ˜ ì°¨íŠ¸
            const pulseRateCtx = document.getElementById('pulseRateChart').getContext('2d');
            charts.pulseRate = new Chart(pulseRateCtx, {
                type: 'bar',
                data: {
                    labels: ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'],
                    datasets: [{
                        label: 'ë§¥ë°•ìˆ˜',
                        data: [],
                        backgroundColor: ['#81c784', '#64b5f6', '#ffb74d', '#f06292'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0,
                            max: 200  // ë§¥ë°•ìˆ˜ ìµœëŒ€ê°’ 200ìœ¼ë¡œ ê³ ì •
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // ì²´ì˜¨ ë° í˜¸í¡ ë¶„ì„ ì°¨íŠ¸
            const tempRespCtx = document.getElementById('tempRespChart').getContext('2d');
            charts.tempResp = new Chart(tempRespCtx, {
                type: 'line',
                data: {
                    labels: ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'],
                    datasets: [{
                        label: 'ì²´ì˜¨ (Â°C)',
                        data: [],
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4
                    }, {
                        label: 'í˜¸í¡ìˆ˜ (/ë¶„)',
                        data: [],
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 35,
                            max: 42,  // ì²´ì˜¨ ìµœëŒ€ê°’ 42ë¡œ ê³ ì •
                            title: {
                                display: true,
                                text: 'ì²´ì˜¨ (Â°C)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 10,
                            max: 100,  // í˜¸í¡ìˆ˜ ìµœëŒ€ê°’ 100ìœ¼ë¡œ ê³ ì •
                            title: {
                                display: true,
                                text: 'í˜¸í¡ìˆ˜ (/ë¶„)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-bar')) {
                document.getElementById('search-dropdown').style.display = 'none';
            }
        });

        // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸ - Enter í‚¤ ì§€ì› ì¶”ê°€
        document.getElementById('patientSearch').addEventListener('input', function(e) {
            searchPatient();
        });
        
        document.getElementById('patientSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchPatient();
            }
        });
        
        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ìˆ˜ì •
        document.querySelector('.search-btn').addEventListener('click', function(e) {
            e.preventDefault();
            searchPatient();
        });

        // ë©”ë‰´ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });
    </script>
</body>
</html>