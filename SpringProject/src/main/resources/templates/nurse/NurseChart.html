<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ë£Œ ê¸°ë¡ ì°¨íŠ¸</title>
    <link rel="stylesheet" href="/css/NurseChartstyle.css">
    <style>
        /* ğŸ†• ë‚ ì§œ ì„ íƒ ê´€ë ¨ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        .date-selection {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .date-selection h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .date-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .date-input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .date-info {
            font-size: 12px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <div class="profile">
            <div class="profile-icon">ğŸ‘¤</div>
            <span th:text="${userName}">ê°„í˜¸ì‚¬ ì´ë¦„</span>
        </div>
        
        <a href="NurseHome" class="menu-item">
            <div class="menu-icon">ğŸ””</div>
            <span>ì•Œë¦¼</span>
        </a>
        
        <a href="VitalRecord" class="menu-item">
            <div class="menu-icon">ğŸ’œ</div>
            <span>ë°”ì´íƒˆ ê¸°ë¡</span>
        </a>
               
        <a href="NurseChart" class="menu-item active" id="chart-menu">
            <div class="menu-icon">ğŸ“‹</div>
            <span>ì°¨íŠ¸</span>
        </a>
        
        <a href="MedicationRecord" class="menu-item">
            <div class="menu-icon">ğŸ’Š</div>
            <span>íˆ¬ì•½ ë° ì²˜ì¹˜ ê¸°ë¡</span>
        </a>
        <a th:href="@{/Login/Logout}" class="menu-item logout">
            <div class="menu-icon">ğŸšª</div>
            <span>ë¡œê·¸ì•„ì›ƒ</span>
        </a>
    </div>
	
    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="main-content">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="í™˜ì ê²€ìƒ‰" id="search-input">
                <button class="search-btn" id="search-btn">ğŸ”</button>
                <!-- ê²€ìƒ‰ ê²°ê³¼ ë“œë¡­ë‹¤ìš´ -->
                <div class="search-dropdown" id="search-dropdown"></div>
            </div>
            <div class="patient-info" id="patient-info" style="display: none;">í™˜ìëª…</div>
            <div class="patient-details" id="patient-details" style="display: none;">í™˜ì ìƒì„¸ì •ë³´</div>
        </div>

        <!-- í™˜ì ë¦¬ìŠ¤íŠ¸ -->
        <div class="patient-list show" id="patient-list">
            <div class="patient-list-header">ì…ì› í™˜ì ëª©ë¡</div>
            <!-- í™˜ì ëª©ë¡ì´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>

        <!-- ì°¨íŠ¸ ë¦¬ìŠ¤íŠ¸ -->
        <div class="chart-list" id="chart-list">
            <div class="chart-list-header">
                <span id="selected-patient-name">í™˜ì</span>
                <button class="new-chart-btn" id="new-chart-btn">ìƒˆ ì°¨íŠ¸ ì‘ì„±</button>
            </div>
            <div id="chart-list-content">
                <!-- ì°¨íŠ¸ ë¦¬ìŠ¤íŠ¸ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ì»¨í…ì¸  ì˜ì—­ -->
        <div class="content-area chart-content" id="chart-content">
            <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
            <div class="chart-section">
                <button class="back-btn" id="back-to-list">â† ì°¨íŠ¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                
                <!-- ğŸ†• ë‚ ì§œ ì„ íƒ ì„¹ì…˜ ì¶”ê°€ -->
                <div class="date-selection">
                    <h3>ê¸°ë¡ ë‚ ì§œ ì„ íƒ</h3>
                    <div class="date-input-group">
                        <input type="date" 
                               id="chart-date-input" 
                               class="date-input"
                               max="" 
                               value="">
                        <span class="date-info">* ì˜¤ëŠ˜ ë‚ ì§œ ì´í›„ëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</span>
                    </div>
                </div>
                
                <div class="chart-controls">
                    <button class="chart-btn" id="save-chart-btn">ì €ì¥í•˜ê¸°</button>
                </div>

                <table class="chart-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;"></th>
                            <th style="width: 120px;">ì•„ì¹¨</th>
                            <th style="width: 120px;">ì ì‹¬</th>
                            <th style="width: 120px;">ì €ë…</th>
                            <th style="width: 120px;">ì•¼ê°„</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="row-header">í˜ˆì••</td>
                            <td class="editable-cell" data-row="í˜ˆì••" data-time="ì•„ì¹¨"></td>
                            <td class="editable-cell" data-row="í˜ˆì••" data-time="ì ì‹¬"></td>
                            <td class="editable-cell" data-row="í˜ˆì••" data-time="ì €ë…"></td>
                            <td class="editable-cell" data-row="í˜ˆì••" data-time="ì•¼ê°„"></td>
                        </tr>
                        <tr>
                            <td class="row-header">ì‹¬ë°•ìˆ˜</td>
                            <td class="editable-cell" data-row="ì‹¬ë°•ìˆ˜" data-time="ì•„ì¹¨"></td>
                            <td class="editable-cell" data-row="ì‹¬ë°•ìˆ˜" data-time="ì ì‹¬"></td>
                            <td class="editable-cell" data-row="ì‹¬ë°•ìˆ˜" data-time="ì €ë…"></td>
                            <td class="editable-cell" data-row="ì‹¬ë°•ìˆ˜" data-time="ì•¼ê°„"></td>
                        </tr>
                        <tr>
                            <td class="row-header">ì²´ì˜¨</td>
                            <td class="editable-cell" data-row="ì²´ì˜¨" data-time="ì•„ì¹¨"></td>
                            <td class="editable-cell" data-row="ì²´ì˜¨" data-time="ì ì‹¬"></td>
                            <td class="editable-cell" data-row="ì²´ì˜¨" data-time="ì €ë…"></td>
                            <td class="editable-cell" data-row="ì²´ì˜¨" data-time="ì•¼ê°„"></td>
                        </tr>
                        <tr>
                            <td class="row-header">í˜¸í¡ìˆ˜</td>
                            <td class="editable-cell" data-row="í˜¸í¡ìˆ˜" data-time="ì•„ì¹¨"></td>
                            <td class="editable-cell" data-row="í˜¸í¡ìˆ˜" data-time="ì ì‹¬"></td>
                            <td class="editable-cell" data-row="í˜¸í¡ìˆ˜" data-time="ì €ë…"></td>
                            <td class="editable-cell" data-row="í˜¸í¡ìˆ˜" data-time="ì•¼ê°„"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // í™˜ì ë°ì´í„° (ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¡œë“œë  ì˜ˆì •)
        let patients = {};

        // ì°¨íŠ¸ ë°ì´í„° (ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¡œë“œë  ì˜ˆì •)
        let chartData = {};

        let currentPatientId = null;
        let currentChartId = null;
        let isNewChart = false;

        // DOM ìš”ì†Œë“¤
        const patientList = document.getElementById('patient-list');
        const chartList = document.getElementById('chart-list');
        const chartContent = document.getElementById('chart-content');
        const patientInfo = document.getElementById('patient-info');
        const patientDetails = document.getElementById('patient-details');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchDropdown = document.getElementById('search-dropdown');
        const selectedPatientName = document.getElementById('selected-patient-name');
        const chartListContent = document.getElementById('chart-list-content');
        const newChartBtn = document.getElementById('new-chart-btn');
        const backToListBtn = document.getElementById('back-to-list');
        const saveChartBtn = document.getElementById('save-chart-btn');

        // ğŸ†• ë‚ ì§œ ì…ë ¥ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeDateInput() {
            const dateInput = document.getElementById('chart-date-input');
            const today = new Date().toISOString().split('T')[0];
            
            // ìµœëŒ€ ë‚ ì§œë¥¼ ì˜¤ëŠ˜ë¡œ ì„¤ì • (ë¯¸ë˜ ë‚ ì§œ ì„ íƒ ë°©ì§€)
            dateInput.max = today;
            
            // ê¸°ë³¸ê°’ì„ ì˜¤ëŠ˜ë¡œ ì„¤ì •
            dateInput.value = today;
        }

        // ì…ì›ì¤‘ì¸ í™˜ì ëª©ë¡ì„ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function fetchInpatients() {
            try {
                console.log('ì…ì› í™˜ì ë°ì´í„° ìš”ì²­ ì‹œì‘...');
                const response = await fetch('/nurse/api/patients/inpatients');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const patientList = await response.json();
                console.log('ë°›ì•„ì˜¨ í™˜ì ë°ì´í„°:', patientList);
                
                // ë°°ì—´ì„ ê°ì²´ë¡œ ë³€í™˜ (ê¸°ì¡´ ì½”ë“œì™€ í˜¸í™˜ì„±ì„ ìœ„í•´)
                patients = {};
                patientList.forEach(patient => {
                    patients[patient.patient_id] = {
                        name: patient.patient_name,
                        gender: patient.patient_gender,
                        birth: patient.patient_birth,
                        phone: patient.patient_phone
                    };
                });
                
                console.log('ë³€í™˜ëœ í™˜ì ê°ì²´:', patients);
                
                // í™˜ì ëª©ë¡ UI ì—…ë°ì´íŠ¸
                updatePatientListUI();
                
                console.log('ì…ì› í™˜ì ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', Object.keys(patients).length + 'ëª…');
                
            } catch (error) {
                console.error('í™˜ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('í™˜ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                
                // ì—ëŸ¬ ë°œìƒì‹œ ë¹ˆ í™˜ì ëª©ë¡ í‘œì‹œ
                updatePatientListUI();
            }
        }

        // íŠ¹ì • í™˜ìì˜ ì°¨íŠ¸ ëª©ë¡ì„ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function fetchPatientCharts(patientId) {
            try {
                console.log(`í™˜ì ${patientId}ì˜ ì°¨íŠ¸ ë°ì´í„° ìš”ì²­ ì‹œì‘...`);
                const response = await fetch(`/nurse/api/charts/patient/${patientId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const charts = await response.json();
                console.log(`ë°›ì•„ì˜¨ ì°¨íŠ¸ ë°ì´í„°:`, charts);
                
                // ë°±ì—”ë“œ ì‘ë‹µ êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •
                chartData[patientId] = charts.map(chart => ({
                    id: chart.recorded_date,
                    date: chart.recorded_date,
                    time: chart.latest_time || '00:00', // latest_time ì‚¬ìš©
                    status: 'complete',
                    recordCount: chart.record_count
                }));
                
                console.log(`í™˜ì ${patientId}ì˜ ì°¨íŠ¸ ${chartData[patientId].length}ê°œ ë¡œë“œ ì™„ë£Œ`);
                
            } catch (error) {
                console.error('ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                chartData[patientId] = [];
                alert('ì°¨íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í™˜ì ëª©ë¡ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updatePatientListUI() {
            const patientListContainer = document.getElementById('patient-list');
            
            // ê¸°ì¡´ í™˜ì ì•„ì´í…œë“¤ ì œê±° (í—¤ë”ëŠ” ìœ ì§€)
            const existingItems = patientListContainer.querySelectorAll('.patient-item');
            existingItems.forEach(item => item.remove());
            
            // í™˜ìê°€ ì—†ì„ ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
            if (Object.keys(patients).length === 0) {
                const noPatientMsg = document.createElement('div');
                noPatientMsg.style.padding = '20px';
                noPatientMsg.style.textAlign = 'center';
                noPatientMsg.style.color = '#666';
                noPatientMsg.textContent = 'ì…ì› í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.';
                patientListContainer.appendChild(noPatientMsg);
                return;
            }
            
            // ìƒˆë¡œìš´ í™˜ì ì•„ì´í…œë“¤ ì¶”ê°€
            Object.entries(patients).forEach(([patientId, patient]) => {
                const patientItem = document.createElement('div');
                patientItem.className = 'patient-item';
                patientItem.setAttribute('data-patient-id', patientId);
                
                patientItem.innerHTML = `
                    <div class="patient-name">${patient.name}</div>
                    <div class="patient-detail">ì„±ë³„: ${patient.gender} | ìƒë…„ì›”ì¼: ${patient.birth} | ì „í™”ë²ˆí˜¸: ${patient.phone}</div>
                `;
                
                // í™˜ì í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                patientItem.addEventListener('click', function() {
                    const clickedPatientId = this.getAttribute('data-patient-id');
                    const clickedPatient = patients[clickedPatientId];
                    
                    if (clickedPatient) {
                        selectPatientFromSearch(clickedPatientId, clickedPatient);
                    }
                });
                
                patientListContainer.appendChild(patientItem);
            });
        }

        // ì°¨íŠ¸ ì…€ í¸ì§‘ ê¸°ëŠ¥ ì´ˆê¸°í™”
        function initializeChartCells() {
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('click', function() {
                    if (this.querySelector('.chart-input')) {
                        return; // ì´ë¯¸ ì…ë ¥ ì¤‘ì´ë©´ ë¬´ì‹œ
                    }
                    
                    const currentText = this.textContent.trim();
                    this.innerHTML = '';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'chart-input';
                    input.value = currentText === 'í´ë¦­í•˜ì—¬ ì…ë ¥' ? '' : currentText;
                    
                    // í¬ì»¤ìŠ¤ ë° ì„ íƒ
                    this.appendChild(input);
                    input.focus();
                    input.select();
                    
                    // Enter í‚¤ë‚˜ í¬ì»¤ìŠ¤ ìƒì„ ë•Œ ì €ì¥
                    const saveValue = () => {
                        const value = input.value.trim();
                        this.textContent = value;
                        if (!value) {
                            this.innerHTML = ''; // ë¹ˆ ê°’ì´ë©´ placeholder í‘œì‹œë¥¼ ìœ„í•´ ë¹„ì›€
                        }
                    };
                    
                    input.addEventListener('blur', saveValue);
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            saveValue();
                        }
                    });
                    
                    // ESC í‚¤ë¡œ ì·¨ì†Œ
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') {
                            this.parentElement.textContent = currentText === 'í´ë¦­í•˜ì—¬ ì…ë ¥' ? '' : currentText;
                        }
                    });
                });
            });
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        function searchPatients() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                searchDropdown.classList.remove('show');
                return;
            }
            
            // ê²€ìƒ‰ ê²°ê³¼ í•„í„°ë§
            const searchResults = Object.entries(patients).filter(([id, patient]) => {
                return patient.name.toLowerCase().includes(searchTerm) ||
                       patient.gender.toLowerCase().includes(searchTerm) ||
                       patient.birth.includes(searchTerm) ||
                       patient.phone.includes(searchTerm);
            });
            
            // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
            displaySearchResults(searchResults);
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function displaySearchResults(results) {
            searchDropdown.innerHTML = '';
            
            if (results.length === 0) {
                searchDropdown.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                results.forEach(([id, patient]) => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.setAttribute('data-patient-id', id);
                    
                    resultItem.innerHTML = `
                        <div class="search-result-name">${patient.name}</div>
                        <div class="search-result-detail">ì„±ë³„: ${patient.gender} | ìƒë…„ì›”ì¼: ${patient.birth} | ì „í™”ë²ˆí˜¸: ${patient.phone}</div>
                    `;
                    
                    // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì´ë²¤íŠ¸
                    resultItem.addEventListener('click', function() {
                        selectPatientFromSearch(id, patient);
                    });
                    
                    searchDropdown.appendChild(resultItem);
                });
            }
            
            searchDropdown.classList.add('show');
        }

        // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ í™˜ì ì„ íƒ í•¨ìˆ˜
        function selectPatientFromSearch(patientId, patient) {
            // í™˜ì ì •ë³´ í‘œì‹œ
            patientInfo.textContent = `${patient.name} í™˜ì`;
            patientDetails.textContent = `ì„±ë³„: ${patient.gender} | ìƒë…„ì›”ì¼: ${patient.birth} | ì „í™”ë²ˆí˜¸: ${patient.phone}`;
            
            // í˜„ì¬ ì„ íƒëœ í™˜ì ID ì €ì¥
            currentPatientId = patientId;
            
            // ì°¨íŠ¸ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
            showChartList(patientId, patient.name);
            
            // ê²€ìƒ‰ì°½ ì´ˆê¸°í™” ë° ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
            searchInput.value = '';
            searchDropdown.classList.remove('show');
        }

        // ì°¨íŠ¸ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ í•¨ìˆ˜
        async function showChartList(patientId, patientName) {
            selectedPatientName.textContent = patientName;
            
            // UI ì „í™˜
            patientList.classList.remove('show');
            chartList.classList.add('show');
            chartContent.classList.remove('show');
            patientInfo.style.display = 'block';
            patientDetails.style.display = 'block';
            
            // í•´ë‹¹ í™˜ìì˜ ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ
            await fetchPatientCharts(patientId);
            
            // ì°¨íŠ¸ ë¦¬ìŠ¤íŠ¸ ë‚´ìš© ìƒì„±
            displayChartList(patientId);
        }

        // ì°¨íŠ¸ ë¦¬ìŠ¤íŠ¸ ë‚´ìš© í‘œì‹œ
        function displayChartList(patientId) {
            chartListContent.innerHTML = '';
            
            const charts = chartData[patientId] || [];
            
            if (charts.length === 0) {
                chartListContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">ì•„ì§ ì‘ì„±ëœ ì°¨íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                charts.forEach(chart => {
                    const chartItem = document.createElement('div');
                    chartItem.className = 'chart-item';
                    chartItem.setAttribute('data-chart-id', chart.id);
                    
                    console.log('ì°¨íŠ¸ ì•„ì´í…œ ìƒì„± - ID:', chart.id, 'Date:', chart.date); // ğŸ†• ë””ë²„ê¹… ë¡œê·¸
                    
                    chartItem.innerHTML = `
                        <div>
                            <div class="chart-date">${chart.date}</div>
                            <div class="chart-time">ì‘ì„±ì‹œê°„: ${chart.time}</div>
                        </div>                    
                    `;
                    
                    // ì°¨íŠ¸ í´ë¦­ ì´ë²¤íŠ¸
                    chartItem.addEventListener('click', function() {
                        console.log('ì°¨íŠ¸ í´ë¦­ - ID:', chart.id); // ğŸ†• ë””ë²„ê¹… ë¡œê·¸
                        openChart(chart.id);
                    });
                    
                    chartListContent.appendChild(chartItem);
                });
            }
        }

        // ì°¨íŠ¸ ì—´ê¸°
        function openChart(chartId) {
            chartList.classList.remove('show');
            chartContent.classList.add('show');
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì—´ê¸° í”Œë˜ê·¸ ì„¤ì •
            isNewChart = false;
            currentChartId = chartId;
            
            // ê¸°ì¡´ ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ
            loadChartData(chartId);
            
            console.log('ì°¨íŠ¸ ì—´ê¸°:', chartId);
        }

        // ìƒˆ ì°¨íŠ¸ ì‘ì„±
        newChartBtn.addEventListener('click', function() {
            chartList.classList.remove('show');
            chartContent.classList.add('show');
            
            // ìƒˆ ì°¨íŠ¸ í”Œë˜ê·¸ ì„¤ì •
            isNewChart = true;
            currentChartId = null;
            
            // ìƒˆ ì°¨íŠ¸ì´ë¯€ë¡œ í…Œì´ë¸” ì´ˆê¸°í™”
            clearChartTable();
            
            // ğŸ†• ìƒˆ ì°¨íŠ¸ìš© ë‚ ì§œ ì´ˆê¸°í™”
            const dateInput = document.getElementById('chart-date-input');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        });

        // ğŸ”„ ìˆ˜ì •ëœ ê¸°ì¡´ ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function loadChartData(chartId) {
            try {
                console.log(`ğŸ” ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì‹œì‘ - í™˜ìID: ${currentPatientId}, ë‚ ì§œ: ${chartId}`);
                
                // ğŸ†• í…Œì´ë¸” ì™„ì „ ì´ˆê¸°í™” (ê¸°ì¡´ ë°ì´í„° ì™„ì „ ì œê±°)
                console.log('ğŸ§¹ í…Œì´ë¸” ì´ˆê¸°í™” ì‹œì‘');
                document.querySelectorAll('.editable-cell').forEach(cell => {
                    cell.textContent = '';
                    cell.innerHTML = ''; // innerHTMLë„ ì´ˆê¸°í™”
                });
                console.log('âœ… í…Œì´ë¸” ì´ˆê¸°í™” ì™„ë£Œ');
                
                const response = await fetch(`/nurse/api/charts/detail/${currentPatientId}/${chartId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('ğŸ“‹ ì„œë²„ì—ì„œ ë°›ì€ ì°¨íŠ¸ ë°ì´í„°:', result);
                
                const chartData = result.data;
                console.log('ğŸ“‹ íŒŒì‹±ëœ ì°¨íŠ¸ ë°ì´í„°:', chartData);
                
                // ğŸ”„ ìˆ˜ì •: chartIdë¥¼ ë‚ ì§œë¡œ ì‚¬ìš© (chartId = recorded_date)
                const dateInput = document.getElementById('chart-date-input');
                dateInput.value = chartId; // chartIdê°€ ì´ë¯¸ YYYY-MM-DD í˜•ì‹
                
                console.log('ğŸ“… ì°¨íŠ¸ ë¡œë“œ - ë‚ ì§œ ì„¤ì •:', chartId);
                
                // í…Œì´ë¸”ì— ë°ì´í„° ë¡œë“œ
                const rows = ['í˜ˆì••', 'ì‹¬ë°•ìˆ˜', 'ì²´ì˜¨', 'í˜¸í¡ìˆ˜'];
                const times = ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'];
                
                rows.forEach((row) => {
                    times.forEach((time) => {
                        const cell = document.querySelector(`[data-row="${row}"][data-time="${time}"]`);
                        if (cell && chartData[row] && chartData[row][time]) {
                            console.log(`ğŸ“ ë°ì´í„° ë¡œë“œ: ${row} - ${time} = ${chartData[row][time]}`);
                            cell.textContent = chartData[row][time];
                        }
                    });
                });
                
                console.log('âœ… ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ğŸ”„ ìˆ˜ì •ëœ ì°¨íŠ¸ ì €ì¥ í•¨ìˆ˜ (í•µì‹¬ ìˆ˜ì •ì‚¬í•­!)
        async function saveChart() {
            if (!currentPatientId) {
                alert('í™˜ìê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            // ğŸ†• ì„ íƒëœ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
            const selectedDate = document.getElementById('chart-date-input').value;
            if (!selectedDate) {
                alert('ê¸°ë¡ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
            const today = new Date().toISOString().split('T')[0];
            if (selectedDate > today) {
                alert('ë¯¸ë˜ ë‚ ì§œëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì°¨íŠ¸ ë°ì´í„° ìˆ˜ì§‘
            const chartTableData = {};
            const rows = ['í˜ˆì••', 'ì‹¬ë°•ìˆ˜', 'ì²´ì˜¨', 'í˜¸í¡ìˆ˜'];
            const times = ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ì•¼ê°„'];
            
            rows.forEach((row) => {
                chartTableData[row] = {};
                times.forEach((time) => {
                    const cell = document.querySelector(`[data-row="${row}"][data-time="${time}"]`);
                    chartTableData[row][time] = cell.textContent.trim() || '';
                });
            });

            // ë°ì´í„°ê°€ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
            const hasData = rows.some(row => 
                times.some(time => chartTableData[row][time] !== '')
            );

            if (!hasData) {
                alert('ì…ë ¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìµœì†Œ í•˜ë‚˜ì˜ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ğŸ”„ ìˆ˜ì •ëœ ìš”ì²­ ë°ì´í„° - í•µì‹¬ ë³€ê²½ì‚¬í•­!
            const requestData = {
                patientId: parseInt(currentPatientId),
                nurseId: 'nurse01', // ì‹¤ì œë¡œëŠ” ë¡œê·¸ì¸í•œ ê°„í˜¸ì‚¬ ID ì‚¬ìš©
                recordedDate: selectedDate, // âœ… ì„ íƒëœ ë‚ ì§œ ì‚¬ìš© (ê¸°ì¡´: new Date().toISOString().split('T')[0])
                data: chartTableData
            };

            try {
                console.log('ì°¨íŠ¸ ì €ì¥ ìš”ì²­:', requestData);
                
                const response = await fetch('/nurse/api/charts/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('ì°¨íŠ¸ ì €ì¥ ì‘ë‹µ:', result);

                if (result.success) {
                    alert(`${selectedDate} ë‚ ì§œì˜ ì°¨íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (${result.savedRecords}ê°œ ë ˆì½”ë“œ)`);
                    
                    // ì°¨íŠ¸ ë¦¬ìŠ¤íŠ¸ë¡œ ëŒì•„ê°€ê¸°
                    chartContent.classList.remove('show');
                    chartList.classList.add('show');
                    
                    // ì°¨íŠ¸ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
                    await fetchPatientCharts(currentPatientId);
                    displayChartList(currentPatientId);
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + result.message);
                }

            } catch (error) {
                console.error('ì°¨íŠ¸ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì°¨íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì°¨íŠ¸ í…Œì´ë¸” ì´ˆê¸°í™”
        function clearChartTable() {
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.textContent = '';
            });
        }

        // ì°¨íŠ¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        backToListBtn.addEventListener('click', function() {
            chartContent.classList.remove('show');
            chartList.classList.add('show');
        });

        // ì°¨íŠ¸ ë©”ë‰´ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('chart-menu').addEventListener('click', function(e) {
            e.preventDefault();
            
            // í™˜ì ë¦¬ìŠ¤íŠ¸ ë³´ì´ê¸°, ë‹¤ë¥¸ í™”ë©´ ìˆ¨ê¸°ê¸°
            patientList.classList.add('show');
            chartList.classList.remove('show');
            chartContent.classList.remove('show');
            patientInfo.style.display = 'none';
            patientDetails.style.display = 'none';
            
            // ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
            searchDropdown.classList.remove('show');
            searchInput.value = '';
            
            // ë©”ë‰´ í™œì„±í™”
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });

        // ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-bar')) {
                searchDropdown.classList.remove('show');
            }
        });

        // ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        searchInput.addEventListener('input', searchPatients);
        searchBtn.addEventListener('click', function(e) {
            e.preventDefault();
            searchPatients();
        });

        // ë‹¤ë¥¸ ë©”ë‰´ ì•„ì´í…œë“¤ì€ ì •ìƒì ìœ¼ë¡œ hrefë¡œ í˜ì´ì§€ ì´ë™
        document.querySelectorAll('.menu-item:not(#chart-menu)').forEach(item => {
            item.addEventListener('click', function() {
                // hrefê°€ '#'ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í™œì„±í™” ìƒíƒœ ë³€ê²½
                if (this.getAttribute('href') === '#') {
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                }
            });
        });

        // ì°¨íŠ¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ì €ì¥ ê¸°ëŠ¥ ì œê±°)
        document.querySelectorAll('.chart-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // ì €ì¥ ê¸°ëŠ¥ì€ ë³„ë„ì˜ saveChartBtn ì´ë²¤íŠ¸ì—ì„œë§Œ ì²˜ë¦¬
            });
        });

        // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        saveChartBtn.addEventListener('click', function() {
            saveChart();
        });

        // ğŸ”„ ìˆ˜ì •ëœ í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘...');
            initializeChartCells();
            initializeDateInput(); // ğŸ†• ë‚ ì§œ ì…ë ¥ ì´ˆê¸°í™” ì¶”ê°€
            fetchInpatients(); // ì…ì› í™˜ì ë°ì´í„° ë¡œë“œ
        });

    </script>
</body>
</html>