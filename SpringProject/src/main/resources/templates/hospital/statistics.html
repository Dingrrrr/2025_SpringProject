<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>í†µê³„ í™”ë©´</title>
<link rel="stylesheet" th:href="@{/css/hospital_style.css}">
<link rel="stylesheet" th:href="@{/css/statistics_style.css}">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
	<div class="hospital-container">
		<aside class="hospital-sidebar">
			<h2 class="hospital-profile-title">
				<img th:src="@{/icons/profile.jpg}" alt="í”„ë¡œí•„"> <span
					th:text="${displayName}">ì˜ì‚¬ ì´ë¦„</span>
			</h2>
			<ul class="hospital-menu">
				<!-- ì•Œë¦¼ì€ fetchë¡œ ë¶€ë¶„ ë¡œë”© -->
				<li onclick="loadAndToggleNotification()"><img
					th:src="@{/icons/alert.png}" alt=""> ì•Œë¦¼</li>
				<!-- í™ˆ -->
				<li><a th:href="@{/hospital/hospital_home}"> <img
						th:src="@{/icons/home.png}" alt=""> í™ˆ
				</a></li>
				<!-- ì§„ë£Œ ê´€ë¦¬ -->
				<li><a th:href="@{/hospital/treatment}"> <img
						th:src="@{/icons/doctor.png}" alt=""> ì§„ë£Œ
				</a></li>
				<!-- ì˜ˆì•½ ê´€ë¦¬ -->
				<li><a th:href="@{/hospital/reservation}"> <img
						th:src="@{/icons/calendar.png}" alt=""> ì˜ˆì•½
				</a></li>
				<!-- ì°¨íŠ¸ ë³´ê¸° -->
				<li><a th:href="@{/hospital/chart}"> <img
						th:src="@{/icons/chart.png}" alt=""> ì°¨íŠ¸
				</a></li>
				<!-- í†µê³„ ë³´ê¸° -->
				<li><a th:href="@{/hospital/statistics}"> <img
						th:src="@{/icons/statistics.png}" alt=""> í†µê³„
				</a></li>
			</ul>
			<div class="sidebar-footer">
				<form th:action="@{/Login/Logout}" method="get" style="margin: 0;">
					<button type="submit" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
				</form>

			</div>
		</aside>

		<section class="statistics-container">
			<header class="stats-header">
				<div class="date-range">
					<input type="text" id="statsDate" placeholder="ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”" readonly>
				</div>
			</header>

			<div id="periodView">
				<main class="stats-grid">
					<div class="chart-card">
						<h4>ì§„ë£Œ í˜„í™©</h4>
						<canvas id="chartVisits"></canvas>
					</div>
					<div class="chart-card">
						<h4>ë‹´ë‹¹ë³„ ì§„ë£Œ ìˆ˜ í˜„í™©</h4>
						<canvas id="chartByDoctor"></canvas>
					</div>
					<div class="chart-card">
						<h4>ìƒë³‘ì½”ë“œë³„ í˜„í™©</h4>
						<canvas id="chartByDisease"></canvas>
					</div>
					<div class="chart-card">
						<h4>ì—°ë ¹ëŒ€ë³„ ì§„ë£Œ í˜„í™©</h4>
						<canvas id="chartByAgeGroup"></canvas>
					</div>

					<div class="chart-card">
						<h4>ì„±ë³„ ì§„ë£Œ ë¹„ìœ¨</h4>
						<canvas id="chartByGender"></canvas>
					</div>
				</main>
			</div>
		</section>
	</div>
<script>
  function formatDateKST(dateObj) {
  // 1) í˜„ì¬ íƒ€ì„ì¡´ ì˜¤í”„ì…‹(ë¶„)ì„ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜
  const offsetMs = dateObj.getTimezoneOffset() * 60000; // ex) KSTì—ì„œëŠ” -540ë¶„

  // 2) UTC ì‹œê°„ = ë¡œì»¬ ì‹œê°„ - ì˜¤í”„ì…‹
  const utc = dateObj.getTime() + offsetMs;

  // 3) KST(UTC+9) ì‹œê°„ = UTC + 9ì‹œê°„
  const kstDate = new Date(utc + 9 * 60 * 60 * 1000);

  // 4) ISO â†’ 'YYYY-MM-DD' ì• 10ìë¦¬ë§Œ
  return kstDate.toISOString().slice(0, 10);
}

  function initChart(id, cfg) {
    const ctx = document.getElementById(id).getContext('2d');
    return new Chart(ctx, cfg);
  }

  let doctorChart, visitChart, ageChart, genderChart;

  function loadDoctorChart(startDate, endDate) {
    const url = `/api/statistics/doctor-visits-by-date?startDate=${startDate}&endDate=${endDate}`;
    fetch(url)
      .then(res => res.json())
      .then(data => {
        const labels = data.map(d => d.doctorName);
        const counts = data.map(d => d.visitCount);
        if (doctorChart) doctorChart.destroy();
        doctorChart = initChart('chartByDoctor', {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{ label: 'ì§„ë£Œ ê±´ìˆ˜', data: counts, backgroundColor: '#4e73df' }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      });
  }

  function loadVisitChart(startDate, endDate) {
    const url = `/api/statistics/visit-daily?startDate=${startDate}&endDate=${endDate}`;
    fetch(url)
      .then(res => res.json())
      .then(data => {
        const labels = Object.keys(data);
        const values = Object.values(data);
        if (visitChart) visitChart.destroy();
        visitChart = initChart('chartVisits', {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{ label: 'ì§„ë£Œ ê±´ìˆ˜', data: values, backgroundColor: '#1cc88a' }]
          },
          options: { responsive: true }
        });
      });
  }

  function loadDiseaseChart(startDate, endDate) {
    fetch(`/api/statistics/disease-stats?startDate=${startDate}&endDate=${endDate}`)
      .then(res => res.json())
      .then(data => {
        const labels = data.map(d => d.diseaseName);
        const values = data.map(d => d.count);
        initChart('chartByDisease', {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{ label: 'ì§„ë£Œ ê±´ìˆ˜', data: values, backgroundColor: '#f6c23e' }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } }
          }
        });
      });
  }

  function loadAgeChart(startDate, endDate) {
    fetch(`/api/statistics/age-group-stats?startDate=${startDate}&endDate=${endDate}`)
      .then(res => res.json())
      .then(data => {
        const labels = Object.keys(data);
        const values = Object.values(data);
        if (ageChart) ageChart.destroy();
        ageChart = initChart('chartByAgeGroup', {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'ì§„ë£Œ ìˆ˜',
              data: values,
              backgroundColor: '#f6c23e'
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } }
          }
        });
      });
  }

  function loadGenderChart(startDate, endDate) {
  fetch(`/api/statistics/gender-stats?startDate=${startDate}&endDate=${endDate}`)
    .then(res => res.json())
    .then(data => {
      const labels = Object.keys(data);      // ['ë‚¨', 'ì—¬']
      const values = Object.values(data);    // [ë‚¨ì ê±´ìˆ˜, ì—¬ì ê±´ìˆ˜]

      if (genderChart) genderChart.destroy();

      genderChart = initChart('chartByGender', {
        type: 'bar',                     // ğŸ”» pie â†’ bar
        data: {
          labels: labels,
          datasets: [{
            label: 'ì§„ë£Œ ìˆ˜',
            data: values,
            backgroundColor: ['#36b9cc', '#e74a3b']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }   // ë²”ë¡€ ìˆ¨ê¹€
          },
          // ë§‰ëŒ€í­Â·ê°„ê²© ë“± ì„¸ë¶€ì¡°ì •ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— scales ì˜µì…˜ ì¶”ê°€
          // scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
        }
      });
    })
    .catch(err => console.error('ì„±ë³„ ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨ ğŸ‘‰', err));
}

  flatpickr("#statsDate", {
    mode: "range",
    dateFormat: "Y-m-d",
    locale: {
      firstDayOfWeek: 1,
      weekdays: {
        shorthand: ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '],
        longhand: ['ì¼ìš”ì¼','ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼']
      },
      months: {
        shorthand: ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'],
        longhand: ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”']
      }
    },
    onChange: function (selectedDates) {
      if (selectedDates.length === 2) {
        const startDate = formatDateKST(selectedDates[0]);
        const endDate = formatDateKST(selectedDates[1]);
        loadDoctorChart(startDate, endDate);
        loadVisitChart(startDate, endDate);
        loadDiseaseChart(startDate, endDate);
        loadAgeChart(startDate, endDate);
        loadGenderChart(startDate, endDate);
      }
    }
  });

  window.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    const first = new Date(today.getFullYear(), today.getMonth(), 1);
    const last = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    const startDate = formatDateKST(first);
    const endDate = formatDateKST(last);
    loadDoctorChart(startDate, endDate);
    loadVisitChart(startDate, endDate);
    loadDiseaseChart(startDate, endDate);
    loadAgeChart(startDate, endDate);
    loadGenderChart(startDate, endDate);
    document.getElementById('statsDate')._flatpickr.setDate([startDate, endDate]);
  });
</script>

</body>
</html>
