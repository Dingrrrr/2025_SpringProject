<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ì§„ë£Œ ê´€ë¦¬ í™”ë©´</title>
<link rel="stylesheet" href="/css/hospital_style.css">
<link rel="stylesheet" href="/css/chart_style.css">
</head>
<body>
	<div class="hospital-container">

		<!-- 1) ì‚¬ì´ë“œë°” -->
		<aside class="hospital-sidebar">
			<h2 class="hospital-profile-title">
				<img src="/icons/profile.jpg" alt="í”„ë¡œí•„"> <span>ë‚´ í”„ë¡œí•„</span>
			</h2>
			<ul class="hospital-menu">
				<li onclick="loadAndToggleNotification()"><img
					src="/icons/alert.png" alt=""> ì•Œë¦¼</li>
				<li onclick="goToHome()"><img src="/icons/home.png" alt="">
					í™ˆ</li>
				<li onclick="goToTreatment()"><img src="/icons/doctor.png"
					alt="ì§„ë£Œ"> ì§„ë£Œ</li>
				<li onclick="goToReservation()"><img src="/icons/calendar.png"
					alt="">ì˜ˆì•½</li>
				<li onclick="goToChart()" class="active"><img
					src="/icons/chart.png" alt="ì°¨íŠ¸"><span>ì°¨íŠ¸</span></li>
				<li onclick="goToStats()"><img src="/icons/statistics.png"
					alt="í†µê³„"><span>í†µê³„</span>
				<li><img src="/icons/bed.png" alt=""> ì…ì›</li>
			</ul>
			<div class="sidebar-footer">
				<button type="button" class="logout-btn" onclick="goLogout()">ë¡œê·¸ì•„ì›ƒ</button>
			</div>
		</aside>


		<!-- 2) í™˜ì ë¦¬ìŠ¤íŠ¸ -->
		<section class="patient-list">
	      <h3>í™˜ì ë¦¬ìŠ¤íŠ¸</h3>
	      <div class="status-label">ëŒ€ê¸° / ì§„í–‰ ì¤‘</div>
	
	      <!-- 1) ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë„˜ê¸´ appointmentsByRoom ë§µì„ entryë¡œ ìˆœíšŒ -->
	      <div th:each="entry : ${appointmentsByRoom}">
	        <details open class="room">
	          <summary>
	            <span th:text="${entry.key}">ì§„ë£Œì‹¤X</span>
	            <span class="count" th:text="${#lists.size(entry.value)}">0</span>
	          </summary>
	
	          <!-- 2) í•´ë‹¹ ë°© ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸(entry.value) ë°˜ë³µ -->
	          <div th:each="appt : ${entry.value}" class="card">
	            <div class="card-patient">
	              <strong th:text="${appt.patient.patientName}">í™ê¸¸ë™</strong>
	              <!-- ì„±ë³„ê³¼ ë‚˜ì´, ìƒë…„ì›”ì¼ -->
	              [<span th:text="${appt.patient.patientGender}">ë‚¨</span>]
	              <span th:text="${appt.patient.age} + 'ì„¸'">30ì„¸</span> Â·
	              <span th:text="${appt.patient.patientBirth}">1990-01-01</span>
	            </div>
	            <!-- 3) patientTypeì— ë”°ë¼ ë°°ì§€ ìƒ‰Â·ë¬¸êµ¬ ë¶„ê¸° -->
	            <div class="card-status"
	                 th:classappend="
	                   ${appt.patient.patientType.name() == 'ì§„ë£ŒëŒ€ê¸°'} ? ' yellow' :
	                   (${appt.patient.patientType.name() == 'ì§„ë£Œì¤‘'} ? ' blue' : '')
	                 "
	                 th:text="
	                   ${appt.patient.patientType.name() == 'ì§„ë£ŒëŒ€ê¸°'} ? 'ëŒ€ê¸°' :
	                   (${appt.patient.patientType.name() == 'ì§„ë£Œì¤‘'} ? 'ì§„ë£Œì¤‘' : '')
	                 ">
	            </div>
	          </div>
	        </details>
	      </div>
	    </section>

		<!-- 3) ë‚´ì› ì´ë ¥ -->
		<section class="patient-history">
			<h3>ë‚´ì› ì´ë ¥</h3>

			<!-- ì²« ë²ˆì§¸ ë°©ë¬¸ ê¸°ë¡ -->
			<details open class="history-entry">
				<summary>
					<div class="history-date">2025-05-15 (ì˜¤ëŠ˜)</div>
					<div class="history-doctor">ì˜¤ì§„ìš° ì„ ìƒ</div>
				</summary>
				<div class="history-content">
					<p>
						<strong>ì§„ë‹¨/ì†Œê²¬:</strong> ë‘í†µ, ë°œì—´
					</p>
					<p>
						<strong>ì²˜ë°© ë‚´ì—­:</strong>
					</p>
					<ul>
						<li>í•´ì—´ì§„í†µì œ 500mg â€” í•˜ë£¨ 3íšŒ</li>
						<li>ì§„í†µì œ ì‹œëŸ½ 5ml â€” í•„ìš” ì‹œ ì¶”ê°€</li>
					</ul>
				</div>
			</details>

			<!-- ë‘ ë²ˆì§¸ ë°©ë¬¸ ê¸°ë¡ -->
			<details class="history-entry">
				<summary>
					<div class="history-date">2025-03-15 (ë‘ë‹¬ ì „)</div>
					<div class="history-doctor">ì´ìƒë¯¼ ì„ ìƒ</div>
				</summary>
				<div class="history-content">
					<p>
						<strong>ì§„ë‹¨/ì†Œê²¬:</strong> ê¸°ì¹¨, ì¸í›„í†µ
					</p>
					<p>
						<strong>ì²˜ë°© ë‚´ì—­:</strong>
					</p>
					<ul>
						<li>ê¸°ì¹¨ì•½ 10ml â€” í•˜ë£¨ 2íšŒ</li>
						<li>ê°€ê¸€ì•¡ â€” ì‹í›„ ê°€ê¸€</li>
					</ul>
				</div>
			</details>
		</section>


		<!-- 4) ë©”ì¸ ì§„ë£Œ ê¸°ë¡ -->
		<section class="col treatment-main">
			  <!-- ì§„ë£Œê¸°ë¡ ì €ì¥ í¼ ì‹œì‘ -->
			  <form th:action="@{/hospital/chart/record}" method="post">
			  
			    <!-- 1) í—¤ë”: ê¸°ì¡´ ê·¸ëŒ€ë¡œ -->
			    <div class="record-header">
			      <div class="record-header-left">2021-09-01 (ì›”) 10:00 â–¶ ì´ì€ì†”</div>
			      <div class="record-header-right">
			        <button class="icon-btn">âš™ï¸</button>
			      </div>
			    </div>
			
			    <!-- 2) ì£¼ì¦ìƒ ì…ë ¥ -->
			    <div class="record-notes">
			      <h4>ì¦ìƒ ê¸°ë¡</h4>
			      <textarea name="chiefComplaint"
			                placeholder="í™˜ì ì¦ìƒ ìš”ì•½ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
			                required
			                class="notes-textarea"></textarea>
			    </div>
			
			    <!-- 3) ì§„ë‹¨ëª… ì„ íƒ -->
			    <div class="record-prescription">
			      <h4>ì§„ë‹¨ ë° ì²˜ë°©</h4>
			
			      <!-- ë„êµ¬ ë²„íŠ¼(ì´ì „ ê·¸ëŒ€ë¡œ) -->
			      <div class="prescription-toolbar">
			        <button type="button">ì˜ˆë°©ì ‘ì¢…</button>
			        <button type="button">DURì ê²€</button>
			        <button class="icon-btn" type="button">âš™ï¸</button>
			      </div>
			
			      <!-- (A) ì§„ë‹¨ëª… select -->
			      <label>ì§„ë‹¨ëª…:
			        <select name="diseaseId" required>
			          <option th:each="d : ${diseases}"
			                  th:value="${d.id}"
			                  th:text="${d.name}">
			            ì§„ë‹¨ëª…
			          </option>
			        </select>
			      </label>
			
			      <!-- (B) ì•½ë¬¼ select -->
			      <label>ì²˜ë°©ì•½:
			        <select name="drugId" required>
			          <option th:each="drug : ${drugs}"
			                  th:value="${drug.id}"
			                  th:text="${drug.name}">
			            ì•½ë¬¼ëª…
			          </option>
			        </select>
			      </label>
			
			      <!-- (C) ì¶”ê°€ë©”ëª¨ -->
			      <label>ì¶”ê°€ ë©”ëª¨:
			        <textarea name="notes"
			                  placeholder="ì¶”ê°€ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
			                  class="notes-textarea"></textarea>
			      </label>
			    </div>
			
			    <!-- 4) ìˆ¨ê¹€ í•„ë“œ: apptId, patientId, doctorId -->
			    <input type="hidden" name="apptId"    th:value="${selectedAppt.id}" />
			    <input type="hidden" name="patientId" th:value="${selectedAppt.patient.id}" />
			    <input type="hidden" name="doctorId"  th:value="${#httpSession.getAttribute('loginUser').usersId}" />
			
			    <!-- 5) ì €ì¥ ë²„íŠ¼ -->
			    <div class="prescription-action">
			      <button type="submit" class="send-btn">ì €ì¥ â–¶</button>
			    </div>
			
			  </form>
			  <!-- ì§„ë£Œê¸°ë¡ ì €ì¥ í¼ ë -->
			</section>
		<!-- 5) í™˜ì ê¸°ë¡ ë©”ëª¨ -->
		<aside class="col patient-record">
			<h3 class="record-title">ğŸ“ ì¶”ê°€ë©”ëª¨</h3>
			<form class="record-form">
				<textarea placeholder="ê¸°ë¡í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
				<button type="submit">ì˜¬ë¦¬ê¸°</button>
			</form>
		</aside>
		
	</div>
</body>
<script>
  function goToHome()        { location.href = '/home'; }
  function goToChart()       { location.href = '/hospital/chart'; }
  function goToReservation() { location.href = '/hospital/reservation'; }
  function goToTreatment()   { location.href = '/hospital/treatment'; }
  function goToStats()       { location.href = '/hospital/statistics'; }
  function goLogout()        { location.href = '/logout'; }

  const orderInput = document.getElementById('orderSearchInput');
  const suggestions = document.getElementById('suggestions');
  const diagnosisList = document.querySelector('.diagnosis-items');
  const tbody = document.getElementById('prescriptionTbody');

  let orderData = [];

  async function loadOrderData() {
  try {
    const diseaseRes = await fetch('/api/disease/list');
    const diseaseData = await diseaseRes.json();
    console.log("âœ… diseaseData:", diseaseData); // ğŸ” í™•ì¸

    const drugRes = await fetch('/api/drug/list');
    const drugData = await drugRes.json();
    console.log("âœ… drugData:", drugData); // ğŸ” í™•ì¸

    orderData = [
      ...diseaseData.map(d => ({
        type: 'disease',
        code: d.code,
        name: d.name,
        category: d.type
      })),
      ...drugData
    ];

    console.log("âœ… orderData ìµœì¢…:", orderData); // âœ… ì—¬ê¸° ì°íˆëŠ”ì§€ í™•ì¸
  } catch (err) {
    console.error('âŒ loadOrderData ì‹¤íŒ¨:', err); // ì˜¤ë¥˜ê°€ ì—¬ê¸° ì°íˆëŠ”ì§€!
  }
}

  // âœ… 2. ë°˜ë“œì‹œ ì‹¤í–‰
  (async () => {
    await loadOrderData();
  })();

  // âœ… 3. ìë™ì™„ì„± ì´ë²¤íŠ¸ ì²˜ë¦¬
  orderInput.addEventListener('input', () => {
    const query = orderInput.value.trim().toLowerCase();
    suggestions.innerHTML = '';

    if (!orderData || orderData.length === 0) {
      const div = document.createElement('div');
      div.innerHTML = 'â³ ë°ì´í„° ë¡œë”© ì¤‘...';
      div.classList.add('suggestion-item');
      suggestions.appendChild(div);
      return;
    }

    const diseases = orderData.filter(item =>
      item.type === 'disease' && item.name.toLowerCase().includes(query)
    );
    const drugs = orderData.filter(item =>
      item.type === 'drug' && item.name.toLowerCase().includes(query)
    );

    // ì§„ë‹¨ëª… ê·¸ë£¹
    if (diseases.length > 0) {
      const diseaseLabel = document.createElement('div');
      diseaseLabel.textContent = 'ğŸ“ ì§„ë‹¨ëª…';
      diseaseLabel.classList.add('group-label');
      suggestions.appendChild(diseaseLabel);

      diseases.forEach(item => {
        const div = document.createElement('div');
        div.classList.add('suggestion-item');
        div.textContent = item.name;
        div.onclick = () => {
          const li = document.createElement('div');
          li.classList.add('diagnosis-item');
          li.innerHTML = `
            <span>${item.name}</span>
            <button class="delete-diagnosis-btn">âŒ</button>
          `;
          li.querySelector('.delete-diagnosis-btn').onclick = () => li.remove();
          diagnosisList.appendChild(li);
          orderInput.value = '';
          suggestions.innerHTML = '';
        };
        suggestions.appendChild(div);
      });
    }

    // ì•½ë¬¼ ê·¸ë£¹
    if (drugs.length > 0) {
      const drugLabel = document.createElement('div');
      drugLabel.textContent = 'ğŸ’Š ì•½ë¬¼';
      drugLabel.classList.add('group-label');
      suggestions.appendChild(drugLabel);

      drugs.forEach(item => {
        const div = document.createElement('div');
        div.classList.add('suggestion-item');
        div.textContent = item.name;
        div.onclick = () => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.name}</td>
            <td contenteditable="true">${item.dosage}</td>
            <td contenteditable="true">${item.count}</td>
            <td><button class="delete-btn">ì‚­ì œ</button></td>
          `;
          tbody.appendChild(tr);
          orderInput.value = '';
          suggestions.innerHTML = '';
        };
        suggestions.appendChild(div);
      });
    }
  });

  // ì™¸ë¶€ í´ë¦­ ì‹œ ìë™ì™„ì„± ë‹«ê¸°
  document.addEventListener('click', e => {
    if (!suggestions.contains(e.target) && e.target !== orderInput) {
      suggestions.innerHTML = '';
    }
  });

  // ìˆ˜ê¸° ì²˜ë°© ì¶”ê°€
  document.getElementById('manualAddBtn').addEventListener('click', () => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" placeholder="ì•½í’ˆëª…" class="manual-input"></td>
      <td><input type="text" placeholder="ìš©ë²•/ìš©ëŸ‰" class="manual-input"></td>
      <td><input type="number" placeholder="ìˆ˜ëŸ‰" class="manual-input" style="width: 60px;"></td>
      <td><button class="delete-btn">ì‚­ì œ</button></td>
    `;
    tbody.appendChild(tr);
  });

  // ì²˜ë°© í…Œì´ë¸” ì‚­ì œ ê¸°ëŠ¥
  tbody.addEventListener('click', e => {
    if (e.target.classList.contains('delete-btn')) {
      const tr = e.target.closest('tr');
      if (tr) tr.remove();
    }
  });
</script>
</script>
</html>